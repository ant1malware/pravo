import{b as Z,j as n}from"./index-B74oq9Yw.js";import{u as ee,R as a,L as w}from"./react-vendor-DTkXckhQ.js";import{d as te,p as se}from"./purify.es-DnfDK_hS.js";import{getTopic as ne,listPosts as D,listTopics as ie,listSections as re,createPost as ae,updatePost as B,toggleLikePost as le,deletePost as ce}from"./forumRemote-D5s3MT8n.js";import{M as _}from"./MarkdownEditor-OwYTf-uS.js";import{R as oe}from"./ReactionBar-BJwvE7pf.js";import{s as F,a as H}from"./seo-Dt7ixYh-.js";import{F as de}from"./FavStar-DkA0xmkq.js";import{a2 as ue,Q as fe,a5 as me,a6 as xe,X as he}from"./icons-6J_ozvLF.js";const ge=90;function pe(d){try{const u=te.parse(d||"");return se.sanitize(u)}catch{return d}}function U(d){return d.toLowerCase().replace(/[^\p{L}\p{N}\s-]/gu,"").trim().replace(/\s+/g,"-").slice(0,80)}function ye(d){return d==="developer"||d==="admin"||d==="moderator"}function Ee(){const{id:d=""}=ee(),[u,T]=a.useState(null),[s,y]=a.useState(null),[h,x]=a.useState([]),[I,j]=a.useState([]),[v,b]=a.useState(""),[P,N]=a.useState(""),[S,k]=a.useState(null),[V,C]=a.useState(""),[A,q]=a.useState([]),[K,$]=a.useState(!0),[M,z]=a.useState(null),L=a.useMemo(()=>ye(u==null?void 0:u.role),[u==null?void 0:u.role]),E=a.useRef(null);a.useEffect(()=>{let t=!0;return(async()=>{try{const e=await Z();t&&T(e)}catch{t&&T(null)}})(),()=>{t=!1}},[]),a.useEffect(()=>{let t=!0;return $(!0),y(null),x([]),j([]),(async()=>{try{const[e,i,r]=await Promise.all([ne(d),D(d),ie().catch(()=>[])]);if(!t)return;if(y(e),x(Array.isArray(i)?i:[]),j(Array.isArray(r)?r:[]),e)try{F(`${e.title} вЂ” РўРµРјР°`,e.title);const l={"@context":"https://schema.org","@type":"DiscussionForumPosting",headline:e.title,datePublished:e.createdAt,dateModified:e.updatedAt};F(void 0,e.title,l)}catch{}}catch{if(!t)return;y(null),x([]),j([])}finally{t&&$(!1)}})(),()=>{t=!1}},[d]),a.useEffect(()=>{let t=!0;return(async()=>{if(!(s!=null&&s.sectionId)){t&&b("");return}try{const e=await re();if(!t)return;const i=e.find(r=>r.id===s.sectionId);b((i==null?void 0:i.title)||"")}catch{t&&b("")}})(),()=>{t=!1}},[s==null?void 0:s.sectionId]),a.useEffect(()=>{if(s!=null&&s.id)try{const t=`${window.location.origin}/forum/topic/${s.id}`;H({title:s.title,description:s.title,url:t,canonical:t})}catch{}},[s==null?void 0:s.id,s==null?void 0:s.title]),a.useEffect(()=>{if(!(!(s!=null&&s.title)||!(s!=null&&s.id)))try{const t=document.createElement("canvas");t.width=1200,t.height=630;const e=t.getContext("2d");if(!e)return;const i=e.createLinearGradient(0,0,1200,630);i.addColorStop(0,"#8b5cf6"),i.addColorStop(1,"#22d3ee"),e.fillStyle=i,e.fillRect(0,0,1200,630),e.fillStyle="rgba(0,0,0,0.35)",e.fillRect(24,24,1152,582),e.fillStyle="#fff",e.font="bold 56px Inter, system-ui, sans-serif",e.textBaseline="top";const r=s.title.slice(0,ge).split(" "),l=[];let c="";for(const f of r){const g=c?`${c} ${f}`:f;e.measureText(g).width>1080?(c&&l.push(c),c=f):c=g}c&&l.push(c);let m=120;for(const f of l)e.fillText(f,60,m),m+=70;e.font="bold 24px Inter, system-ui, sans-serif",e.fillStyle="rgba(255,255,255,0.85)",e.fillText(v||"SKY",60,60);const p=t.toDataURL("image/png"),o=`${window.location.origin}/forum/topic/${s.id}`;H({title:s.title,description:s.title,url:o,image:p,canonical:o})}catch{}},[v,s==null?void 0:s.id,s==null?void 0:s.title]),a.useEffect(()=>{var l;const e=(((l=h[0])==null?void 0:l.content)||"").split(/\r?\n/),i=[],r=new Map;for(const c of e){const m=/^(#{2,3})\s+(.+)$/.exec(c.trim());if(!m)continue;const p=m[1].length,o=U(m[2]),f=r.get(o)??0,g=f?`${o}-${f+1}`:o;r.set(o,f+1),i.push({id:g,text:m[2],level:p})}q(i)},[h]),a.useEffect(()=>{const t=`topic:scroll:${d}`;try{const i=Number(localStorage.getItem(t)||"");Number.isFinite(i)&&i>0&&window.scrollTo(0,i)}catch{}const e=()=>{try{localStorage.setItem(t,String(window.scrollY??0))}catch{}};return window.addEventListener("beforeunload",e),()=>window.removeEventListener("beforeunload",e)},[d]),a.useEffect(()=>{function t(e){if(e.key.toLowerCase()==="r"){const i=document.querySelector("#reply-editor textarea");i&&(e.preventDefault(),i.focus())}}return window.addEventListener("keydown",t),()=>window.removeEventListener("keydown",t)},[]),a.useEffect(()=>{const t=E.current;if(!t)return;const e=Array.from(t.querySelectorAll("h2, h3")),i=new Map;e.forEach(r=>{const l=U(r.textContent||"");if(!l)return;const c=i.get(l)??0,m=c?`${l}-${c+1}`:l;i.set(l,c+1),r.id=m})},[h,S]),a.useEffect(()=>{const t=E.current;if(!t)return;const e=Array.from(t.querySelectorAll("img")),i=r=>{r.preventDefault();const l=r.currentTarget;l!=null&&l.src&&z(l.src)};return e.forEach(r=>r.addEventListener("click",i)),()=>e.forEach(r=>r.removeEventListener("click",i))},[h,S]);const Q=a.useMemo(()=>h.slice().sort((t,e)=>(e.pinned?1:0)-(t.pinned?1:0)||new Date(t.createdAt).getTime()-new Date(e.createdAt).getTime()),[h]),R=a.useMemo(()=>{if(!s)return[];const t=new Set(String(s.title||"").toLowerCase().split(/[^\p{L}\p{N}]+/u).filter(Boolean));return t.size?I.filter(e=>e.id!==s.id&&e.sectionId===s.sectionId).map(e=>{const i=new Set(String(e.title||"").toLowerCase().split(/[^\p{L}\p{N}]+/u).filter(Boolean));if(!i.size)return{candidate:e,score:0};let r=0;for(const c of i)t.has(c)&&(r+=1);const l=t.size+i.size-r;return{candidate:e,score:l?r/l:0}}).filter(e=>e.score>0).sort((e,i)=>i.score-e.score).slice(0,5).map(e=>e.candidate):[]},[I,s==null?void 0:s.id,s==null?void 0:s.sectionId,s==null?void 0:s.title]),G=a.useMemo(()=>Math.max(h.length,(s==null?void 0:s.replyCount)??0),[h.length,s==null?void 0:s.replyCount]);async function O(){const t=P.trim();if(!(!t||!u||!s||s.locked))try{const e=await ae({topicId:s.id,content:t});x(i=>[...i,e]),N(""),y(i=>i&&{...i,replyCount:i.replyCount+1,lastPostAt:e.createdAt,lastPostBy:e.authorId})}catch(e){alert((e==null?void 0:e.message)||"РќРµ СѓРґР°Р»РѕСЃСЊ РѕС‚РїСЂР°РІРёС‚СЊ РѕС‚РІРµС‚")}}async function X(t){if(L)try{const e=await B(t.id,{pinned:!t.pinned});x(i=>i.map(r=>r.id===t.id?e:r))}catch(e){alert((e==null?void 0:e.message)||"РќРµ СѓРґР°Р»РѕСЃСЊ РѕР±РЅРѕРІРёС‚СЊ СЃС‚Р°С‚СѓСЃ СЃРѕРѕР±С‰РµРЅРёСЏ")}}async function Y(t){try{await ce(t.id),x(e=>e.filter(i=>i.id!==t.id)),y(e=>e&&{...e,replyCount:Math.max(0,e.replyCount-1)})}catch(e){alert((e==null?void 0:e.message)||"РќРµ СѓРґР°Р»РѕСЃСЊ СѓРґР°Р»РёС‚СЊ СЃРѕРѕР±С‰РµРЅРёРµ")}}async function J(t){try{const e=await le(t.id);x(i=>i.map(r=>r.id===t.id?e:r))}catch(e){alert((e==null?void 0:e.message)||"РќРµ СѓРґР°Р»РѕСЃСЊ РѕР±РЅРѕРІРёС‚СЊ СЂРµР°РєС†РёСЋ")}}const W=(t,e)=>{var m,p;const i=!!u&&u.id===t.authorId,r=S===t.id,l=pe(t.content),c=e===0?E:void 0;return n.jsxs("div",{ref:c,className:"rounded-xl border border-white/10 bg-white/[0.04] p-3 text-sm",children:[t.pinned&&n.jsx("span",{className:"mr-2 inline-block rounded bg-white/10 px-2 py-0.5 text-xs uppercase tracking-wide",children:"Pinned"}),r?n.jsx(_,{value:V,onChange:C,onSubmit:async o=>{C(o),x(f=>f.map(g=>g.id===t.id?{...g,content:o,editedAt:new Date().toISOString()}:g)),k(null);try{await B(t.id,{content:o})}catch(f){alert((f==null?void 0:f.message)||"РќРµ СѓРґР°Р»РѕСЃСЊ СЃРѕС…СЂР°РЅРёС‚СЊ РїСЂР°РІРєСѓ")}},submitLabel:"Save"}):n.jsx("div",{className:"prose prose-invert max-w-none",dangerouslySetInnerHTML:{__html:l}}),n.jsxs("div",{className:"mt-2 flex flex-wrap items-center gap-2",children:[n.jsxs("button",{className:"btn text-xs",title:"Р¦РёС‚РёСЂРѕРІР°С‚СЊ",onClick:()=>N(o=>`${o}

> ${t.content}

`),children:[n.jsx(fe,{size:14})," Quote"]}),n.jsxs("button",{className:"btn text-xs",onClick:()=>J(t),children:[n.jsx(me,{size:14,className:(m=t.likes)!=null&&m.length?"text-rose-300":void 0})," ",((p=t.likes)==null?void 0:p.length)??0]}),i&&!r&&n.jsxs("button",{className:"btn text-xs",onClick:()=>{k(t.id),C(t.content)},title:"Р РµРґР°РєС‚РёСЂРѕРІР°С‚СЊ СЃРѕРѕР±С‰РµРЅРёРµ",children:[n.jsx(xe,{size:14})," Edit"]}),r&&n.jsxs("button",{className:"btn text-xs",onClick:()=>k(null),children:[n.jsx(he,{size:14})," Cancel"]})]}),n.jsx(oe,{postId:t.id,currentUserId:u==null?void 0:u.id,onPostUpdated:async()=>{try{const o=await D(d);x(Array.isArray(o)?o:[])}catch{}}}),(L||i)&&n.jsxs("div",{className:"mt-2 flex flex-wrap items-center justify-end gap-2",children:[L&&n.jsx("button",{className:"btn text-xs",onClick:()=>X(t),children:t.pinned?"Unpin":"Pin"}),n.jsx("button",{className:"btn text-xs",onClick:()=>Y(t),children:"Delete"})]})]},t.id)};return!K&&!s?n.jsx("main",{className:"min-h-screen",style:{background:"#0d0d12",color:"#f8fafc"},children:n.jsx("div",{className:"mx-auto max-w-4xl px-4 py-24 text-center text-sm text-zinc-300",children:"РўРµРјР° РЅРµ РЅР°Р№РґРµРЅР° РёР»Рё Р±С‹Р»Р° СѓРґР°Р»РµРЅР°."})}):n.jsxs("main",{className:"min-h-screen",style:{background:"#0d0d12",color:"#f8fafc"},children:[n.jsxs("div",{className:"mx-auto max-w-5xl px-4 py-6",children:[n.jsxs("nav",{className:"mb-2 flex flex-wrap items-center gap-2 text-sm text-zinc-300/80",children:[n.jsx(w,{to:"/forum",className:"hover:underline",children:"Р¤РѕСЂСѓРј"}),n.jsx("span",{children:"/"}),s!=null&&s.sectionId?n.jsx(w,{to:`/forum/section/${s.sectionId}`,className:"hover:underline",children:v||"Р Р°Р·РґРµР»"}):n.jsx("span",{children:"Р Р°Р·РґРµР»"}),n.jsx("span",{children:"/"}),n.jsx("span",{className:"font-semibold text-zinc-100",children:(s==null?void 0:s.title)||"..."})]}),n.jsxs("div",{className:"mb-4 flex flex-wrap items-center gap-3",children:[n.jsxs(w,{to:"/forum",className:"btn flex items-center gap-2",children:[n.jsx(ue,{size:16})," Back"]}),n.jsx("div",{className:"text-sm opacity-70",children:"Topic"}),n.jsx("div",{className:"min-w-0 flex-1 truncate font-semibold",children:(s==null?void 0:s.title)||"..."}),s&&n.jsxs("div",{className:"flex items-center gap-3 text-xs opacity-70",children:[n.jsxs("span",{children:["Replies ",G]}),n.jsxs("span",{children:["Views ",s.viewCount??0]}),n.jsx(de,{kind:"topic",id:s.id,title:s.title,url:`/forum/topic/${s.id}`,size:"sm"})]})]}),n.jsx("div",{className:"card p-4",children:n.jsxs("div",{className:"grid gap-3",children:[Q.map((t,e)=>W(t,e)),!(s!=null&&s.locked)&&u&&n.jsx("div",{id:"reply-editor",children:n.jsx(_,{value:P,onChange:N,onSubmit:()=>O(),placeholder:"Reply in Markdown...",submitLabel:"Send",draftKey:s?`forum:draft:${s.id}`:void 0})}),(s==null?void 0:s.locked)&&n.jsx("div",{className:"text-xs opacity-70",children:"Topic is locked."})]})}),A.length>0&&n.jsxs("div",{className:"card mt-4 p-4",children:[n.jsx("div",{className:"mb-2 text-xs uppercase tracking-[0.28em] text-zinc-400/80",children:"РћРіР»Р°РІР»РµРЅРёРµ"}),n.jsx("ul",{className:"text-sm leading-relaxed",children:A.map(t=>n.jsx("li",{className:t.level===3?"ml-3":void 0,children:n.jsx("a",{href:`#${t.id}`,className:"hover:underline",children:t.text})},t.id))})]}),R.length>0&&n.jsxs("div",{className:"card mt-4 Рї-4",children:[n.jsx("div",{className:"mb-2 text-xs uppercase tracking-[0.28em] text-Р·inc-400/80",children:"РџРѕС…РѕР¶РёРµ С‚РµРјС‹"}),n.jsx("div",{className:"grid gap-2",children:R.map(t=>n.jsxs(w,{to:`/forum/topic/${t.id}`,className:"flex items-center justify-between rounded-lg border border-white/10 bg-white/[0.03] px-3 py-2 hover:bg-white/[0.06]",children:[n.jsx("div",{className:"min-w-0 truncate font-medium",children:t.title}),n.jsxs("div",{className:"ml-2 shrink-0 text-xs opacity-70",children:["РћС‚РІРµС‚РѕРІ ",t.replyCount]})]},t.id))})]})]}),M&&n.jsx("div",{className:"fixed inset-0 z-[100] grid place-items-center bg-black/80 p-4",onClick:()=>z(null),role:"presentation",children:n.jsx("img",{src:M,alt:"preview",className:"max-h-[90vh] max-w-[90vw] rounded-lg shadow-lg"})})]})}export{Ee as default};
