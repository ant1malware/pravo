import{b as Ce,k as et,c as Ae,j as e,m as tt,n as st,o as nt}from"./index-BT0Wx6_3.js";import{u as at,R as o}from"./react-vendor-DTkXckhQ.js";import{f as $e,g as ze,u as rt,a as it}from"./forumStore-BdoM8WSr.js";import{G as lt,H as ot,J as Re,N as ct,O as dt,V as mt,W as Ee,S as Pe,Y as _e,Z as ut,_ as Fe,$ as Me,M as xt,a0 as ht}from"./icons-vKdVo13Z.js";const q="forum:",de=`${q}follows`,Le=`${q}profile_comments:`,ft=`${q}social-change`,te=new Map,pt={getItem:t=>te.has(t)?te.get(t):null,setItem:(t,s)=>void te.set(t,s),removeItem:t=>void te.delete(t)},_=(()=>{try{if(typeof window<"u"&&window.localStorage)return window.localStorage}catch{}return pt})(),Ue=typeof window<"u";function ne(){return new Date().toISOString()}function me(t,s){try{return t?JSON.parse(t):s}catch{return s}}function Be(){try{const t=typeof crypto<"u"&&crypto.randomUUID?crypto.randomUUID():null;if(t)return t}catch{}return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,t=>{const s=Math.random()*16|0;return(t==="x"?s:s&3|8).toString(16)})}function O(t){if(Ue)try{window.dispatchEvent(new CustomEvent(ft,{detail:t}))}catch{}}Ue&&window.addEventListener("storage",t=>{t.key&&(t.key.startsWith(Le)||t.key===de)&&O({key:t.key,type:"storage"})});function ae(){return me(_.getItem(de),[])}function We(t){const s=new Set,n=[];for(const a of t){const r=`${a.followerId}=>${a.targetId}`;a.followerId!==a.targetId&&(s.has(r)||(s.add(r),n.push(a)))}try{_.setItem(de,JSON.stringify(n))}catch{}O({scope:"follows"})}function gt(){try{const s=new URL(window.location.href),n=s.searchParams.get("api");if(n){localStorage.setItem("forum:api_base",n);try{s.searchParams.delete("api"),history.replaceState({},"",s.toString())}catch{}}const a=localStorage.getItem("forum:api_base");if(a)return a}catch{}return"https://notifications-worker.wizardiowhy.workers.dev/skyapi"}const He=gt();function Je(){try{return localStorage.getItem("forum:token")??sessionStorage.getItem("forum:token")}catch{return null}}async function T(t,s={}){const n=Je(),a={"Content-Type":"application/json",...s.headers||{}};n&&(a.Authorization=`Bearer ${n}`);const r=await fetch(`${He}${t}`,{...s,headers:a}),i=await r.text();let l={};try{l=i?JSON.parse(i):{}}catch{l={error:i||r.statusText}}if(!r.ok)throw new Error((l==null?void 0:l.error)||`${r.status} ${r.statusText}`);return l}function M(){return!!He&&!!Je()}function Oe(t){if(M())try{const s=window.__socialRemoteFollowersCache||(window.__socialRemoteFollowersCache=new Map),n=s.get(t);if(n)return n;T(`/social/followers/${encodeURIComponent(t)}`).then(a=>{try{s.set(t,Array.isArray(a.followers)?a.followers:[]),O({scope:"follows",targetId:t})}catch{}})}catch{}return ae().filter(s=>s.targetId===t).map(s=>s.followerId)}function bt(t,s){if(!t)return!1;if(M())try{const n=window.__socialRemoteFollowingCache||(window.__socialRemoteFollowingCache=new Map),a=n.get(t);if(a)return a.includes(s);T(`/social/following/${encodeURIComponent(t)}`).then(r=>{try{n.set(t,Array.isArray(r.following)?r.following:[]),O({scope:"follows",followerId:t})}catch{}})}catch{}return ae().some(n=>n.followerId===t&&n.targetId===s)}function vt(t,s){if(!t||!s||t===s)return;if(M())try{T("/social/follow",{method:"POST",body:JSON.stringify({targetId:s})})}catch{}const n=ae();n.some(a=>a.followerId===t&&a.targetId===s)||(n.push({followerId:t,targetId:s,createdAt:ne()}),We(n))}function wt(t,s){if(M())try{T("/social/unfollow",{method:"POST",body:JSON.stringify({targetId:s})})}catch{}const n=ae().filter(a=>!(a.followerId===t&&a.targetId===s));We(n)}function Ye(t){return`${Le}${t}`}function le(t){return t.map(s=>({id:s.id??Be(),targetId:s.targetId,authorId:s.authorId,authorName:s.authorName,content:typeof s.content=="string"?s.content:"",createdAt:s.createdAt??ne(),parentId:s.parentId??null,updatedAt:s.updatedAt??null,edited:!!s.edited,deleted:!!s.deleted,deletedAt:s.deletedAt??null,deletedById:s.deletedById??null}))}function se(t){if(M())try{const a=window.__socialRemoteCommentsCache||(window.__socialRemoteCommentsCache=new Map),r=a.get(t);if(r)return r;T(`/profiles/${encodeURIComponent(t)}/comments`).then(i=>{try{const l=le(Array.isArray(i.comments)?i.comments:[]);a.set(t,l),O({scope:"comments",targetId:t})}catch{}})}catch{}const s=_.getItem(Ye(t)),n=me(s,[]);return le(n)}function Xe(t,s){try{_.setItem(Ye(t),JSON.stringify(s))}catch{}O({scope:"comments",targetId:t})}const jt=1e4;function yt(t,s){const n=`${q}last_post:${t}:${s}`,a=Number(_.getItem(n)||"0"),r=Date.now()-a>=jt;if(r)try{_.setItem(n,String(Date.now()))}catch{}return r}const De=2e3;function K(t,s){const n=se(t),r=!1?n:n.filter(m=>!m.deleted);r.sort((m,c)=>m.createdAt<c.createdAt?1:-1);const i=Math.max(0,0);return r.slice(i,void 0)}function Ve(t,s,n,a){const r=(n??"").trim();if(!r)throw new Error("Comment is empty");if(r.length>De)throw new Error(`Comment too long (${r.length} > ${De})`);if(!M()&&!yt(t,s))throw new Error("You are posting too fast. Please wait a bit.");if(M())try{T(`/profiles/${encodeURIComponent(t)}/comments`,{method:"POST",body:JSON.stringify({content:r,parentId:(a==null?void 0:a.parentId)||null})}).then(m=>{try{const c=window.__socialRemoteCommentsCache;if(c){const p=c.get(t)||[],y=le(Array.isArray(m.comment)?m.comment:[m.comment]);c.set(t,[...y,...p]),O({scope:"comments",targetId:t})}}catch{}}).catch(()=>{})}catch{}if(a!=null&&a.parentId&&!se(t).find(c=>c.id===a.parentId))throw new Error("Parent comment not found");const i={id:Be(),targetId:t,authorId:s,authorName:a==null?void 0:a.authorName,content:r,createdAt:ne(),parentId:(a==null?void 0:a.parentId)??null,updatedAt:null,edited:!1,deleted:!1,deletedAt:null,deletedById:null},l=se(t);return l.unshift(i),Xe(t,l),i}function Nt(t,s,n,a,r){return Ve(t,s,a,{authorName:r,parentId:n})}function kt(t,s,n){if(M())try{T(`/profiles/${encodeURIComponent(t)}/comments/${encodeURIComponent(s)}`,{method:"DELETE"})}catch{}const a=se(t),r=a.findIndex(l=>l.id===s);if(r<0)return;const i=a[r];(i.authorId===n||t===n)&&(i.deleted||(a[r]={...i,content:"",deleted:!0,deletedAt:ne(),deletedById:n},Xe(t,a)))}function Ge(t){return`${q}comment_reactions:${t}`}function ue(t){return me(_.getItem(Ge(t)),{})}function St(t,s){try{_.setItem(Ge(t),JSON.stringify(s))}catch{}O({scope:"reactions",targetId:t})}function Ct(t){return ue(t)}function At(t,s,n){var a,r;return(r=(a=ue(t)[s])==null?void 0:a.byUser)==null?void 0:r[n]}function $t(t,s,n,a){const r=ue(t),i=r[s]||{counts:{like:0,smile:0,useful:0},byUser:{}},l=i.byUser[n];return l===a?(i.byUser[n]=void 0,i.counts[a]=Math.max(0,(i.counts[a]||0)-1)):(l&&(i.counts[l]=Math.max(0,(i.counts[l]||0)-1)),i.byUser[n]=a,i.counts[a]=(i.counts[a]||0)+1),r[s]=i,St(t,r),i}const oe={developer:{label:"Разработчик",color:"#22d3ee",glow:"from-cyan-400/35"},admin:{label:"Администратор",color:"#e5e7eb",glow:"from-white/40"},moderator:{label:"Модератор",color:"#ef4444",glow:"from-rose-400/35"},vip:{label:"VIP",color:"#eab308",glow:"from-amber-400/35"},user:{label:"Участник",color:"#94a3b8",glow:"from-slate-300/30"},newbie:{label:"Новичок",color:"#22d3ee",glow:"from-cyan-400/35"}},Ie={owner:{label:"Owner",grad:"from-amber-400 via-rose-400 to-amber-400",Icon:_e},developer:{label:"Developer",grad:"from-emerald-400 via-lime-400 to-emerald-400",Icon:Ee},admin:{label:"Admin",grad:"from-white via-slate-200 to-white",Icon:Pe},moderator:{label:"Moderator",grad:"from-rose-400 via-red-400 to-rose-400",Icon:ut},vip:{label:"Premium",grad:"from-amber-400 via-yellow-300 to-amber-400",Icon:_e},user:{label:"User",grad:"from-slate-300 via-slate-400 to-slate-300",Icon:Pe},newbie:{label:"Newbie",grad:"from-cyan-400 via-fuchsia-400 to-cyan-400",Icon:Ee}};function ce(t){switch(t){case"developer":return"linear-gradient(90deg,#22c55e,#84cc16)";case"admin":return"linear-gradient(90deg,#ffffff,#d1d5db)";case"moderator":return"linear-gradient(90deg,#ef4444,#f43f5e)";case"vip":return"linear-gradient(90deg,#eab308,#facc15)";case"user":return"linear-gradient(90deg,#a855f7,#8b5cf6)";case"newbie":return"linear-gradient(90deg,#4c1d95,#6d28d9)";default:return null}}function zt(t){if(!t)return!1;if(!t.until)return!0;const s=new Date(t.until).getTime();return!Number.isNaN(s)&&s>Date.now()}function Rt(t){const s=t.lastActiveAt||nt(t.id);if(!s)return!1;const n=new Date(s).getTime();return!Number.isNaN(n)&&n>Date.now()-5*60*1e3}const P="rounded-3xl border border-white/10 bg-[#101321]/85 p-5 shadow-[0_40px_120px_-70px_rgba(15,23,42,0.9)] backdrop-blur",j="rounded-3xl border border-white/10 bg-white/[0.05] p-4 shadow-[0_30px_90px_-70px_rgba(15,23,42,0.85)] backdrop-blur";function Et({role:t}){const s=Ie[t]??Ie.user,n=s.Icon;return e.jsxs("span",{className:"relative inline-flex",children:[e.jsx("span",{className:`absolute -inset-[2px] rounded-full blur-md bg-gradient-to-r ${s.grad} opacity-50`}),e.jsxs("span",{className:"relative inline-flex items-center gap-2 rounded-full border border-white/10 bg-white/5 px-3.5 py-1.5 text-[11px] font-extrabold uppercase tracking-[0.22em] text-white",children:[e.jsx(n,{size:14,className:"opacity-90"}),s.label]})]})}function Pt({role:t}){var n;const s=ce(t);return e.jsx("span",{title:((n=oe[t])==null?void 0:n.label)||t,className:"inline-block h-3.5 w-3.5 rounded-full border border-white/20 align-middle",style:s?{backgroundImage:s}:{backgroundColor:"#94a3b8"}})}function re({value:t,label:s}){return e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"text-2xl font-extrabold text-white",children:t}),e.jsx("div",{className:"mt-0.5 text-[11px] uppercase tracking-[0.28em] text-zinc-300/80",children:s})]})}function _t({badges:t}){if(!(t!=null&&t.length))return null;const s={Founder:"from-rose-500/25 to-rose-400/10 text-rose-200",Early:"from-sky-500/25 to-sky-400/10 text-sky-200",Contributor:"from-emerald-500/25 to-emerald-400/10 text-emerald-200",VIP:"from-amber-500/25 to-amber-400/10 text-amber-200",Designer:"from-violet-500/25 to-violet-400/10 text-violet-200"};return e.jsx("div",{className:"flex flex-wrap items-center gap-2",children:t.slice(0,3).map(n=>e.jsxs("span",{className:`inline-flex items-center gap-1 rounded-full border border-white/10 bg-gradient-to-br ${s[n]||"from-white/20 to-white/5 text-zinc-200"} px-2.5 py-1 text-xs`,children:[e.jsx(Fe,{size:14,className:"opacity-90"})," ",n]},n))})}function Te(t){const s=t.profile||{},n=t.stats||{},a=t.lastActiveAt||t.lastSeenAt||t.lastOnlineAt||null,r={bio:s.bio||"",signature:s.signature||"",links:s.links?{...s.links}:{},accentFrom:s.accentFrom||"#8b5cf6",accentTo:s.accentTo||"#0ea5e9",avatarData:s.avatarData||s.avatar||s.avatarUrl||void 0,bannerData:s.bannerData||s.banner||s.bannerUrl||void 0,badges:Array.isArray(s.badges)?s.badges:[],privacy:{showEmail:!1,showStats:!0,showLinks:!0,allowComments:!0,showFollowers:!0,...s.privacy||{}}};Array.isArray(s.labels)&&(r.labels=s.labels);const i={id:t.user.id,username:t.user.username,email:t.user.email,createdAt:t.user.createdAt,role:t.user.role,userNumber:t.user.userNumber,posts:typeof n.posts=="number"?n.posts:0,likes:typeof n.likes=="number"?n.likes:0,topics:typeof n.topics=="number"?n.topics:0,profile:r,bans:t.user.bannedUntil?{until:t.user.bannedUntil}:null,mutes:null};return typeof n.score=="number"&&(i.score=n.score),a&&(i.lastActiveAt=a),i}function Gt(){var b,g,v,L,I,U,W,Q;const{username:t=""}=at(),[s,n]=o.useState(null),[a,r]=o.useState(null),[i,l]=o.useState(!1),[m,c]=o.useState(!1),[p,y]=o.useState({}),[h,C]=o.useState("posts"),[w,A]=o.useState(null);if(o.useEffect(()=>{(async()=>{var S;try{const N=await Ce();if(N){l(!0),r({id:N.id,username:N.username}),A(N);try{const Z=await et(),ee={};for(const J of Z)ee[J.id]=J.username;y(ee)}catch{}const H=await Ae(t);if(H){n(Te(H)),c(!!((S=H.user)!=null&&S.owner));return}}}catch{}l(!1),n($e(t)||null);const f=ze();r(f?{id:f.id,username:f.username}:null)})()},[t]),o.useEffect(()=>{const f=async()=>{try{const N=await Ce();if(N){r({id:N.id,username:N.username}),A(N);return}}catch{}const S=ze();r(S?{id:S.id,username:S.username}:null)};return window.addEventListener("forum:session",f),window.addEventListener("storage",f),()=>{window.removeEventListener("forum:session",f),window.removeEventListener("storage",f)}},[]),!s)return e.jsx("main",{className:"min-h-screen text-slate-200",style:{background:"linear-gradient(180deg,#04060d 0%,#090b16 100%)"},children:e.jsx("div",{className:"mx-auto max-w-3xl px-4 py-16",children:e.jsx("div",{className:`${P} text-center text-sm text-zinc-300`,children:"Требуется вход для просмотра профилей."})})});const $=(a==null?void 0:a.id)===s.id,F=!!((g=(b=s.profile)==null?void 0:b.privacy)!=null&&g.hiddenProfile),z=(a==null?void 0:a.id)===s.id||!!w&&(w.owner===!0||w.role==="developer"||w.role==="admin"),B=$&&(s.role==="developer"||s.role==="admin"||i&&m);if(F&&!z)return e.jsx("main",{className:"min-h-screen text-slate-200",style:{background:"linear-gradient(180deg,#04060d 0%,#090b16 100%)"},children:e.jsx("div",{className:"mx-auto max-w-3xl px-4 py-16",children:e.jsx("div",{className:`${P} text-center text-sm text-zinc-300`,children:"Профиль скрыт. Доступен только администрации."})})});const R=s.profile.accentFrom||"#22d3ee",D=s.profile.accentTo||"#8b5cf6",u=zt(s.bans),x=Rt(s);return e.jsx("main",{className:"min-h-screen text-slate-100",style:{background:"radial-gradient(1200px 700px at 12% -10%, rgba(56,189,248,0.18), transparent 65%), radial-gradient(1000px 720px at 90% -6%, rgba(167,139,250,0.14), transparent 70%), linear-gradient(180deg, #04060d 0%, #090b16 100%)"},children:e.jsxs("div",{className:"mx-auto max-w-5xl px-4 py-8 space-y-6",children:[e.jsxs("section",{className:"relative overflow-hidden rounded-3xl border border-white/10 bg-[#101321]/85 shadow-[0_50px_140px_-80px_rgba(15,23,42,0.9)] backdrop-blur",children:[e.jsx("div",{className:"h-[220px] w-full",style:{background:s.profile.bannerData?`url(${s.profile.bannerData}) center/cover`:`linear-gradient(135deg, ${R}, ${D})`}}),e.jsxs("div",{className:"px-6 pb-6 pt-4",children:[e.jsxs("div",{className:"flex flex-wrap items-end gap-5",children:[e.jsxs("div",{className:"relative",children:[e.jsx("div",{className:"rounded-full p-[3px]",style:{backgroundImage:ce(s.role)||`linear-gradient(135deg,${R},${D})`},children:e.jsx("div",{className:"h-24 w-24 overflow-hidden rounded-full border-4 border-[#101321] shadow-[0_25px_70px_-35px_rgba(15,23,42,0.9)]",style:{background:s.profile.avatarData?`url(${s.profile.avatarData}) center/cover`:`linear-gradient(135deg, ${R}, ${D})`}})}),e.jsx("span",{className:`absolute -right-1 bottom-2 h-4 w-4 rounded-full border-2 ${x?"border-emerald-900/60 bg-emerald-400":"border-zinc-900/70 bg-zinc-400/70"}`,title:x?"Online":"Offline",children:x&&e.jsx("span",{className:"absolute inset-0 -z-10 animate-ping rounded-full bg-emerald-400/50"})}),e.jsx("div",{className:`absolute -inset-1 -z-10 rounded-full bg-gradient-to-br ${(oe[s.role]||oe.user).glow} to-transparent blur-lg`})]}),e.jsxs("div",{className:"min-w-0 flex-1 space-y-3",children:[e.jsxs("div",{className:"flex flex-wrap items-center gap-2",children:[e.jsx("h1",{className:`text-3xl font-extrabold tracking-tight ${u?"line-through text-black":"text-white"}`,style:u?void 0:(()=>{const f=ce(s.role);return f?{backgroundImage:f,WebkitBackgroundClip:"text",backgroundClip:"text",WebkitTextFillColor:"transparent"}:void 0})(),children:s.username}),e.jsx(Pt,{role:s.role}),e.jsx("span",{className:`ml-1 rounded-full px-2 py-0.5 text-[11px] uppercase tracking-[0.26em] ${x?"bg-emerald-500/15 text-emerald-200":"bg-white/10 text-zinc-300"}`,children:x?"Online":s.lastActiveAt?tt(s.lastActiveAt):"Offline"}),u&&e.jsx("span",{className:"rounded-full bg-black/50 px-2 py-0.5 text-[11px] uppercase tracking-[0.26em] text-zinc-200 ml-1",children:"Banned"})]}),e.jsxs("div",{className:"mt-1 flex items-center gap-8",children:[e.jsx(re,{value:s.posts,label:"messages"}),e.jsx(re,{value:s.likes,label:"reaction score"}),e.jsx(re,{value:s.topics,label:"topics"})]}),e.jsxs("div",{className:"mt-2 flex flex-wrap items-center gap-3 text-sm",children:[e.jsx("button",{className:"rounded-full border border-white/10 bg-white/10 px-3 py-1 hover:border-white/30",onClick:()=>alert("Points system coming soon ♥"),children:"Send points"}),e.jsxs("div",{className:"relative group",children:[e.jsxs("button",{className:"rounded-full border border-white/10 bg-white/10 px-3 py-1 hover:border-white/30 inline-flex items-center gap-2",children:["Find ",e.jsx(lt,{size:14})]}),e.jsxs("div",{className:"absolute left-0 top-full hidden w-56 rounded-xl border border-white/10 bg-[#0b0f1b]/95 p-2 text-sm text-zinc-200 shadow-2xl backdrop-blur group-hover:block",children:[e.jsx("a",{className:"block rounded-lg px-2 py-1 hover:bg-white/10",href:`/forum/search?author=${encodeURIComponent(s.username)}`,children:"Все сообщения"}),e.jsx("a",{className:"block rounded-lg px-2 py-1 hover:bg-white/10",href:`/forum/search?starter=${encodeURIComponent(s.username)}`,children:"Темы пользователя"})]})]})]})]}),$?e.jsx(Lt,{user:s,onUpdated:async()=>{if(i){const f=await Ae(t);f&&n(Te(f))}else n($e(t)||null)},saveProfile:async f=>{i?await st(f):rt(s.id,f)},allowHide:B}):e.jsx("div",{className:"flex gap-2",children:e.jsx(Mt,{session:a,user:s})})]}),e.jsx("div",{className:"mt-3 flex items-center gap-6 border-t border-white/10 pt-3 text-sm",children:[{k:"posts",label:"Profile posts"},{k:"activity",label:"Latest activity"},{k:"postings",label:"Postings"},{k:"about",label:"About"}].map(({k:f,label:S})=>e.jsx("button",{className:`pb-2 ${h===f?"border-b-2 border-cyan-400 text-white":"text-zinc-400 hover:text-zinc-200"}`,onClick:()=>C(f),children:S},f))})]})]}),h==="about"&&e.jsxs("section",{className:"grid gap-4 lg:grid-cols-[1.35fr_.85fr]",children:[e.jsxs("div",{className:P,children:[e.jsx("div",{className:"mb-2 text-xs uppercase tracking-[0.3em] text-zinc-400/75",children:"Роль"}),e.jsx(Et,{role:s.role}),e.jsx("div",{className:"mt-5 mb-3 text-xs uppercase tracking-[0.3em] text-zinc-400/75",children:"О себе"}),e.jsx("p",{className:"whitespace-pre-wrap text-sm text-zinc-200/85",children:s.profile.bio||"Пока нет описания."}),e.jsx("div",{className:"mt-3",children:e.jsx(_t,{badges:s.profile.badges})})]}),e.jsxs("div",{className:P,children:[e.jsx("div",{className:"mb-3 text-xs uppercase tracking-[0.3em] text-zinc-400/75",children:"Ссылки"}),e.jsxs("div",{className:"flex flex-wrap gap-2 text-sm text-zinc-200/90",children:[(v=s.profile.links)!=null&&v.website?e.jsxs("a",{className:"inline-flex items-center gap-2 rounded-full border border-white/10 bg-white/10 px-3 py-1 hover:border-white/30",href:s.profile.links.website,target:"_blank",rel:"noreferrer",children:[e.jsx(ot,{size:14})," Сайт"]}):null,((L=s.profile.links)==null?void 0:L.discord)&&e.jsxs("span",{className:"inline-flex items-center gap-2 rounded-full border border-white/10 bg-white/10 px-3 py-1",children:[e.jsx(Re,{size:14})," ",s.profile.links.discord]}),((I=s.profile.links)==null?void 0:I.telegram)&&e.jsxs("span",{className:"inline-flex items-center gap-2 rounded-full border border-white/10 bg-white/10 px-3 py-1",children:[e.jsx(Re,{size:14})," ",s.profile.links.telegram]}),!((U=s.profile.links)!=null&&U.website)&&!((W=s.profile.links)!=null&&W.discord)&&!((Q=s.profile.links)!=null&&Q.telegram)&&e.jsx("span",{className:"opacity-70",children:"Ссылки ещё не добавлены."})]})]})]}),h!=="about"&&e.jsxs("section",{className:"grid gap-4 sm:grid-cols-3",children:[e.jsxs("div",{className:j,children:[e.jsx("div",{className:"text-xs uppercase tracking-[0.3em] text-zinc-400/80",children:"Посты"}),e.jsx("div",{className:"mt-1 text-3xl font-extrabold text-white",children:s.posts})]}),e.jsxs("div",{className:j,children:[e.jsx("div",{className:"text-xs uppercase tracking-[0.3em] text-zinc-400/80",children:"Темы"}),e.jsx("div",{className:"mt-1 text-3xl font-extrabold text-white",children:s.topics})]}),e.jsxs("div",{className:j,children:[e.jsx("div",{className:"text-xs uppercase tracking-[0.3em] text-zinc-400/80",children:"Лайки"}),e.jsx("div",{className:"mt-1 text-3xl font-extrabold text-white",children:s.likes})]})]}),h==="posts"&&e.jsx(Ot,{user:s,session:a,memberMap:p}),h==="activity"&&e.jsx("div",{className:P,children:e.jsx("div",{className:"text-sm text-zinc-300/85",children:"Лента активности скоро будет тут (репосты, реакции, подписки)."})}),h==="postings"&&e.jsx("div",{className:P,children:e.jsx("div",{className:"text-sm text-zinc-300/85",children:"Список сообщений пользователя появится после подключения реального форума."})})]})})}function Mt({session:t,user:s}){const[n,a]=o.useState(()=>s.id?Oe(s.id):[]),r=o.useMemo(()=>bt((t==null?void 0:t.id)||null,s.id),[t==null?void 0:t.id,s.id,n.length]);return e.jsx("button",{className:`btn ${r?"":"btn-primary"}`,onClick:()=>{t!=null&&t.id&&(r?wt(t.id,s.id):vt(t.id,s.id),a(Oe(s.id)))},children:r?e.jsxs(e.Fragment,{children:[e.jsx(dt,{size:16})," Отписаться"]}):e.jsxs(e.Fragment,{children:[e.jsx(mt,{size:16})," Подписаться"]})})}function Ot({user:t,session:s,memberMap:n}){const[a,r]=o.useState(()=>K(t.id));return o.useEffect(()=>{const i=()=>r(K(t.id));return window.addEventListener("forum:social-change",i),()=>window.removeEventListener("forum:social-change",i)},[t.id]),e.jsxs("section",{className:"grid gap-3",children:[(s==null?void 0:s.id)&&e.jsx(Dt,{onPost:i=>{Ve(t.id,s.id,i,{authorName:s.username}),r(K(t.id))}}),e.jsxs("div",{className:"grid gap-2",children:[a.length===0&&e.jsx("div",{className:`${P} text-sm text-zinc-300/80`,children:"Комментариев пока нет."}),It(a).map(i=>e.jsx(Ke,{node:i,currentUserId:(s==null?void 0:s.id)||"",ownerId:t.id,memberMap:n,onReply:(l,m)=>{s!=null&&s.id&&(Nt(t.id,s.id,l,m,s.username),r(K(t.id)))},onDelete:l=>{s!=null&&s.id&&(kt(t.id,l,s.id),r(K(t.id)))}},i.comment.id))]})]})}function Dt({onPost:t}){const[s,n]=o.useState("");return e.jsxs("div",{className:j,children:[e.jsxs("div",{className:"flex items-start gap-2",children:[e.jsx(xt,{size:16,className:"mt-1 shrink-0"}),e.jsx("textarea",{className:"input min-h-[80px] flex-1",placeholder:"Напишите комментарий...",value:s,onChange:a=>n(a.target.value)})]}),e.jsx("div",{className:"mt-2 flex justify-end",children:e.jsx("button",{className:"btn btn-primary",onClick:()=>{const a=s.trim();a&&(t(a),n(""))},children:"Отправить"})})]})}function It(t){const s={};t.forEach(r=>{s[r.id]={comment:r,replies:[]}});const n=[];t.forEach(r=>{const i=r.parentId||"";i&&s[i]?s[i].replies.push(s[r.id]):n.push(s[r.id])}),n.sort((r,i)=>r.comment.createdAt<i.comment.createdAt?1:-1);const a=r=>r.replies.sort((i,l)=>i.comment.createdAt>l.comment.createdAt?1:-1).forEach(a);return n.forEach(a),n}function Ke({node:t,currentUserId:s,ownerId:n,onReply:a,onDelete:r,memberMap:i}){const[l,m]=o.useState(!1),c=it(t.comment.authorId),p=t.comment.authorName||(c==null?void 0:c.username)||(t.comment.authorId===n?"Владелец":t.comment.authorId===s?"Вы":"Участник"),y=(c==null?void 0:c.username)||t.comment.authorName;return e.jsx("div",{className:j,children:e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx("div",{className:"h-8 w-8 shrink-0 rounded-full bg-gradient-to-br from-sky-500/60 to-violet-500/60"}),e.jsxs("div",{className:"min-w-0 flex-1",children:[e.jsxs("div",{className:"flex items-center justify-between gap-3",children:[e.jsxs("div",{className:"text-xs text-zinc-300/90",children:[y?e.jsx("a",{href:`/forum/profile/${y}`,className:"font-semibold text-white hover:underline",children:p}):e.jsx("span",{className:"font-semibold text-white",children:p}),e.jsxs("span",{className:"opacity-70",children:[" · ",new Date(t.comment.createdAt).toLocaleString("ru-RU")]})]}),(s===t.comment.authorId||s===n)&&e.jsx("button",{className:"btn",title:"Удалить",onClick:()=>r(t.comment.id),children:e.jsx(ht,{size:14})})]}),e.jsx("div",{className:"mt-1 whitespace-pre-wrap text-sm text-zinc-100/90",children:t.comment.content}),e.jsx(Ft,{targetId:n,commentId:t.comment.id,currentUserId:s}),e.jsx("div",{className:"mt-2 flex items-center gap-2",children:e.jsx("button",{className:"btn",onClick:()=>m(h=>!h),children:"Ответить"})}),l&&e.jsx("div",{className:"mt-2",children:e.jsx(Tt,{onSend:h=>{a(t.comment.id,h),m(!1)}})}),!!t.replies.length&&e.jsx("div",{className:"mt-3 space-y-2 border-l border-white/10 pl-3",children:t.replies.map(h=>e.jsx(Ke,{node:h,currentUserId:s,ownerId:n,onReply:a,onDelete:r,memberMap:i},h.comment.id))})]})]})})}function Tt({onSend:t}){const[s,n]=o.useState("");return e.jsxs("div",{className:"flex items-start gap-2",children:[e.jsx("textarea",{className:"input min-h-[60px] flex-1",placeholder:"Ответ...",value:s,onChange:a=>n(a.target.value)}),e.jsx("button",{className:"btn btn-primary",onClick:()=>{const a=s.trim();a&&(t(a),n(""))},children:"Отправить"})]})}function Ft({targetId:t,commentId:s,currentUserId:n}){const[,a]=o.useReducer(m=>m+1,0),r=Ct(t)[s]||{counts:{like:0,smile:0,useful:0}},i=n?At(t,s,n):void 0,l=({r:m,label:c})=>{var p;return e.jsxs("button",{className:`btn text-xs ${i===m?"btn-primary":""}`,onClick:()=>{n&&($t(t,s,n,m),a())},children:[c," ",(p=r.counts)!=null&&p[m]?e.jsx("span",{className:"opacity-80",children:r.counts[m]}):null]})};return e.jsxs("div",{className:"mt-2 flex flex-wrap items-center gap-2",children:[e.jsx(l,{r:"like",label:"👍"}),e.jsx(l,{r:"smile",label:"😊"}),e.jsx(l,{r:"useful",label:"💡"})]})}function Lt({user:t,onUpdated:s,saveProfile:n,allowHide:a}){const[r,i]=o.useState(!1);return e.jsxs(e.Fragment,{children:[e.jsxs("button",{className:"btn",onClick:()=>i(!0),children:[e.jsx(ct,{size:16})," Настроить профиль"]}),r&&e.jsx(Ht,{user:t,onClose:()=>i(!1),onSaved:()=>{s(),i(!1)},saveProfile:n,allowHide:a})]})}const Ut=["Founder","Early","Contributor","VIP","Designer"];function ie(t,s,n){return Math.max(s,Math.min(n,t))}function Bt(t){const[s,n]=o.useState(null);return o.useEffect(()=>{if(!t){n(null);return}const a=new Image;return a.onload=()=>n(a),a.src=t,()=>{}},[t]),s}function Wt({src:t,aspect:s,round:n=!1,title:a="Обрезать изображение",onCancel:r,onDone:i}){const l=n?360:900,m=Math.round(l/s),c=Bt(t),[p,y]=o.useState(1),[h,C]=o.useState({x:0,y:0}),w=o.useRef(null);o.useEffect(()=>{if(!c)return;const x=Math.max(l/c.naturalWidth,m/c.naturalHeight)*1.05;y(x);const b=c.naturalWidth*x,g=c.naturalHeight*x;C({x:(l-b)/2,y:(m-g)/2})},[c]);const A=o.useCallback((u,x)=>{if(!c)return u;const b=c.naturalWidth*x,g=c.naturalHeight*x;return{x:ie(u.x,l-b,0),y:ie(u.y,m-g,0)}},[c,l,m]),$=u=>{const x="touches"in u?u.touches[0]:u;w.current={x:h.x,y:h.y,startX:x.clientX,startY:x.clientY}},F=u=>{if(!w.current)return;const x="touches"in u?u.touches[0]:u,b=x.clientX-w.current.startX,g=x.clientY-w.current.startY;C(v=>A({x:w.current.x+b,y:w.current.y+g},p))},z=()=>{w.current=null},B=u=>{if(!c)return;u.preventDefault();const x=Math.max(l/c.naturalWidth,m/c.naturalHeight),b=x*6,g=ie(p*(u.deltaY>0?.94:1.06),x,b);y(g),C(v=>A(v,g))},R=()=>{if(!c)return;const u=n?800:1920,x=Math.round(u/s),b=u/l,g=document.createElement("canvas");g.width=u,g.height=x;const v=g.getContext("2d");if(n){v.save(),v.beginPath();const U=Math.min(u,x)/2;v.arc(u/2,x/2,U,0,Math.PI*2),v.clip()}const L=c.naturalWidth*p*b,I=c.naturalHeight*p*b;v.drawImage(c,h.x*b,h.y*b,L,I),n&&v.restore(),i(g.toDataURL("image/png",.95))},D=()=>{if(!c)return null;const u=Math.max(l/c.naturalWidth,m/c.naturalHeight),x=u*6;return e.jsx("input",{type:"range",min:u,max:x,step:u/50,value:p,onChange:b=>{const g=Number(b.target.value);y(g),C(v=>A(v,g))},className:"w-full"})};return e.jsx("div",{className:"fixed inset-0 z-[200] flex items-center justify-center bg-black/70 px-4",children:e.jsxs("div",{className:"w-[min(96vw,1000px)] rounded-3xl border border-white/10 bg-[#0b0f1b]/95 p-5 shadow-2xl backdrop-blur",children:[e.jsx("div",{className:"mb-3 text-lg font-semibold text-white",children:a}),e.jsxs("div",{className:"grid gap-4 lg:grid-cols-[auto_1fr]",children:[e.jsxs("div",{className:"relative overflow-hidden rounded-2xl border border-white/10 bg-black/40 select-none touch-none",style:{width:l,height:m,cursor:"grab"},onMouseDown:$,onMouseMove:F,onMouseUp:z,onMouseLeave:z,onTouchStart:$,onTouchMove:F,onTouchEnd:z,onWheel:B,children:[c&&e.jsx("img",{src:t,alt:"crop",draggable:!1,style:{position:"absolute",left:0,top:0,transform:`translate(${h.x}px, ${h.y}px) scale(${p})`,transformOrigin:"top left",userSelect:"none",pointerEvents:"none"}}),n&&e.jsx("div",{className:"pointer-events-none absolute inset-0 flex items-center justify-center",children:e.jsx("div",{className:"h-[90%] aspect-square rounded-full ring-2 ring-white/40"})})]}),e.jsxs("div",{className:"flex flex-col gap-3",children:[e.jsx("div",{className:"text-xs uppercase tracking-[0.28em] text-zinc-400/80",children:"Зум / перетаскивание"}),D(),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("button",{className:"btn",onClick:r,children:"Отмена"}),e.jsx("div",{className:"grow"}),e.jsx("button",{className:"btn btn-primary",onClick:R,children:"Готово"})]})]})]})]})})}function Ht({user:t,onClose:s,onSaved:n,saveProfile:a,allowHide:r}){var fe,pe,ge,be,ve,we,je,ye,Ne,ke;const[i,l]=o.useState(t.profile.avatarData||""),[m,c]=o.useState(t.profile.bannerData||""),[p,y]=o.useState(t.profile.accentFrom||"#22d3ee"),[h,C]=o.useState(t.profile.accentTo||"#8b5cf6"),[w,A]=o.useState(t.profile.bio||""),[$,F]=o.useState(t.profile.signature||""),[z,B]=o.useState(((fe=t.profile.links)==null?void 0:fe.website)||""),[R,D]=o.useState(((pe=t.profile.links)==null?void 0:pe.discord)||""),[u,x]=o.useState(((ge=t.profile.links)==null?void 0:ge.telegram)||""),[b,g]=o.useState(t.profile.badges||[]),[v,L]=o.useState(((be=t.profile.privacy)==null?void 0:be.showEmail)??!1),[I,U]=o.useState(((ve=t.profile.privacy)==null?void 0:ve.showStats)??!0),[W,Q]=o.useState(((we=t.profile.privacy)==null?void 0:we.showLinks)??!0),[f,S]=o.useState(((je=t.profile.privacy)==null?void 0:je.allowComments)??!0),[N,H]=o.useState(((ye=t.profile.privacy)==null?void 0:ye.showFollowers)??!0),[Z,ee]=o.useState(((Ne=t.profile.privacy)==null?void 0:Ne.showSecondaryRole)!==!1),[J,qe]=o.useState(((ke=t.profile.privacy)==null?void 0:ke.hiddenProfile)??!1),[xe,Y]=o.useState(null),[X,V]=o.useState(null),Qe=d=>g(k=>k.includes(d)?k.filter(E=>E!==d):k.length>=3?k:[...k,d]),he=d=>k=>{var Se;const E=(Se=k.target.files)==null?void 0:Se[0];if(!E)return;const G=new FileReader;G.onload=()=>{Y(String(G.result||"")),V(d)},G.readAsDataURL(E)},Ze=async()=>{const d={website:z.trim(),discord:R.trim(),telegram:u.trim()},k=Object.fromEntries(Object.entries(d).filter(([,G])=>G)),E={...t.profile.privacy||{},showEmail:v,showStats:I,showLinks:W,allowComments:f,showFollowers:N,showSecondaryRole:Z};r?E.hiddenProfile=J:delete E.hiddenProfile,await a({avatarData:i||void 0,bannerData:m||void 0,accentFrom:p,accentTo:h,bio:w.trim()||void 0,signature:$.trim()||void 0,links:Object.keys(k).length?k:void 0,badges:b,privacy:E}),n()};return e.jsxs("div",{className:"fixed inset-0 z-[120] flex items-start justify-center bg-black/70 px-4 py-8 overflow-y-auto",children:[e.jsxs("div",{className:`${P} w-[min(820px,96vw)]`,style:{position:"relative"},children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("div",{className:"text-lg font-semibold text-white",children:"Настройка профиля"}),e.jsx("button",{className:"btn",onClick:s,children:"Закрыть"})]}),e.jsxs("div",{className:"space-y-5",children:[e.jsxs("div",{className:"grid gap-4 sm:grid-cols-2",children:[e.jsxs("div",{className:j,children:[e.jsx("div",{className:"text-xs uppercase tracking-[0.28em] text-zinc-400/80",children:"Аватар"}),e.jsxs("div",{className:"mt-3 flex items-center gap-3",children:[e.jsx("div",{className:"h-20 w-20 rounded-full",style:{background:i?`url(${i}) center/cover`:`linear-gradient(135deg, ${p}, ${h})`}}),e.jsxs("div",{className:"flex flex-col gap-2",children:[e.jsxs("label",{className:"btn flex items-center gap-2",children:[e.jsx(Me,{size:16})," Загрузить",e.jsx("input",{type:"file",accept:"image/*",hidden:!0,onChange:he("avatar")})]}),i&&e.jsx("button",{className:"btn",onClick:()=>l(""),children:"Удалить"}),i&&e.jsx("button",{className:"btn",onClick:()=>{Y(i),V("avatar")},children:"Обрезать заново"})]})]})]}),e.jsxs("div",{className:j,children:[e.jsx("div",{className:"text-xs uppercase tracking-[0.28em] text-zinc-400/80",children:"Баннер"}),e.jsx("div",{className:"mt-3 h-20 w-full rounded-xl",style:{background:m?`url(${m}) center/cover`:`linear-gradient(135deg, ${p}, ${h})`}}),e.jsxs("div",{className:"mt-3 flex gap-2",children:[e.jsxs("label",{className:"btn flex items-center gap-2",children:[e.jsx(Me,{size:16})," Загрузить",e.jsx("input",{type:"file",accept:"image/*",hidden:!0,onChange:he("banner")})]}),m&&e.jsx("button",{className:"btn",onClick:()=>c(""),children:"Удалить"}),m&&e.jsx("button",{className:"btn",onClick:()=>{Y(m),V("banner")},children:"Обрезать заново"})]})]}),e.jsxs("div",{className:j,children:[e.jsx("div",{className:"text-xs uppercase tracking-[0.28em] text-zinc-400/80",children:"Градиент"}),e.jsxs("div",{className:"mt-3 flex items-center gap-4",children:[e.jsxs("label",{className:"flex items-center gap-2 text-xs text-zinc-400/80",children:[e.jsx("span",{children:"От"}),e.jsx("input",{type:"color",value:p,onChange:d=>y(d.target.value)})]}),e.jsxs("label",{className:"flex items-center gap-2 text-xs text-zinc-400/80",children:[e.jsx("span",{children:"До"}),e.jsx("input",{type:"color",value:h,onChange:d=>C(d.target.value)})]})]})]}),e.jsxs("div",{className:j,children:[e.jsx("div",{className:"text-xs uppercase tracking-[0.28em] text-zinc-400/80",children:"Бейджи (до 3)"}),e.jsx("div",{className:"mt-3 flex flex-wrap gap-2",children:Ut.map(d=>{const k=b.includes(d);return e.jsxs("button",{className:`btn flex items-center gap-2 ${k?"btn-primary":""}`,onClick:()=>Qe(d),type:"button",children:[e.jsx(Fe,{size:16})," ",d]},d)})})]}),e.jsxs("div",{className:`${j} sm:col-span-2`,children:[e.jsx("div",{className:"text-xs uppercase tracking-[0.28em] text-zinc-400/80",children:"О себе"}),e.jsx("textarea",{className:"input mt-2 min-h-[120px]",value:w,onChange:d=>A(d.target.value),placeholder:"Расскажите о себе"})]}),e.jsxs("div",{className:`${j} sm:col-span-2`,children:[e.jsx("div",{className:"text-xs uppercase tracking-[0.28em] text-zinc-400/80",children:"Подпись"}),e.jsx("textarea",{className:"input mt-2 min-h-[90px]",value:$,onChange:d=>F(d.target.value),placeholder:"Текст под сообщениями"})]}),e.jsxs("div",{className:`${j} sm:col-span-2`,children:[e.jsx("div",{className:"text-xs uppercase tracking-[0.28em] text-zinc-400/80",children:"Ссылки"}),e.jsxs("div",{className:"mt-3 grid gap-2 sm:grid-cols-3",children:[e.jsx("input",{className:"input",placeholder:"https://website",value:z,onChange:d=>B(d.target.value)}),e.jsx("input",{className:"input",placeholder:"discord username",value:R,onChange:d=>D(d.target.value)}),e.jsx("input",{className:"input",placeholder:"@telegram",value:u,onChange:d=>x(d.target.value)})]})]}),e.jsxs("div",{className:`${j} sm:col-span-2`,children:[e.jsx("div",{className:"text-xs uppercase tracking-[0.28em] text-zinc-400/80",children:"Приватность"}),e.jsxs("div",{className:"mt-3 grid gap-2 text-sm",children:[e.jsxs("label",{className:"flex items-center gap-2",children:[e.jsx("input",{type:"checkbox",checked:v,onChange:d=>L(d.target.checked)})," Показывать e-mail"]}),e.jsxs("label",{className:"flex items-center gap-2",children:[e.jsx("input",{type:"checkbox",checked:I,onChange:d=>U(d.target.checked)})," Показывать статистику"]}),e.jsxs("label",{className:"flex items-center gap-2",children:[e.jsx("input",{type:"checkbox",checked:W,onChange:d=>Q(d.target.checked)})," Показывать ссылки"]}),e.jsxs("label",{className:"flex items-center gap-2",children:[e.jsx("input",{type:"checkbox",checked:N,onChange:d=>H(d.target.checked)})," Показывать подписчиков"]}),e.jsxs("label",{className:"flex items-center gap-2",children:[e.jsx("input",{type:"checkbox",checked:f,onChange:d=>S(d.target.checked)})," Разрешить комментарии"]}),e.jsxs("label",{className:"flex items-center gap-2",children:[e.jsx("input",{type:"checkbox",checked:Z,onChange:d=>ee(d.target.checked)})," Показывать вторую роль"]}),r&&e.jsxs("label",{className:"flex items-center gap-2",children:[e.jsx("input",{type:"checkbox",checked:J,onChange:d=>qe(d.target.checked)})," Скрыть профиль (виден только администрации)"]})]})]})]}),e.jsxs("div",{className:"flex justify-end gap-2",children:[e.jsx("button",{className:"btn",onClick:s,children:"Отмена"}),e.jsx("button",{className:"btn btn-primary",onClick:Ze,children:"Сохранить"})]})]})]}),xe&&X&&e.jsx(Wt,{src:xe,aspect:X==="avatar"?1:21/6,round:X==="avatar",title:X==="avatar"?"Обрезать аватар":"Обрезать баннер",onCancel:()=>{Y(null),V(null)},onDone:d=>{X==="avatar"?l(d):c(d),Y(null),V(null)}})]})}export{Gt as default};
