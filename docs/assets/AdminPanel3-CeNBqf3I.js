import{c as O,j as e,t as U,w as B,f as W,x as G,s as q,y as Q,z as H,A as J,B as K,D as X,E as Y,F as Z,G as ee,H as te,I as se}from"./index-GmA9HvdW.js";import{R as l,L as ae}from"./react-vendor-DTkXckhQ.js";import{r as ne}from"./forumStore-7eEJflxB.js";import{listSections as P,listTopics as _,listLatestPosts as ie,createSection as ce,updateSection as re,deleteSection as le,updateTopic as L,moveTopic as oe,deleteTopic as de}from"./forumRemote-D5s3MT8n.js";import"./icons-ByfTEOcz.js";function F(){try{const n=localStorage.getItem("forum:session")??sessionStorage.getItem("forum:session"),x=n?JSON.parse(n):null;return(x==null?void 0:x.userId)||"unknown"}catch{return"unknown"}}function ye(){const[n,x]=l.useState("users"),[r,d]=l.useState(null);l.useEffect(()=>{(async()=>{try{d(await O())}catch{d(null)}})()},[]);const m=r==null?void 0:r.role,h=!!(r!=null&&r.owner),b=h||m==="developer"?["insights","users","sections","topics","invites","maintenance"]:m==="admin"?["users","topics","invites"]:m==="moderator"?["users","invites"]:["topics"];return e.jsxs("div",{className:"mx-auto w-full max-w-5xl px-4 py-6",children:[e.jsx("div",{className:"mb-4 flex gap-2",children:b.map(u=>e.jsx("button",{className:`btn ${n===u?"btn-primary":""}`,onClick:()=>x(u),children:u},u))}),n==="insights"&&e.jsx(me,{}),n==="users"&&e.jsx(ue,{meRole:m,meId:r==null?void 0:r.id,meOwner:h}),n==="sections"&&e.jsx(xe,{}),n==="topics"&&e.jsx(pe,{meRole:m}),n==="invites"&&e.jsx(he,{meRole:m,meId:(r==null?void 0:r.id)||""}),n==="maintenance"&&e.jsx(ve,{})]})}function me(){const[n,x]=l.useState(!0),[r,d]=l.useState(null),[m,h]=l.useState({members:0,sections:0,topics:0,replies:0,views:0}),[b,u]=l.useState([]),[j,y]=l.useState([]),[c,v]=l.useState([]);l.useEffect(()=>{let a=!0;return x(!0),d(null),(async()=>{try{const[p,f,S,t,s]=await Promise.all([U(),P(),_(),B().catch(()=>[]),ie(5).catch(()=>[])]);if(!a)return;const o=S.reduce((w,C)=>w+(C.replyCount??0),0),g=S.reduce((w,C)=>w+(C.viewCount??0),0),k=[...S].sort((w,C)=>new Date(C.updatedAt||C.createdAt||0).getTime()-new Date(w.updatedAt||w.createdAt||0).getTime()).slice(0,5),D=Array.isArray(t)?[...t].sort((w,C)=>new Date(C.createdAt||0).getTime()-new Date(w.createdAt||0).getTime()):[];h({members:p.length,sections:f.length,topics:S.length,replies:o,views:g}),u(k),y(D.slice(0,5)),v(Array.isArray(s)?s:[])}catch(p){if(!a)return;d((p==null?void 0:p.message)||"Failed to load insights")}finally{a&&x(!1)}})(),()=>{a=!1}},[]);const i=a=>{if(!a)return"—";try{return new Date(a).toLocaleString()}catch{return a}};return e.jsxs("div",{className:"grid gap-4",children:[r&&e.jsx("div",{className:"card border border-rose-500/40 bg-rose-500/10 p-4 text-sm text-rose-200",children:r}),e.jsx("div",{className:"grid gap-3 md:grid-cols-2 lg:grid-cols-4",children:[{label:"Участники",value:m.members},{label:"Разделы",value:m.sections},{label:"Темы",value:m.topics},{label:"Ответы",value:m.replies}].map(a=>e.jsxs("div",{className:"card p-4",children:[e.jsx("div",{className:"text-xs uppercase tracking-[0.28em] text-zinc-400/80",children:a.label}),e.jsx("div",{className:"mt-2 text-2xl font-bold text-white",children:n?"…":a.value})]},a.label))}),e.jsxs("div",{className:"grid gap-4 lg:grid-cols-2",children:[e.jsxs("div",{className:"card p-4",children:[e.jsxs("div",{className:"mb-3 flex items-center justify-between",children:[e.jsx("div",{className:"font-semibold",children:"Активные темы"}),n&&e.jsx("span",{className:"text-xs text-zinc-400/80",children:"Обновление…"})]}),e.jsxs("div",{className:"grid gap-2",children:[!n&&b.length===0&&e.jsx("div",{className:"text-sm text-zinc-400/80",children:"Тем пока нет."}),b.map(a=>e.jsxs("div",{className:"rounded-xl border border-white/10 bg-white/[0.04] p-3 text-sm",children:[e.jsx("div",{className:"font-semibold text-white",children:a.title}),e.jsxs("div",{className:"mt-1 text-xs text-zinc-400/80",children:["Обновлено: ",i(a.updatedAt||a.createdAt)," · Ответов ",a.replyCount??0]})]},a.id))]})]}),e.jsxs("div",{className:"card p-4",children:[e.jsxs("div",{className:"mb-3 flex items-center justify-between",children:[e.jsx("div",{className:"font-semibold",children:"Свежие приглашения"}),e.jsx("span",{className:"text-xs text-zinc-400/80",children:j.length})]}),e.jsxs("div",{className:"grid gap-2",children:[!n&&j.length===0&&e.jsx("div",{className:"text-sm text-zinc-400/80",children:"Пока не создано ни одного приглашения."}),j.slice(0,5).map(a=>e.jsxs("div",{className:"rounded-xl border border-white/10 bg-white/[0.04] p-3 text-sm",children:[e.jsx("div",{className:"font-mono text-xs text-cyan-300",children:a.code}),e.jsxs("div",{className:"mt-1 text-xs text-zinc-400/80",children:[i(a.createdAt)," ",a.note?`· ${a.note}`:""]})]},`${a.code}-${a.createdAt}`))]})]})]}),e.jsxs("div",{className:"card p-4",children:[e.jsxs("div",{className:"mb-3 flex items-center justify-between",children:[e.jsx("div",{className:"font-semibold",children:"Последние ответы"}),e.jsx(ae,{to:"/forum?feed=latest",className:"text-xs text-cyan-300 hover:underline",children:"Перейти в ленту"})]}),e.jsxs("div",{className:"grid gap-2",children:[!n&&c.length===0&&e.jsx("div",{className:"text-sm text-zinc-400/80",children:"Свежих ответов нет."}),c.map(a=>e.jsxs("div",{className:"rounded-xl border border-white/10 bg-white/[0.04] p-3 text-sm",children:[e.jsx("div",{className:"font-semibold text-white truncate",children:a.topicTitle||a.title||"Пост"}),e.jsx("div",{className:"mt-1 text-xs text-zinc-400/80",children:i(a.createdAt||a.updatedAt)})]},a.id))]})]})]})}function ue({meRole:n,meId:x,meOwner:r}){const[d,m]=l.useState([]),[h,b]=l.useState(""),u=l.useCallback(async()=>{try{m(await U())}catch(t){alert((t==null?void 0:t.message)||"Failed to load users")}},[]);l.useEffect(()=>{u()},[u]);const j=l.useMemo(()=>{const t=h.trim().toLowerCase();return t?d.filter(s=>{const o=String(s.username||"").toLowerCase(),g=String(s.email||"").toLowerCase(),k=String(s.userNumber||""),D=String(s.invitedByName||"").toLowerCase();return o.includes(t)||g.includes(t)||k.includes(t)||D.includes(t)}):d},[d,h]),y=r||n==="developer",c=r||n==="developer"||n==="admin",v=r||n==="developer"||n==="admin"||n==="moderator",i=async(t,s)=>{if(y)try{await q(t,s),u()}catch(o){alert((o==null?void 0:o.message)||"Failed to set role")}},a=async t=>{if(!v)return;const s=parseInt(prompt("Mute minutes","60")||"60",10),o=new Date(Date.now()+Math.max(1,s)*6e4).toISOString();try{await Z(t,o),await u()}catch(g){alert((g==null?void 0:g.message)||"Failed to mute")}},p=async t=>{if(v)try{await ee(t),await u()}catch(s){alert((s==null?void 0:s.message)||"Failed to unmute")}},f=async t=>{if(!c)return;const s=parseInt(prompt("Ban days","7")||"7",10),o=new Date(Date.now()+Math.max(1,s)*864e5).toISOString();try{await te(t,o),await u()}catch(g){alert((g==null?void 0:g.message)||"Failed to ban")}},S=async t=>{if(c)try{await se(t),await u()}catch(s){alert((s==null?void 0:s.message)||"Failed to unban")}};return e.jsxs("div",{className:"card p-4",children:[e.jsx("div",{className:"mb-3 text-sm opacity-70",children:"Remote accounts fetched from the Worker API. Use this panel to adjust roles and moderation privileges."}),e.jsxs("div",{className:"mb-4 flex flex-wrap items-center gap-2",children:[e.jsx("input",{className:"input w-full sm:w-72",placeholder:"Поиск по нику, e-mail или номеру",value:h,onChange:t=>b(t.target.value)}),e.jsx("button",{className:"btn",onClick:u,children:"Обновить"}),h&&e.jsx("button",{className:"btn",onClick:()=>b(""),children:"Сбросить"})]}),e.jsxs("div",{className:"grid gap-2",children:[j.map(t=>{const s=Number(t.userNumber||0)===1,o=String(t.role||"user"),g=[];v&&!s&&(g.push(e.jsx("button",{className:"btn",onClick:()=>a(t.id),children:"Mute"},"mute")),g.push(e.jsx("button",{className:"btn",onClick:()=>p(t.id),children:"Unmute"},"unmute"))),c&&!s&&(g.push(e.jsx("button",{className:"btn",onClick:()=>f(t.id),children:"Ban"},"ban")),g.push(e.jsx("button",{className:"btn",onClick:()=>S(t.id),children:"Unban"},"unban")));const k=Date.now(),D=!!t.vipUntil&&new Date(t.vipUntil).getTime()>k,w=!!t.mutedUntil&&new Date(t.mutedUntil).getTime()>k,C=!!t.bannedUntil&&new Date(t.bannedUntil).getTime()>k,E=async()=>{try{const N=await Q(t.id),T=((N==null?void 0:N.labels)||[]).join(", "),A=prompt("Custom labels (comma-separated, up to 7)",T||"");if(A===null)return;const $=A.split(",").map(R=>R.trim()).filter(Boolean).slice(0,7);await H(t.id,$),alert("Labels updated")}catch(N){alert((N==null?void 0:N.message)||"Failed to update labels")}},V=async()=>{const N=parseInt(prompt("VIP days","30")||"30",10);try{await J(t.id,isNaN(N)?30:Math.max(1,N)),await u()}catch(T){alert((T==null?void 0:T.message)||"Failed to set VIP")}},z=async()=>{try{await K(t.id),await u()}catch(N){alert((N==null?void 0:N.message)||"Failed to remove VIP")}},M=s?"OWNER":n==="developer"?t.invitedByName?`invited by: ${t.invitedByName}`:"":x&&t.invitedById&&t.invitedById===x?"invited by: you":"",I=[];return M&&I.push(e.jsx("span",{className:"rounded-full bg-white/5 px-2 py-0.5 text-[11px] uppercase tracking-[0.26em] text-zinc-300",children:M},"invited")),D&&I.push(e.jsx("span",{className:"rounded-full bg-amber-500/10 px-2 py-0.5 text-[11px] uppercase tracking-wider text-amber-300",title:`VIP until ${new Date(t.vipUntil).toLocaleString()}`,children:"VIP"},"vip")),C&&I.push(e.jsx("span",{className:"rounded-full bg-rose-500/10 px-2 py-0.5 text-[11px] uppercase tracking-[0.26em] text-rose-300",title:`Banned until ${t.bannedUntil?new Date(t.bannedUntil).toLocaleString():""}`,children:"Banned"},"banned")),w&&I.push(e.jsx("span",{className:"rounded-full bg-amber-500/10 px-2 py-0.5 text-[11px] uppercase tracking-[0.26em] text-amber-300",title:`Muted until ${t.mutedUntil?new Date(t.mutedUntil).toLocaleString():""}`,children:"Muted"},"muted")),e.jsxs("div",{className:"grid grid-cols-1 items-center gap-3 rounded-xl border px-3 py-2 sm:grid-cols-[80px_1fr_1fr_220px_auto]",style:{borderColor:"var(--border)"},children:[e.jsxs("div",{className:"text-xs opacity-70",children:["#",t.userNumber]}),e.jsx("div",{className:"font-semibold",children:t.username}),e.jsx("div",{className:"text-sm opacity-80 truncate",children:r||n==="developer"?t.email:""}),e.jsx("div",{className:"flex flex-wrap items-center gap-2 text-xs opacity-70",children:I.length?I:null}),e.jsxs("div",{className:"flex flex-wrap items-center justify-end gap-2",children:[y&&!s||s&&x===t.id?e.jsxs("select",{className:"input",value:t.role,onChange:N=>i(t.id,N.target.value),children:[e.jsx("option",{value:"developer",children:"developer"}),e.jsx("option",{value:"admin",children:"admin"}),e.jsx("option",{value:"moderator",children:"moderator"}),e.jsx("option",{value:"vip",children:"vip"}),e.jsx("option",{value:"user",children:"user"}),e.jsx("option",{value:"newbie",children:"newbie"})]}):e.jsx("span",{className:"rounded-full border px-2 py-1 text-xs uppercase tracking-wider",style:{borderColor:"var(--border)"},children:s?"OWNER":o}),e.jsx("button",{className:"btn",onClick:E,title:"Custom labels",children:"Labels"}),e.jsx("button",{className:"btn",onClick:V,title:"Give VIP",children:"Give VIP"}),t.vipUntil&&e.jsx("button",{className:"btn",onClick:z,title:"Remove VIP",children:"UnVIP"}),g.length?g:null]})]},t.id)}),!j.length&&e.jsx("div",{className:"text-sm opacity-70",children:"No users found."})]})]})}function xe(){const[n,x]=l.useState([]),[r,d]=l.useState(""),[m,h]=l.useState(""),b=l.useCallback(async()=>{try{x(await P())}catch(c){alert((c==null?void 0:c.message)||"Failed to load sections")}},[]);l.useEffect(()=>{b()},[b]);const u=async()=>{if(r.trim())try{await ce({title:r.trim(),description:m.trim(),actorId:F()}),d(""),h(""),b()}catch(c){alert((c==null?void 0:c.message)||"Failed to create section")}},j=async(c,v,i)=>{try{await re(c,{[v]:i,actorId:F()}),b()}catch(a){alert((a==null?void 0:a.message)||"Failed to update section")}},y=async c=>{if(confirm("Delete this section?"))try{await le(c),b()}catch(v){alert((v==null?void 0:v.message)||"Failed")}};return e.jsxs("div",{className:"grid gap-4",children:[e.jsxs("div",{className:"card p-4",children:[e.jsx("div",{className:"mb-2 font-semibold",children:"Create section"}),e.jsxs("div",{className:"grid gap-2 sm:grid-cols-[1fr_1fr_auto]",children:[e.jsx("input",{className:"input",placeholder:"Title",value:r,onChange:c=>d(c.target.value)}),e.jsx("input",{className:"input",placeholder:"Description",value:m,onChange:c=>h(c.target.value)}),e.jsx("button",{className:"btn btn-primary",onClick:u,children:"Add"})]})]}),e.jsxs("div",{className:"card p-4",children:[e.jsx("div",{className:"mb-2 font-semibold",children:"Sections"}),e.jsxs("div",{className:"grid gap-2",children:[n.map(c=>e.jsxs("div",{className:"grid grid-cols-1 items-center gap-2 rounded-xl border px-3 py-2 sm:grid-cols-[160px_1fr_1fr_auto]",style:{borderColor:"var(--border)"},children:[e.jsxs("div",{className:"text-xs opacity-70",children:[c.id.slice(0,8),":"]}),e.jsx("input",{className:"input",value:c.title,onChange:v=>j(c.id,"title",v.target.value)}),e.jsx("input",{className:"input",value:c.description||"",onChange:v=>j(c.id,"description",v.target.value)}),e.jsx("div",{className:"text-right",children:e.jsx("button",{className:"btn",onClick:()=>y(c.id),children:"Delete"})})]},c.id)),!n.length&&e.jsx("div",{className:"text-sm opacity-70",children:"No sections yet."})]})]})]})}function pe({meRole:n}){const[x,r]=l.useState([]),d=l.useCallback(async()=>{try{r(await _())}catch(i){alert((i==null?void 0:i.message)||"Failed to load topics")}},[]);l.useEffect(()=>{d()},[d]);const m=n==="developer",h=n==="developer",b=n==="developer",u=n==="developer"||n==="admin",j=async(i,a)=>{if(m)try{await L(i,{pinned:a,actorId:F()}),d()}catch(p){alert((p==null?void 0:p.message)||"Failed to update topic")}},y=async(i,a)=>{if(h)try{await L(i,{locked:a,actorId:F()}),d()}catch(p){alert((p==null?void 0:p.message)||"Failed to update topic")}},c=async i=>{if(!b)return;const p=(prompt("Move to section ID","")||"").trim();if(p)try{await oe(i,p),d()}catch(f){alert((f==null?void 0:f.message)||"Failed to move topic")}},v=async i=>{if(u&&confirm("Delete this topic?"))try{await de(i),d()}catch(a){alert((a==null?void 0:a.message)||"Failed to delete")}};return e.jsxs("div",{className:"card p-4",children:[e.jsx("div",{className:"mb-2 font-semibold",children:"Topics"}),e.jsxs("div",{className:"grid gap-2",children:[x.map(i=>{const a=[];return m&&a.push(e.jsxs("label",{className:"flex items-center gap-2 text-sm",children:[e.jsx("input",{type:"checkbox",checked:!!i.pinned,onChange:p=>j(i.id,p.target.checked)}),"pinned"]},"pin")),h&&a.push(e.jsxs("label",{className:"flex items-center gap-2 text-sm",children:[e.jsx("input",{type:"checkbox",checked:!!i.locked,onChange:p=>y(i.id,p.target.checked)}),"locked"]},"lock")),b&&a.push(e.jsx("button",{className:"btn",onClick:()=>c(i.id),children:"Move"},"move")),u&&a.push(e.jsx("button",{className:"btn",onClick:()=>v(i.id),children:"Delete"},"delete")),e.jsxs("div",{className:"grid grid-cols-1 items-start gap-3 rounded-xl border px-3 py-3 sm:grid-cols-[1fr_auto]",style:{borderColor:"var(--border)"},children:[e.jsxs("div",{children:[e.jsx("div",{className:"font-semibold",children:i.title}),e.jsxs("div",{className:"text-xs opacity-70",children:["id: ",i.id.slice(0,8),": section: ",i.sectionId.slice(0,8),":"]}),(i.pinned||i.locked)&&e.jsxs("div",{className:"mt-1 flex flex-wrap gap-2 text-[10px] uppercase tracking-[0.2em] opacity-70",children:[i.pinned&&e.jsx("span",{children:"pinned"}),i.locked&&e.jsx("span",{children:"locked"})]})]}),a.length?e.jsx("div",{className:"flex flex-wrap items-center justify-end gap-2",children:a}):null]},i.id)}),!x.length&&e.jsx("div",{className:"text-sm opacity-70",children:"No topics yet."})]})]})}function he({meRole:n,meId:x}){const[r,d]=l.useState([]),[m,h]=l.useState(5),[b,u]=l.useState(""),j=n==="developer",y=l.useCallback(async()=>{try{const s=await B(),o=j?s:s.filter(g=>(g.createdBy||"")===(x||""));d(o)}catch(s){alert((s==null?void 0:s.message)||"Failed")}},[j,x]);l.useEffect(()=>{y()},[y]);const c=Date.now(),v=n==="admin"?48*3600*1e3:n==="moderator"?72*3600*1e3:0,i=v?c-v:0,a=r.filter(s=>{const o=new Date(s.createdAt).getTime();return!isNaN(o)&&o>=i}),f=Math.max(0,(n==="admin"?2:n==="moderator"?1:1/0)-a.length),S=async()=>{try{const s=Math.max(1,Math.min(20,m)),o=isFinite(f)?Math.min(f,s):s;if(!j&&o<=0){alert("Invite quota reached. Try again later.");return}await X(o,b||void 0),u(""),y()}catch(s){alert((s==null?void 0:s.message)||"Failed to generate")}},t=async s=>{if(confirm("Delete this invite?"))try{await Y(s),y()}catch(o){alert((o==null?void 0:o.message)||"Failed")}};return e.jsxs("div",{className:"card p-4",children:[e.jsx("div",{className:"mb-3 font-semibold",children:"Invite codes"}),e.jsxs("div",{className:"mb-4 grid gap-2 sm:grid-cols-[120px_1fr_auto]",children:[e.jsx("input",{className:"input",type:"number",min:1,max:Math.min(20,isFinite(f)?Math.max(f,0):20),value:m,onChange:s=>h(parseInt(s.target.value||"1",10))}),e.jsx("input",{className:"input",placeholder:"note (optional)",value:b,onChange:s=>u(s.target.value)}),e.jsx("button",{className:"btn btn-primary",onClick:S,disabled:!j&&f<=0,title:!j&&f<=0?"Quota reached":void 0,children:"Generate"})]}),!j&&e.jsxs("div",{className:"mb-4 text-xs opacity-70",children:[n==="admin"&&e.jsxs("span",{children:["Remaining in 48h window: ",e.jsx("b",{children:f})," of 2"]}),n==="moderator"&&e.jsxs("span",{children:["Remaining in 72h window: ",e.jsx("b",{children:f})," of 1"]})]}),e.jsxs("div",{className:"grid gap-2",children:[r.map(s=>{var o;return e.jsxs("div",{className:"grid grid-cols-1 items-center gap-2 rounded-xl border px-3 py-2 sm:grid-cols-[160px_1fr_1fr_1fr_auto]",style:{borderColor:"var(--border)"},children:[e.jsx("div",{className:"font-mono text-sm",children:s.code}),e.jsxs("div",{className:"text-xs opacity-70",children:["created: ",new Date(s.createdAt).toLocaleString()]}),e.jsx("div",{className:"text-xs opacity-80",children:j?`by: ${s.createdByName||((o=s.createdBy)==null?void 0:o.slice(0,8))}`:"by: you"}),e.jsx("div",{className:"text-xs",children:s.note||""}),e.jsx("div",{className:"text-xs",children:s.usedBy?e.jsx("span",{className:"text-emerald-400",children:"used"}):e.jsx("span",{className:"opacity-70",children:"unused"})}),e.jsx("div",{className:"text-right",children:e.jsx("button",{className:"btn",onClick:()=>t(s.code),children:"Delete"})})]},`${s.code}-${s.createdAt}`)}),!r.length&&e.jsx("div",{className:"text-sm opacity-70",children:"No invite codes yet."})]})]})}function ve(){const[n,x]=l.useState("invite");l.useEffect(()=>{(async()=>{try{const d=await W();x((d==null?void 0:d.registrationMode)||"invite")}catch{}})()},[]);const r=()=>{confirm("Reset the forum (keep it empty)?")&&(ne(F()),alert("Done. Forum was cleared."),location.reload())};return e.jsxs("div",{className:"card p-4",children:[e.jsx("div",{className:"mb-2 font-semibold",children:"Registration settings"}),e.jsxs("div",{className:"mb-3 flex items-center gap-2",children:[e.jsx("span",{className:"text-sm opacity-70",children:"Registration:"}),e.jsxs("select",{className:"input",value:n,onChange:async d=>{const m=d.target.value;x(m);try{await G({registrationMode:m})}catch(h){alert((h==null?void 0:h.message)||"Failed")}},children:[e.jsx("option",{value:"invite",children:"Invite only"}),e.jsx("option",{value:"open",children:"Open"})]})]}),e.jsx("div",{className:"mb-2 font-semibold",children:"Maintenance"}),e.jsx("p",{className:"mb-3 text-sm opacity-70",children:"Reset the forum when you need a clean slate before inviting the community."}),e.jsx("button",{className:"btn btn-primary",onClick:r,children:"Reset forum (empty)"})]})}export{ye as default};
