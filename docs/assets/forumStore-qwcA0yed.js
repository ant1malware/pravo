import{c as O,e as x,F as A}from"./index-CkI-Uld4.js";const R=/^[A-Za-z0-9_]{3,16}$/;function _(t){if(!R.test(t))throw new Error("Ник должен быть на английском: 3–16 символов (латиница, цифры, _).")}function U(){if(!(typeof window>"u"))return window}function f(t,e){const o=U();if(!o)return e;try{const n=o.localStorage.getItem(t);return n?JSON.parse(n):e}catch{return e}}function c(t,e){const o=U();if(o)try{o.localStorage.setItem(t,JSON.stringify(e))}catch{}}function b(t,e){const o=U();if(o)try{const n=e==="local"?o.localStorage:o.sessionStorage;t?n.setItem(A,JSON.stringify(t)):n.removeItem(A)}catch{}}function h(t){const e=U();if(e)try{(t==="local"?e.localStorage:e.sessionStorage).removeItem(A)}catch{}}function p(){return new Date().toISOString()}function z(t=16){const e="ABCDEFGHJKLMNPQRSTUVWXYZ23456789";if(typeof crypto<"u"){if(typeof crypto.randomUUID=="function")return crypto.randomUUID().replace(/-/g,"").slice(0,t).toUpperCase();if(typeof crypto.getRandomValues=="function"){const n=new Uint32Array(t);crypto.getRandomValues(n);let i="";for(let r=0;r<t;r+=1)i+=e[n[r]%e.length];return i}}let o="";for(let n=0;n<t;n+=1)o+=e[Math.floor(Math.random()*e.length)];return o}function S(t){return t.replace(/[^A-Za-z0-9]/g,"").toUpperCase()}function N(t){return t?t.until?new Date(t.until).getTime()>Date.now():!0:!1}let k=!1;function I(){if(k)return;k=!0,f("forum:initialized",!1)||($(),c("forum:initialized",!0))}function $(){const t=p(),e={id:crypto.randomUUID(),username:"Pavel",email:"pavel@forum.local",createdAt:t,role:"developer",userNumber:1,posts:3,likes:6,topics:2,profile:{bio:"Создатель SKY форума. Слежу за порядком и вдохновляю команду.",links:{website:"https://sky.local"},accentFrom:"#a855f7",accentTo:"#22d3ee",badges:["Founder","Core"],privacy:{showEmail:!0,showStats:!0}},bans:null,mutes:null},o={id:crypto.randomUUID(),username:"elysia",email:"elysia@forum.local",createdAt:t,role:"moderator",userNumber:2,posts:5,likes:8,topics:1,profile:{bio:"Фанат ретро-интерфейсов, модерирую раздел дизайна.",signature:"Stay liquid",links:{discord:"elysia#2048"},accentFrom:"#f472b6",accentTo:"#c084fc",badges:["Moderator"],privacy:{showEmail:!1,showStats:!0}},bans:null,mutes:null},n={id:crypto.randomUUID(),username:"raptor",email:"raptor@forum.local",createdAt:t,role:"vip",userNumber:3,posts:2,likes:3,topics:1,profile:{bio:"Тестирую новые версии SKY. Люблю длинные треды.",links:{telegram:"@raptor"},accentFrom:"#38bdf8",accentTo:"#a855f7",badges:["Early"],privacy:{showEmail:!1,showStats:!0}},bans:null,mutes:null};c("forum:accounts",[e,o,n]);const i=[{id:crypto.randomUUID(),title:"SKY Update Log",description:"Анонсы обновлений, бета-релизы, планы.",icon:"🛠",createdAt:t,order:1,moderatorIds:[e.id],topicCount:1,postCount:4},{id:crypto.randomUUID(),title:"Design Lab",description:"UI/UX, экспериментальные концепты, ретрофутуризм.",icon:"🎨",createdAt:t,order:2,moderatorIds:[o.id],topicCount:1,postCount:3},{id:crypto.randomUUID(),title:"Community Lounge",description:"Знакомства, свободные разговоры, сбор фидбэка.",icon:"🪐",createdAt:t,order:3,moderatorIds:[o.id,n.id],topicCount:1,postCount:3}];c("forum:sections",i);const r=[{id:crypto.randomUUID(),sectionId:i[0].id,title:"SKY 0.9 Roadmap",authorId:e.id,createdAt:t,updatedAt:t,pinned:!0,locked:!1,movedTo:null,viewCount:124,replyCount:2,lastPostAt:t,lastPostBy:o.id},{id:crypto.randomUUID(),sectionId:i[1].id,title:"Liquid glass паттерны",authorId:o.id,createdAt:t,updatedAt:t,pinned:!1,locked:!1,movedTo:null,viewCount:86,replyCount:1,lastPostAt:t,lastPostBy:e.id},{id:crypto.randomUUID(),sectionId:i[2].id,title:"Добро пожаловать в форум SKY",authorId:n.id,createdAt:t,updatedAt:t,pinned:!0,locked:!1,movedTo:null,viewCount:96,replyCount:2,lastPostAt:t,lastPostBy:e.id}];c("forum:topics",r);const u=[{id:crypto.randomUUID(),topicId:r[0].id,authorId:e.id,content:"Друзья, собираем планы на 0.9: новый редактор, режим SKY Home, система достижений.",createdAt:t,likes:[o.id,n.id]},{id:crypto.randomUUID(),topicId:r[0].id,authorId:o.id,content:"Прототипы готовы. Нужны тестеры для редизайна панели модерации.",createdAt:t,likes:[e.id]},{id:crypto.randomUUID(),topicId:r[1].id,authorId:o.id,content:"Собираю коллекцию эффектов для стекла. Делитесь скринами и CSS.",createdAt:t,likes:[n.id]},{id:crypto.randomUUID(),topicId:r[1].id,authorId:e.id,content:"Добавил токены для акцентных градиентов. Проверяйте в index.css.",createdAt:t,likes:[o.id]},{id:crypto.randomUUID(),topicId:r[2].id,authorId:n.id,content:"Расскажите о себе! Я занимаюсь QA и люблю тёмные темы.",createdAt:t,likes:[o.id]},{id:crypto.randomUUID(),topicId:r[2].id,authorId:o.id,content:"Привет всем! Готов помогать с оформлением и модерировать Lounge.",createdAt:t,likes:[n.id]},{id:crypto.randomUUID(),topicId:r[2].id,authorId:e.id,content:"Будем держать космический вайб и уважение друг к другу.",createdAt:t,likes:[n.id,o.id]}];c("forum:posts",u),c("forum:settings",{heroTitle:"SKY Forum",heroSubtitle:"Эксклюзивное сообщество для разработчиков и исследователей SKY.",heroMessage:"Обсуждаем обновления, делимся концептами и тестируем будущее интерфейсов.",registrationOpen:!0,requireEnglishNick:!0,allowGuestRead:!1}),c("forum:counters",{nextUserNumber:4});const a=[{code:"SKYACCESSCODE000",createdAt:t,createdBy:e.id,note:"Демо приглашение",usedBy:o.id,usedAt:t},{code:"SKYACCESSCODE001",createdAt:t,createdBy:e.id,note:"Запас для теста",usedBy:null,usedAt:null}];c("forum:invites",a);const d={id:crypto.randomUUID(),createdAt:t,actorId:e.id,action:"seed",targetType:"settings",notes:"Инициализация демо-данных форума"};c("forum:logs",[d])}function w(){return I(),f("forum:accounts",[])}function L(t){c("forum:accounts",t)}function v(){return I(),f("forum:sections",[])}function D(t){c("forum:sections",t)}function C(){return I(),f("forum:topics",[])}function F(t){c("forum:topics",t)}function M(){return I(),f("forum:posts",[])}function B(){return I(),f("forum:settings",{heroTitle:"SKY Forum",heroSubtitle:"",heroMessage:"",registrationOpen:!1,requireEnglishNick:!0,allowGuestRead:!1})}function q(){return I(),f("forum:counters",{nextUserNumber:1})}function G(t){c("forum:counters",t)}function J(){return I(),f("forum:logs",[])}function V(t){c("forum:logs",t)}function E(){return I(),f("forum:invites",[])}function K(t){c("forum:invites",t)}function y(t){const e=J(),o={id:crypto.randomUUID(),createdAt:p(),...t};e.unshift(o),V(e.slice(0,200))}function P(t,e){const o={userId:t,remember:e,lastLogin:p()};e?(b(o,"local"),h("session")):(b(o,"session"),h("local")),x()}function tt(){h("local"),h("session"),x()}function et(){const t=O();return t?T(t.userId):null}function ot(){return w()}function nt(){return E().slice().sort((t,e)=>t.createdAt<e.createdAt?1:-1)}function T(t){return w().find(e=>e.id===t)||null}function Z(t){return w().find(e=>e.username.toLowerCase()===t.toLowerCase())||null}function H(t){const e=S(t);if(!e)throw new Error("Введите инвайт-код.");if(e.length!==16)throw new Error("Инвайт-код должен содержать 16 символов.");const o=E(),n=o.find(i=>S(i.code)===e);if(!n)throw new Error("Инвайт-код не найден или устарел.");if(n.usedBy)throw new Error("Инвайт-код уже использован.");return{invite:n,invites:o,normalized:e}}function Q(t,e,o){const n=t.map(i=>i.code===e.code?{...i,usedBy:o,usedAt:p()}:i);K(n),y({actorId:o,action:"invite_use",targetType:"settings",notes:e.code})}function it({username:t,email:e,remember:o,inviteCode:n}){const i=B();if(!i.registrationOpen)throw new Error("Регистрация закрыта администратором.");i.requireEnglishNick&&_(t);const{invite:r,invites:u,normalized:m}=H(n);if(!e.includes("@"))throw new Error("Введите корректный e-mail.");if(Z(t))throw new Error("Такой ник уже занят.");const a=w(),d=q(),l={id:crypto.randomUUID(),username:t,email:e,createdAt:p(),role:"newbie",userNumber:d.nextUserNumber,posts:0,likes:0,topics:0,profile:{bio:"",signature:"",links:{},accentFrom:"#8b5cf6",accentTo:"#0ea5e9",badges:[],privacy:{showEmail:!1,showStats:!0}},bans:null,mutes:null};return a.push(l),L(a),d.nextUserNumber+=1,G(d),Q(u,r,l.id),y({actorId:l.id,action:"register",targetType:"account",targetId:l.id,notes:`Новый пользователь ${t} по инвайту ${m}`}),P(l.id,o),{account:l}}function rt({usernameOrEmail:t,remember:e}){var i;const o=t.trim().toLowerCase(),n=w().find(r=>r.username.toLowerCase()===o||r.email.toLowerCase()===o);if(!n)throw new Error("Пользователь не найден.");if(N(n.bans||void 0))throw new Error(((i=n.bans)==null?void 0:i.reason)||"Аккаунт заблокирован.");return P(n.id,e),y({actorId:n.id,action:"login",targetType:"account",targetId:n.id,notes:"Вход в форум"}),{account:n}}function W(t,e){const o=w(),n=o.findIndex(i=>i.id===t);n!==-1&&(o[n]={...o[n],...e},L(o))}function st(t,e,o){T(t)&&W(t,{role:e})}function ct(){return v().slice().sort((t,e)=>t.order-e.order)}function at(t){const e=v(),o={id:crypto.randomUUID(),title:t.title,description:t.description,icon:t.icon,createdAt:p(),order:e.length+1,moderatorIds:t.moderatorIds??[],topicCount:0,postCount:0};return e.push(o),D(e),y({actorId:t.actorId,action:"section_create",targetType:"section",targetId:o.id,notes:o.title}),o}function dt(t,e,o){const n=v(),i=n.findIndex(r=>r.id===t);i!==-1&&(n[i]={...n[i],...e},D(n),y({actorId:o,action:"section_update",targetType:"section",targetId:t,notes:e.title||e.description}))}function ut(t){const e=C();return(t?e.filter(n=>n.sectionId===t):e).slice().sort((n,i)=>n.pinned&&!i.pinned?-1:!n.pinned&&i.pinned?1:new Date(i.lastPostAt).getTime()-new Date(n.lastPostAt).getTime())}function X(t){return C().find(e=>e.id===t)||null}function lt(t,e,o,n){const i=C(),r=i.findIndex(u=>u.id===t);r!==-1&&(i[r]={...i[r],...e,updatedAt:p()},F(i),y({actorId:o,action:"topic_update",targetType:"topic",targetId:t,notes:e.title??void 0}))}function ft(t,e,o){const n=C(),i=n.findIndex(a=>a.id===t);if(i===-1)return;const r=n[i],u=v(),m=u.find(a=>a.id===r.sectionId),g=u.find(a=>a.id===e);if(g){if(n[i]={...r,sectionId:e,movedTo:e,updatedAt:p()},F(n),m&&m.id!==g.id){const d=M().filter(s=>s.topicId===r.id).length,l=u.map(s=>s.id===m.id?{...s,topicCount:Math.max(0,s.topicCount-1),postCount:Math.max(0,s.postCount-d)}:s.id===g.id?{...s,topicCount:s.topicCount+1,postCount:s.postCount+d}:s);D(l)}y({actorId:o,action:"topic_move",targetType:"topic",targetId:t,notes:`в раздел ${e}`})}}function pt(t=8){return M().slice().sort((o,n)=>new Date(n.createdAt).getTime()-new Date(o.createdAt).getTime()).slice(0,t).map(o=>({post:o,topic:X(o.topicId),author:T(o.authorId)}))}function mt({count:t,createdBy:e,note:o}){const n=E(),i=[],r=(o==null?void 0:o.trim())||void 0,u=Math.min(Math.max(Math.floor(t)||0,1),20),m=new Set(n.map(d=>S(d.code))),g=new Set;for(let d=0;d<u;d+=1){let l=0,s;do if(s=S(z(16)),l+=1,l>10)throw new Error("Не удалось сгенерировать уникальный инвайт-код.");while(m.has(s)||g.has(s));g.add(s);const Y={code:s,createdAt:p(),createdBy:e,note:r,usedBy:null,usedAt:null};i.push(Y)}const a=[...i,...n];return K(a),y({actorId:e,action:"invite_generate",targetType:"settings",notes:`${i.length} приглашений${r?` (${r})`:""}`}),i}function gt(){return B()}function It(t){return t?N(t.mutes||void 0):!1}export{pt as a,gt as b,tt as c,rt as d,nt as e,Z as f,et as g,ot as h,It as i,at as j,dt as k,ct as l,ut as m,lt as n,ft as o,mt as p,it as r,st as s,W as u};
