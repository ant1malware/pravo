import{j as e}from"./index-BjJS3am-.js";import{R as m}from"./react-vendor-DTkXckhQ.js";import{r as C}from"./forumStore-B1syHWZt.js";import{l as S,b as I,h as F,i as M,j as D,u as w,m as T,k as _}from"./forumRemote-DHJrJEKR.js";import{g as B,d as E,e as A,f as U,h as O,s as R,i as P,j as W,m as $,k as L,n as q,o as G}from"./authRemote-D9Q-aZvG.js";import"./icons-C8fXSpVf.js";function j(){try{const s=localStorage.getItem("forum:session")??sessionStorage.getItem("forum:session"),p=s?JSON.parse(s):null;return(p==null?void 0:p.userId)||"unknown"}catch{return"unknown"}}function se(){const[s,p]=m.useState("users"),[o,l]=m.useState(null);m.useEffect(()=>{(async()=>{try{l(await B())}catch{l(null)}})()},[]);const r=o==null?void 0:o.role,x=r==="developer"?["users","sections","topics","invites","maintenance"]:r==="admin"?["users","topics","invites"]:r==="moderator"?["users","invites"]:["topics"];return e.jsxs("div",{className:"mx-auto w-full max-w-5xl px-4 py-6",children:[e.jsx("div",{className:"mb-4 flex gap-2",children:x.map(u=>e.jsx("button",{className:`btn ${s===u?"btn-primary":""}`,onClick:()=>p(u),children:u},u))}),s==="users"&&e.jsx(J,{meRole:r,meId:o==null?void 0:o.id}),s==="sections"&&e.jsx(Q,{}),s==="topics"&&e.jsx(z,{meRole:r}),s==="invites"&&e.jsx(H,{meRole:r,meId:(o==null?void 0:o.id)||""}),s==="maintenance"&&e.jsx(K,{})]})}function J({meRole:s,meId:p}){const[o,l]=m.useState([]),r=m.useCallback(async()=>{try{l(await E())}catch(t){alert((t==null?void 0:t.message)||"Failed to load users")}},[]);m.useEffect(()=>{r()},[r]);const x=s==="developer",u=s==="developer"||s==="admin",b=s==="developer"||s==="admin"||s==="moderator",g=async(t,a)=>{if(x)try{await R(t,a),r()}catch(d){alert((d==null?void 0:d.message)||"Failed to set role")}},f=async t=>{if(!b)return;const a=parseInt(prompt("Mute minutes","60")||"60",10),d=new Date(Date.now()+Math.max(1,a)*6e4).toISOString();try{await $(t,d),await r()}catch(v){alert((v==null?void 0:v.message)||"Failed to mute")}},c=async t=>{if(b)try{await L(t),await r()}catch(a){alert((a==null?void 0:a.message)||"Failed to unmute")}},h=async t=>{if(!u)return;const a=parseInt(prompt("Ban days","7")||"7",10),d=new Date(Date.now()+Math.max(1,a)*864e5).toISOString();try{await q(t,d),await r()}catch(v){alert((v==null?void 0:v.message)||"Failed to ban")}},i=async t=>{if(u)try{await G(t),await r()}catch(a){alert((a==null?void 0:a.message)||"Failed to unban")}};return e.jsxs("div",{className:"card p-4",children:[e.jsx("div",{className:"mb-3 text-sm opacity-70",children:"Remote accounts fetched from the Worker API. Use this panel to adjust roles and moderation privileges."}),e.jsxs("div",{className:"grid gap-2",children:[o.map(t=>{const a=Number(t.userNumber||0)===1,d=String(t.role||"user"),v=[];b&&!a&&(v.push(e.jsx("button",{className:"btn",onClick:()=>f(t.id),children:"Mute"},"mute")),v.push(e.jsx("button",{className:"btn",onClick:()=>c(t.id),children:"Unmute"},"unmute"))),u&&!a&&(v.push(e.jsx("button",{className:"btn",onClick:()=>h(t.id),children:"Ban"},"ban")),v.push(e.jsx("button",{className:"btn",onClick:()=>i(t.id),children:"Unban"},"unban")));const N=a?"OWNER":s==="developer"?t.invitedByName?`invited by: ${t.invitedByName}`:"":p&&t.invitedById&&t.invitedById===p?"invited by: you":"";return e.jsxs("div",{className:"grid grid-cols-1 items-center gap-3 rounded-xl border px-3 py-2 sm:grid-cols-[80px_1fr_1fr_220px_auto]",style:{borderColor:"var(--border)"},children:[e.jsxs("div",{className:"text-xs opacity-70",children:["#",t.userNumber]}),e.jsx("div",{className:"font-semibold",children:t.username}),e.jsx("div",{className:"text-sm opacity-80 truncate",children:s==="developer"?t.email:""}),e.jsx("div",{className:"text-xs opacity-70",children:N}),e.jsxs("div",{className:"flex flex-wrap items-center justify-end gap-2",children:[x&&!a?e.jsxs("select",{className:"input",value:t.role,onChange:n=>g(t.id,n.target.value),children:[e.jsx("option",{value:"developer",children:"developer"}),e.jsx("option",{value:"admin",children:"admin"}),e.jsx("option",{value:"moderator",children:"moderator"}),e.jsx("option",{value:"vip",children:"vip"}),e.jsx("option",{value:"user",children:"user"}),e.jsx("option",{value:"newbie",children:"newbie"})]}):e.jsx("span",{className:"rounded-full border px-2 py-1 text-xs uppercase tracking-wider",style:{borderColor:"var(--border)"},children:a?"OWNER":d}),v.length?v:null]})]},t.id)}),!o.length&&e.jsx("div",{className:"text-sm opacity-70",children:"No users yet."})]})]})}function Q(){const[s,p]=m.useState([]),[o,l]=m.useState(""),[r,x]=m.useState(""),u=m.useCallback(async()=>{try{p(await S())}catch(c){alert((c==null?void 0:c.message)||"Failed to load sections")}},[]);m.useEffect(()=>{u()},[u]);const b=async()=>{if(o.trim())try{await F({title:o.trim(),description:r.trim(),actorId:j()}),l(""),x(""),u()}catch(c){alert((c==null?void 0:c.message)||"Failed to create section")}},g=async(c,h,i)=>{try{await M(c,{[h]:i,actorId:j()}),u()}catch(t){alert((t==null?void 0:t.message)||"Failed to update section")}},f=async c=>{if(confirm("Delete this section?"))try{await D(c),u()}catch(h){alert((h==null?void 0:h.message)||"Failed")}};return e.jsxs("div",{className:"grid gap-4",children:[e.jsxs("div",{className:"card p-4",children:[e.jsx("div",{className:"mb-2 font-semibold",children:"Create section"}),e.jsxs("div",{className:"grid gap-2 sm:grid-cols-[1fr_1fr_auto]",children:[e.jsx("input",{className:"input",placeholder:"Title",value:o,onChange:c=>l(c.target.value)}),e.jsx("input",{className:"input",placeholder:"Description",value:r,onChange:c=>x(c.target.value)}),e.jsx("button",{className:"btn btn-primary",onClick:b,children:"Add"})]})]}),e.jsxs("div",{className:"card p-4",children:[e.jsx("div",{className:"mb-2 font-semibold",children:"Sections"}),e.jsxs("div",{className:"grid gap-2",children:[s.map(c=>e.jsxs("div",{className:"grid grid-cols-1 items-center gap-2 rounded-xl border px-3 py-2 sm:grid-cols-[160px_1fr_1fr_auto]",style:{borderColor:"var(--border)"},children:[e.jsxs("div",{className:"text-xs opacity-70",children:[c.id.slice(0,8),":"]}),e.jsx("input",{className:"input",value:c.title,onChange:h=>g(c.id,"title",h.target.value)}),e.jsx("input",{className:"input",value:c.description||"",onChange:h=>g(c.id,"description",h.target.value)}),e.jsx("div",{className:"text-right",children:e.jsx("button",{className:"btn",onClick:()=>f(c.id),children:"Delete"})})]},c.id)),!s.length&&e.jsx("div",{className:"text-sm opacity-70",children:"No sections yet."})]})]})]})}function z({meRole:s}){const[p,o]=m.useState([]),l=m.useCallback(async()=>{try{o(await I())}catch(i){alert((i==null?void 0:i.message)||"Failed to load topics")}},[]);m.useEffect(()=>{l()},[l]);const r=s==="developer",x=s==="developer",u=s==="developer",b=s==="developer"||s==="admin",g=async(i,t)=>{if(r)try{await w(i,{pinned:t,actorId:j()}),l()}catch(a){alert((a==null?void 0:a.message)||"Failed to update topic")}},f=async(i,t)=>{if(x)try{await w(i,{locked:t,actorId:j()}),l()}catch(a){alert((a==null?void 0:a.message)||"Failed to update topic")}},c=async i=>{if(!u)return;const a=(prompt("Move to section ID","")||"").trim();if(a)try{await T(i,a),l()}catch(d){alert((d==null?void 0:d.message)||"Failed to move topic")}},h=async i=>{if(b&&confirm("Delete this topic?"))try{await _(i),l()}catch(t){alert((t==null?void 0:t.message)||"Failed to delete")}};return e.jsxs("div",{className:"card p-4",children:[e.jsx("div",{className:"mb-2 font-semibold",children:"Topics"}),e.jsxs("div",{className:"grid gap-2",children:[p.map(i=>{const t=[];return r&&t.push(e.jsxs("label",{className:"flex items-center gap-2 text-sm",children:[e.jsx("input",{type:"checkbox",checked:!!i.pinned,onChange:a=>g(i.id,a.target.checked)}),"pinned"]},"pin")),x&&t.push(e.jsxs("label",{className:"flex items-center gap-2 text-sm",children:[e.jsx("input",{type:"checkbox",checked:!!i.locked,onChange:a=>f(i.id,a.target.checked)}),"locked"]},"lock")),u&&t.push(e.jsx("button",{className:"btn",onClick:()=>c(i.id),children:"Move"},"move")),b&&t.push(e.jsx("button",{className:"btn",onClick:()=>h(i.id),children:"Delete"},"delete")),e.jsxs("div",{className:"grid grid-cols-1 items-start gap-3 rounded-xl border px-3 py-3 sm:grid-cols-[1fr_auto]",style:{borderColor:"var(--border)"},children:[e.jsxs("div",{children:[e.jsx("div",{className:"font-semibold",children:i.title}),e.jsxs("div",{className:"text-xs opacity-70",children:["id: ",i.id.slice(0,8),": section: ",i.sectionId.slice(0,8),":"]}),(i.pinned||i.locked)&&e.jsxs("div",{className:"mt-1 flex flex-wrap gap-2 text-[10px] uppercase tracking-[0.2em] opacity-70",children:[i.pinned&&e.jsx("span",{children:"pinned"}),i.locked&&e.jsx("span",{children:"locked"})]})]}),t.length?e.jsx("div",{className:"flex flex-wrap items-center justify-end gap-2",children:t}):null]},i.id)}),!p.length&&e.jsx("div",{className:"text-sm opacity-70",children:"No topics yet."})]})]})}function H({meRole:s,meId:p}){const[o,l]=m.useState([]),[r,x]=m.useState(5),[u,b]=m.useState(""),g=s==="developer",f=m.useCallback(async()=>{try{const n=await A(),y=g?n:n.filter(k=>(k.createdBy||"")===(p||""));l(y)}catch(n){alert((n==null?void 0:n.message)||"Failed")}},[g,p]);m.useEffect(()=>{f()},[f]);const c=Date.now(),h=s==="admin"?48*3600*1e3:s==="moderator"?72*3600*1e3:0,i=h?c-h:0,t=o.filter(n=>{const y=new Date(n.createdAt).getTime();return!isNaN(y)&&y>=i}),d=Math.max(0,(s==="admin"?2:s==="moderator"?1:1/0)-t.length),v=async()=>{try{const n=Math.max(1,Math.min(20,r)),y=isFinite(d)?Math.min(d,n):n;if(!g&&y<=0){alert("Invite quota reached. Try again later.");return}await P(y,u||void 0),b(""),f()}catch(n){alert((n==null?void 0:n.message)||"Failed to generate")}},N=async n=>{if(confirm("Delete this invite?"))try{await W(n),f()}catch(y){alert((y==null?void 0:y.message)||"Failed")}};return e.jsxs("div",{className:"card p-4",children:[e.jsx("div",{className:"mb-3 font-semibold",children:"Invite codes"}),e.jsxs("div",{className:"mb-4 grid gap-2 sm:grid-cols-[120px_1fr_auto]",children:[e.jsx("input",{className:"input",type:"number",min:1,max:Math.min(20,isFinite(d)?Math.max(d,0):20),value:r,onChange:n=>x(parseInt(n.target.value||"1",10))}),e.jsx("input",{className:"input",placeholder:"note (optional)",value:u,onChange:n=>b(n.target.value)}),e.jsx("button",{className:"btn btn-primary",onClick:v,disabled:!g&&d<=0,title:!g&&d<=0?"Quota reached":void 0,children:"Generate"})]}),!g&&e.jsxs("div",{className:"mb-4 text-xs opacity-70",children:[s==="admin"&&e.jsxs("span",{children:["Remaining in 48h window: ",e.jsx("b",{children:d})," of 2"]}),s==="moderator"&&e.jsxs("span",{children:["Remaining in 72h window: ",e.jsx("b",{children:d})," of 1"]})]}),e.jsxs("div",{className:"grid gap-2",children:[o.map(n=>{var y;return e.jsxs("div",{className:"grid grid-cols-1 items-center gap-2 rounded-xl border px-3 py-2 sm:grid-cols-[160px_1fr_1fr_1fr_auto]",style:{borderColor:"var(--border)"},children:[e.jsx("div",{className:"font-mono text-sm",children:n.code}),e.jsxs("div",{className:"text-xs opacity-70",children:["created: ",new Date(n.createdAt).toLocaleString()]}),e.jsx("div",{className:"text-xs opacity-80",children:g?`by: ${n.createdByName||((y=n.createdBy)==null?void 0:y.slice(0,8))}`:"by: you"}),e.jsx("div",{className:"text-xs",children:n.note||""}),e.jsx("div",{className:"text-xs",children:n.usedBy?e.jsx("span",{className:"text-emerald-400",children:"used"}):e.jsx("span",{className:"opacity-70",children:"unused"})}),e.jsx("div",{className:"text-right",children:e.jsx("button",{className:"btn",onClick:()=>N(n.code),children:"Delete"})})]},`${n.code}-${n.createdAt}`)}),!o.length&&e.jsx("div",{className:"text-sm opacity-70",children:"No invite codes yet."})]})]})}function K(){const[s,p]=m.useState("invite");m.useEffect(()=>{(async()=>{try{const l=await U();p((l==null?void 0:l.registrationMode)||"invite")}catch{}})()},[]);const o=()=>{confirm("Reset the forum (keep it empty)?")&&(C(j()),alert("Done. Forum was cleared."),location.reload())};return e.jsxs("div",{className:"card p-4",children:[e.jsx("div",{className:"mb-2 font-semibold",children:"Registration settings"}),e.jsxs("div",{className:"mb-3 flex items-center gap-2",children:[e.jsx("span",{className:"text-sm opacity-70",children:"Registration:"}),e.jsxs("select",{className:"input",value:s,onChange:async l=>{const r=l.target.value;p(r);try{await O({registrationMode:r})}catch(x){alert((x==null?void 0:x.message)||"Failed")}},children:[e.jsx("option",{value:"invite",children:"Invite only"}),e.jsx("option",{value:"open",children:"Open"})]})]}),e.jsx("div",{className:"mb-2 font-semibold",children:"Maintenance"}),e.jsx("p",{className:"mb-3 text-sm opacity-70",children:"Reset the forum when you need a clean slate before inviting the community."}),e.jsx("button",{className:"btn btn-primary",onClick:o,children:"Reset forum (empty)"})]})}export{se as default};
