import{j as e}from"./index-N9yhZYnV.js";import{R as m}from"./react-vendor-DTkXckhQ.js";import{r as C}from"./forumStore-DezKITpg.js";import{l as S,b as I,i as F,j as M,k as D,h as w,m as T,n as _}from"./forumRemote-BYvX5m8l.js";import{g as B,d as E,e as A,f as U,h as O,s as R,i as P,j as W,m as $,k as L,n as q,o as G}from"./authRemote-D9Q-aZvG.js";import"./icons-pv2MHu2Z.js";function N(){try{const s=localStorage.getItem("forum:session")??sessionStorage.getItem("forum:session"),u=s?JSON.parse(s):null;return(u==null?void 0:u.userId)||"unknown"}catch{return"unknown"}}function se(){const[s,u]=m.useState("users"),[c,o]=m.useState(null);m.useEffect(()=>{(async()=>{try{o(await B())}catch{o(null)}})()},[]);const p=c==null?void 0:c.role,d=!!(c!=null&&c.owner),x=d||p==="developer"?["users","sections","topics","invites","maintenance"]:p==="admin"?["users","topics","invites"]:p==="moderator"?["users","invites"]:["topics"];return e.jsxs("div",{className:"mx-auto w-full max-w-5xl px-4 py-6",children:[e.jsx("div",{className:"mb-4 flex gap-2",children:x.map(h=>e.jsx("button",{className:`btn ${s===h?"btn-primary":""}`,onClick:()=>u(h),children:h},h))}),s==="users"&&e.jsx(J,{meRole:p,meId:c==null?void 0:c.id,meOwner:d}),s==="sections"&&e.jsx(Q,{}),s==="topics"&&e.jsx(z,{meRole:p}),s==="invites"&&e.jsx(H,{meRole:p,meId:(c==null?void 0:c.id)||""}),s==="maintenance"&&e.jsx(K,{})]})}function J({meRole:s,meId:u,meOwner:c}){const[o,p]=m.useState([]),d=m.useCallback(async()=>{try{p(await E())}catch(t){alert((t==null?void 0:t.message)||"Failed to load users")}},[]);m.useEffect(()=>{d()},[d]);const x=c||s==="developer",h=c||s==="developer"||s==="admin",v=c||s==="developer"||s==="admin"||s==="moderator",j=async(t,a)=>{if(x)try{await R(t,a),d()}catch(f){alert((f==null?void 0:f.message)||"Failed to set role")}},r=async t=>{if(!v)return;const a=parseInt(prompt("Mute minutes","60")||"60",10),f=new Date(Date.now()+Math.max(1,a)*6e4).toISOString();try{await $(t,f),await d()}catch(y){alert((y==null?void 0:y.message)||"Failed to mute")}},g=async t=>{if(v)try{await L(t),await d()}catch(a){alert((a==null?void 0:a.message)||"Failed to unmute")}},i=async t=>{if(!h)return;const a=parseInt(prompt("Ban days","7")||"7",10),f=new Date(Date.now()+Math.max(1,a)*864e5).toISOString();try{await q(t,f),await d()}catch(y){alert((y==null?void 0:y.message)||"Failed to ban")}},l=async t=>{if(h)try{await G(t),await d()}catch(a){alert((a==null?void 0:a.message)||"Failed to unban")}};return e.jsxs("div",{className:"card p-4",children:[e.jsx("div",{className:"mb-3 text-sm opacity-70",children:"Remote accounts fetched from the Worker API. Use this panel to adjust roles and moderation privileges."}),e.jsxs("div",{className:"grid gap-2",children:[o.map(t=>{const a=Number(t.userNumber||0)===1,f=String(t.role||"user"),y=[];v&&!a&&(y.push(e.jsx("button",{className:"btn",onClick:()=>r(t.id),children:"Mute"},"mute")),y.push(e.jsx("button",{className:"btn",onClick:()=>g(t.id),children:"Unmute"},"unmute"))),h&&!a&&(y.push(e.jsx("button",{className:"btn",onClick:()=>i(t.id),children:"Ban"},"ban")),y.push(e.jsx("button",{className:"btn",onClick:()=>l(t.id),children:"Unban"},"unban")));const n=a?"OWNER":s==="developer"?t.invitedByName?`invited by: ${t.invitedByName}`:"":u&&t.invitedById&&t.invitedById===u?"invited by: you":"";return e.jsxs("div",{className:"grid grid-cols-1 items-center gap-3 rounded-xl border px-3 py-2 sm:grid-cols-[80px_1fr_1fr_220px_auto]",style:{borderColor:"var(--border)"},children:[e.jsxs("div",{className:"text-xs opacity-70",children:["#",t.userNumber]}),e.jsx("div",{className:"font-semibold",children:t.username}),e.jsx("div",{className:"text-sm opacity-80 truncate",children:c||s==="developer"?t.email:""}),e.jsx("div",{className:"text-xs opacity-70",children:n}),e.jsxs("div",{className:"flex flex-wrap items-center justify-end gap-2",children:[x&&!a||a&&u===t.id?e.jsxs("select",{className:"input",value:t.role,onChange:b=>j(t.id,b.target.value),children:[e.jsx("option",{value:"developer",children:"developer"}),e.jsx("option",{value:"admin",children:"admin"}),e.jsx("option",{value:"moderator",children:"moderator"}),e.jsx("option",{value:"vip",children:"vip"}),e.jsx("option",{value:"user",children:"user"}),e.jsx("option",{value:"newbie",children:"newbie"})]}):e.jsx("span",{className:"rounded-full border px-2 py-1 text-xs uppercase tracking-wider",style:{borderColor:"var(--border)"},children:a?"OWNER":f}),y.length?y:null]})]},t.id)}),!o.length&&e.jsx("div",{className:"text-sm opacity-70",children:"No users yet."})]})]})}function Q(){const[s,u]=m.useState([]),[c,o]=m.useState(""),[p,d]=m.useState(""),x=m.useCallback(async()=>{try{u(await S())}catch(r){alert((r==null?void 0:r.message)||"Failed to load sections")}},[]);m.useEffect(()=>{x()},[x]);const h=async()=>{if(c.trim())try{await F({title:c.trim(),description:p.trim(),actorId:N()}),o(""),d(""),x()}catch(r){alert((r==null?void 0:r.message)||"Failed to create section")}},v=async(r,g,i)=>{try{await M(r,{[g]:i,actorId:N()}),x()}catch(l){alert((l==null?void 0:l.message)||"Failed to update section")}},j=async r=>{if(confirm("Delete this section?"))try{await D(r),x()}catch(g){alert((g==null?void 0:g.message)||"Failed")}};return e.jsxs("div",{className:"grid gap-4",children:[e.jsxs("div",{className:"card p-4",children:[e.jsx("div",{className:"mb-2 font-semibold",children:"Create section"}),e.jsxs("div",{className:"grid gap-2 sm:grid-cols-[1fr_1fr_auto]",children:[e.jsx("input",{className:"input",placeholder:"Title",value:c,onChange:r=>o(r.target.value)}),e.jsx("input",{className:"input",placeholder:"Description",value:p,onChange:r=>d(r.target.value)}),e.jsx("button",{className:"btn btn-primary",onClick:h,children:"Add"})]})]}),e.jsxs("div",{className:"card p-4",children:[e.jsx("div",{className:"mb-2 font-semibold",children:"Sections"}),e.jsxs("div",{className:"grid gap-2",children:[s.map(r=>e.jsxs("div",{className:"grid grid-cols-1 items-center gap-2 rounded-xl border px-3 py-2 sm:grid-cols-[160px_1fr_1fr_auto]",style:{borderColor:"var(--border)"},children:[e.jsxs("div",{className:"text-xs opacity-70",children:[r.id.slice(0,8),":"]}),e.jsx("input",{className:"input",value:r.title,onChange:g=>v(r.id,"title",g.target.value)}),e.jsx("input",{className:"input",value:r.description||"",onChange:g=>v(r.id,"description",g.target.value)}),e.jsx("div",{className:"text-right",children:e.jsx("button",{className:"btn",onClick:()=>j(r.id),children:"Delete"})})]},r.id)),!s.length&&e.jsx("div",{className:"text-sm opacity-70",children:"No sections yet."})]})]})]})}function z({meRole:s}){const[u,c]=m.useState([]),o=m.useCallback(async()=>{try{c(await I())}catch(i){alert((i==null?void 0:i.message)||"Failed to load topics")}},[]);m.useEffect(()=>{o()},[o]);const p=s==="developer",d=s==="developer",x=s==="developer",h=s==="developer"||s==="admin",v=async(i,l)=>{if(p)try{await w(i,{pinned:l,actorId:N()}),o()}catch(t){alert((t==null?void 0:t.message)||"Failed to update topic")}},j=async(i,l)=>{if(d)try{await w(i,{locked:l,actorId:N()}),o()}catch(t){alert((t==null?void 0:t.message)||"Failed to update topic")}},r=async i=>{if(!x)return;const t=(prompt("Move to section ID","")||"").trim();if(t)try{await T(i,t),o()}catch(a){alert((a==null?void 0:a.message)||"Failed to move topic")}},g=async i=>{if(h&&confirm("Delete this topic?"))try{await _(i),o()}catch(l){alert((l==null?void 0:l.message)||"Failed to delete")}};return e.jsxs("div",{className:"card p-4",children:[e.jsx("div",{className:"mb-2 font-semibold",children:"Topics"}),e.jsxs("div",{className:"grid gap-2",children:[u.map(i=>{const l=[];return p&&l.push(e.jsxs("label",{className:"flex items-center gap-2 text-sm",children:[e.jsx("input",{type:"checkbox",checked:!!i.pinned,onChange:t=>v(i.id,t.target.checked)}),"pinned"]},"pin")),d&&l.push(e.jsxs("label",{className:"flex items-center gap-2 text-sm",children:[e.jsx("input",{type:"checkbox",checked:!!i.locked,onChange:t=>j(i.id,t.target.checked)}),"locked"]},"lock")),x&&l.push(e.jsx("button",{className:"btn",onClick:()=>r(i.id),children:"Move"},"move")),h&&l.push(e.jsx("button",{className:"btn",onClick:()=>g(i.id),children:"Delete"},"delete")),e.jsxs("div",{className:"grid grid-cols-1 items-start gap-3 rounded-xl border px-3 py-3 sm:grid-cols-[1fr_auto]",style:{borderColor:"var(--border)"},children:[e.jsxs("div",{children:[e.jsx("div",{className:"font-semibold",children:i.title}),e.jsxs("div",{className:"text-xs opacity-70",children:["id: ",i.id.slice(0,8),": section: ",i.sectionId.slice(0,8),":"]}),(i.pinned||i.locked)&&e.jsxs("div",{className:"mt-1 flex flex-wrap gap-2 text-[10px] uppercase tracking-[0.2em] opacity-70",children:[i.pinned&&e.jsx("span",{children:"pinned"}),i.locked&&e.jsx("span",{children:"locked"})]})]}),l.length?e.jsx("div",{className:"flex flex-wrap items-center justify-end gap-2",children:l}):null]},i.id)}),!u.length&&e.jsx("div",{className:"text-sm opacity-70",children:"No topics yet."})]})]})}function H({meRole:s,meId:u}){const[c,o]=m.useState([]),[p,d]=m.useState(5),[x,h]=m.useState(""),v=s==="developer",j=m.useCallback(async()=>{try{const n=await A(),b=v?n:n.filter(k=>(k.createdBy||"")===(u||""));o(b)}catch(n){alert((n==null?void 0:n.message)||"Failed")}},[v,u]);m.useEffect(()=>{j()},[j]);const r=Date.now(),g=s==="admin"?48*3600*1e3:s==="moderator"?72*3600*1e3:0,i=g?r-g:0,l=c.filter(n=>{const b=new Date(n.createdAt).getTime();return!isNaN(b)&&b>=i}),a=Math.max(0,(s==="admin"?2:s==="moderator"?1:1/0)-l.length),f=async()=>{try{const n=Math.max(1,Math.min(20,p)),b=isFinite(a)?Math.min(a,n):n;if(!v&&b<=0){alert("Invite quota reached. Try again later.");return}await P(b,x||void 0),h(""),j()}catch(n){alert((n==null?void 0:n.message)||"Failed to generate")}},y=async n=>{if(confirm("Delete this invite?"))try{await W(n),j()}catch(b){alert((b==null?void 0:b.message)||"Failed")}};return e.jsxs("div",{className:"card p-4",children:[e.jsx("div",{className:"mb-3 font-semibold",children:"Invite codes"}),e.jsxs("div",{className:"mb-4 grid gap-2 sm:grid-cols-[120px_1fr_auto]",children:[e.jsx("input",{className:"input",type:"number",min:1,max:Math.min(20,isFinite(a)?Math.max(a,0):20),value:p,onChange:n=>d(parseInt(n.target.value||"1",10))}),e.jsx("input",{className:"input",placeholder:"note (optional)",value:x,onChange:n=>h(n.target.value)}),e.jsx("button",{className:"btn btn-primary",onClick:f,disabled:!v&&a<=0,title:!v&&a<=0?"Quota reached":void 0,children:"Generate"})]}),!v&&e.jsxs("div",{className:"mb-4 text-xs opacity-70",children:[s==="admin"&&e.jsxs("span",{children:["Remaining in 48h window: ",e.jsx("b",{children:a})," of 2"]}),s==="moderator"&&e.jsxs("span",{children:["Remaining in 72h window: ",e.jsx("b",{children:a})," of 1"]})]}),e.jsxs("div",{className:"grid gap-2",children:[c.map(n=>{var b;return e.jsxs("div",{className:"grid grid-cols-1 items-center gap-2 rounded-xl border px-3 py-2 sm:grid-cols-[160px_1fr_1fr_1fr_auto]",style:{borderColor:"var(--border)"},children:[e.jsx("div",{className:"font-mono text-sm",children:n.code}),e.jsxs("div",{className:"text-xs opacity-70",children:["created: ",new Date(n.createdAt).toLocaleString()]}),e.jsx("div",{className:"text-xs opacity-80",children:v?`by: ${n.createdByName||((b=n.createdBy)==null?void 0:b.slice(0,8))}`:"by: you"}),e.jsx("div",{className:"text-xs",children:n.note||""}),e.jsx("div",{className:"text-xs",children:n.usedBy?e.jsx("span",{className:"text-emerald-400",children:"used"}):e.jsx("span",{className:"opacity-70",children:"unused"})}),e.jsx("div",{className:"text-right",children:e.jsx("button",{className:"btn",onClick:()=>y(n.code),children:"Delete"})})]},`${n.code}-${n.createdAt}`)}),!c.length&&e.jsx("div",{className:"text-sm opacity-70",children:"No invite codes yet."})]})]})}function K(){const[s,u]=m.useState("invite");m.useEffect(()=>{(async()=>{try{const o=await U();u((o==null?void 0:o.registrationMode)||"invite")}catch{}})()},[]);const c=()=>{confirm("Reset the forum (keep it empty)?")&&(C(N()),alert("Done. Forum was cleared."),location.reload())};return e.jsxs("div",{className:"card p-4",children:[e.jsx("div",{className:"mb-2 font-semibold",children:"Registration settings"}),e.jsxs("div",{className:"mb-3 flex items-center gap-2",children:[e.jsx("span",{className:"text-sm opacity-70",children:"Registration:"}),e.jsxs("select",{className:"input",value:s,onChange:async o=>{const p=o.target.value;u(p);try{await O({registrationMode:p})}catch(d){alert((d==null?void 0:d.message)||"Failed")}},children:[e.jsx("option",{value:"invite",children:"Invite only"}),e.jsx("option",{value:"open",children:"Open"})]})]}),e.jsx("div",{className:"mb-2 font-semibold",children:"Maintenance"}),e.jsx("p",{className:"mb-3 text-sm opacity-70",children:"Reset the forum when you need a clean slate before inviting the community."}),e.jsx("button",{className:"btn btn-primary",onClick:c,children:"Reset forum (empty)"})]})}export{se as default};
