import{j as s}from"./index-BBBHUoXu.js";import{u as M,R as c,L as j}from"./react-vendor-DTkXckhQ.js";import{g as B}from"./authRemote-D9Q-aZvG.js";import{g as D,e as b,b as $,u as w,t as Q,f as U,h as V}from"./forumRemote-B4nbC4GM.js";import{M as N}from"./MarkdownEditor-DbDpl5HJ.js";import{R as F}from"./ReactionBar-klKcSUrc.js";import{s as v}from"./seo-CqyG8vOX.js";import{ab as K,Q as O,ae as X,X as q}from"./icons-CI_uwdm-.js";import"./purify.es-DnfDK_hS.js";function se(){const{id:m=""}=M(),[a,k]=c.useState(null),[t,S]=c.useState(null),[P,o]=c.useState([]),[p,C]=c.useState([]),[y,u]=c.useState(""),[A,x]=c.useState(null),[I,h]=c.useState(""),f=!!a&&(a.role==="developer"||a.role==="admin"||a.role==="moderator");c.useEffect(()=>{(async()=>{try{k(await B())}catch{}try{const e=await D(m);if(e){S(e);try{v(`${e.title} — Тема`,e.title)}catch{}}const i=await b(m);o(Array.isArray(i)?i:[])}catch{}try{const e=await $();C(Array.isArray(e)?e:[])}catch{}})()},[m]);async function L(){const e=y.trim();if(!(!e||!a||!t||t.locked))try{const i=await U({topicId:t.id,content:e});o(r=>[...r,i]),u("")}catch{}}async function R(e){if(f)try{const i=await w(e.id,{pinned:!e.pinned});o(r=>r.map(n=>n.id===e.id?i:n))}catch{}}async function T(e){try{await V(e.id),o(i=>i.filter(r=>r.id!==e.id))}catch{}}c.useEffect(()=>{if(t)try{const e={"@context":"https://schema.org","@type":"DiscussionForumPosting",headline:t.title,datePublished:t.createdAt,dateModified:t.updatedAt};v(void 0,t.title,e)}catch{}},[t==null?void 0:t.id]);function z(e,i){const r=new Set(String(e.title||"").toLowerCase().split(/[^\p{L}\p{N}]+/u).filter(Boolean)),n=new Set(String(i.title||"").toLowerCase().split(/[^\p{L}\p{N}]+/u).filter(Boolean));if(!r.size||!n.size)return 0;let l=0;for(const E of n)r.has(E)&&l++;const d=r.size+n.size-l;return d?l/d:0}const g=c.useMemo(()=>t?(p||[]).filter(e=>e.id!==t.id&&e.sectionId===t.sectionId).map(e=>({t:e,s:z(t,e)})).filter(e=>e.s>0).sort((e,i)=>i.s-e.s).slice(0,5).map(e=>e.t):[],[p,t==null?void 0:t.id,t==null?void 0:t.sectionId,t==null?void 0:t.title]);return s.jsx("main",{className:"min-h-screen",style:{background:"#0d0d12",color:"#f8fafc"},children:s.jsxs("div",{className:"mx-auto max-w-5xl px-4 py-6",children:[s.jsxs("div",{className:"mb-4 flex items-center gap-3",children:[s.jsxs(j,{to:"/forum",className:"btn flex items-center gap-2",children:[s.jsx(K,{size:16})," Back"]}),s.jsx("div",{className:"text-sm opacity-70",children:"Topic"}),s.jsx("div",{className:"font-semibold truncate",children:(t==null?void 0:t.title)||"..."}),s.jsxs("div",{className:"ml-auto text-xs opacity-70",children:["Replies ",(t==null?void 0:t.replyCount)??0," • Views ",(t==null?void 0:t.viewCount)??0]})]}),s.jsx("div",{className:"card p-4",children:s.jsxs("div",{className:"grid gap-3",children:[P.slice().sort((e,i)=>(i.pinned?1:0)-(e.pinned?1:0)||new Date(e.createdAt).getTime()-new Date(i.createdAt).getTime()).map(e=>{const i=!!a&&a.id===e.authorId,r=A===e.id;return s.jsxs("div",{className:"rounded-xl border border-white/10 bg-white/[0.04] p-3 text-sm",children:[e.pinned&&s.jsx("span",{className:"mr-2 inline-block rounded bg-white/10 px-2 py-0.5 text-xs",children:"Pinned"}),r?s.jsx(N,{value:I,onChange:h,onSubmit:async n=>{h(n),o(l=>l.map(d=>d.id===e.id?{...d,content:n,editedAt:new Date().toISOString()}:d)),x(null);try{await w(e.id,{content:n})}catch{}},submitLabel:"Save"}):s.jsx("div",{className:"prose prose-invert max-w-none whitespace-pre-wrap",children:e.content}),!r&&s.jsxs("div",{className:"mt-2 flex items-center gap-2",children:[s.jsxs("button",{className:"btn text-xs",title:"Цитировать",onClick:()=>u(n=>n+`

> ${e.content}

`),children:[s.jsx(O,{size:14})," Quote"]}),s.jsxs("button",{className:"btn text-xs",onClick:async()=>{try{const n=await Q(e.id);o(l=>l.map(d=>d.id===e.id?n:d))}catch{}},children:["❤️ ",(e.likes||[]).length]}),i&&s.jsxs("button",{className:"btn text-xs",onClick:()=>{x(e.id),h(e.content)},title:"Edit",children:[s.jsx(X,{size:14})," Edit"]})]}),r&&s.jsx("div",{className:"mt-2 flex items-center justify-end",children:s.jsxs("button",{className:"btn",onClick:()=>x(null),children:[s.jsx(q,{size:14})," Cancel"]})}),s.jsx(F,{postId:e.id,currentUserId:a==null?void 0:a.id,onPostUpdated:async()=>{try{const n=await b(m);o(Array.isArray(n)?n:[])}catch{}}}),(f||(a==null?void 0:a.id)===e.authorId)&&s.jsxs("div",{className:"mt-2 text-right",children:[f&&s.jsx("button",{className:"btn text-xs",onClick:()=>R(e),style:{marginRight:8},children:e.pinned?"Unpin":"Pin"}),s.jsx("button",{className:"btn text-xs",onClick:()=>T(e),children:"Delete"})]})]},e.id)}),!(t!=null&&t.locked)&&a&&s.jsx(N,{value:y,onChange:u,onSubmit:()=>L(),placeholder:"Reply in Markdown...",submitLabel:"Send",draftKey:t?`forum:draft:${t.id}`:void 0}),(t==null?void 0:t.locked)&&s.jsx("div",{className:"text-xs opacity-70",children:"Topic is locked."})]})}),g.length>0&&s.jsxs("div",{className:"card mt-4 p-4",children:[s.jsx("div",{className:"mb-2 text-xs uppercase tracking-[0.28em] text-zinc-400/80",children:"Похожие темы"}),s.jsx("div",{className:"grid gap-2",children:g.map(e=>s.jsxs(j,{to:`/forum/topic/${e.id}`,className:"flex items-center justify-between rounded-lg border border-white/10 bg-white/[0.03] px-3 py-2 hover:bg-white/[0.06]",children:[s.jsx("div",{className:"min-w-0 truncate font-medium",children:e.title}),s.jsxs("div",{className:"ml-2 shrink-0 text-xs opacity-70",children:["Ответов ",e.replyCount]})]},e.id))})]})]})})}export{se as default};
