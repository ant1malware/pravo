import{j as t}from"./index-BBBHUoXu.js";import{R as c,L as U}from"./react-vendor-DTkXckhQ.js";import{g as M}from"./authRemote-D9Q-aZvG.js";import{l as E,b as I,e as w,h as B,d as F,f as O,i as N,u as Q}from"./forumRemote-B4nbC4GM.js";import{M as k}from"./MarkdownEditor-DbDpl5HJ.js";import{R as q}from"./ReactionBar-klKcSUrc.js";import{af as V,ag as $,ah as G,L as H}from"./icons-CI_uwdm-.js";import"./purify.es-DnfDK_hS.js";function te(){const[a,v]=c.useState(null),[l,P]=c.useState(null),[u,d]=c.useState([]),[x,C]=c.useState(null),[h,o]=c.useState({}),[m,f]=c.useState(""),[j,b]=c.useState(""),[p,y]=c.useState(null);c.useEffect(()=>{(async()=>{try{const e=await M();v(e)}catch{}try{const s=(await E()).find(i=>(i.title||"").toLowerCase()==="questions"||(i.title||"").toLowerCase()==="вопросы");if(P(s||null),s){const i=await I(s.id);d(i)}}catch{}})()},[]);async function S(e){if(C(x===e.id?null:e.id),!h[e.id])try{const s=await w(e.id);o(i=>({...i,[e.id]:s}))}catch{}}const r=a&&(a.role==="admin"||a.role==="moderator"||a.role==="developer");async function L(){if(!(!a||!l))try{const e=j+(p?`

![attachment](${p})`:""),s=await F({sectionId:l.id,title:m.trim(),content:e});d([s,...u]),f(""),b(""),y(null)}catch{}}function R(e){var n;const s=(n=e.target.files)==null?void 0:n[0];if(!s)return;const i=new FileReader;i.onload=()=>y(String(i.result||"")),i.readAsDataURL(s)}async function T(e,s){if(a&&s.trim())try{const i=await O({topicId:e,content:s.trim()});o(n=>({...n,[e]:[...n[e]||[],i]}))}catch{}}async function z(e){try{const s=await N(e.id,{locked:!e.locked});d(i=>i.map(n=>n.id===e.id?s:n))}catch{}}async function A(e){try{const s=await N(e.id,{pinned:!e.pinned});d(i=>i.map(n=>n.id===e.id?s:n))}catch{}}async function D(e,s){if(r)try{const i=await Q(s.id,{pinned:!s.pinned});o(n=>({...n,[e]:(n[e]||[]).map(g=>g.id===s.id?i:g)}))}catch{}}return t.jsx("main",{className:"min-h-screen",style:{background:"#0d0d12",color:"#f8fafc"},children:t.jsxs("div",{className:"mx-auto max-w-5xl px-4 py-6",children:[t.jsxs("div",{className:"mb-4 flex items-center justify-between",children:[t.jsx("h1",{className:"text-2xl font-extrabold",children:"Вопросы"}),t.jsx(U,{to:"/forum",className:"btn",children:"Назад"})]}),!l&&t.jsx("div",{className:"card p-4 text-sm text-zinc-300",children:"Раздел «Вопросы» не найден. Создайте раздел «Questions» (или «Вопросы») и перезагрузите."}),a&&l&&t.jsxs("div",{className:"card p-4 mb-6",children:[t.jsx("div",{className:"text-xs uppercase tracking-[0.28em] text-zinc-400/80 mb-2",children:"Новая тема"}),t.jsx("input",{className:"input mb-2",placeholder:"Короткий заголовок",value:m,onChange:e=>f(e.target.value)}),t.jsx(k,{value:j,onChange:b,placeholder:"Опишите вопрос подробнее..."}),t.jsxs("div",{className:"mt-2 flex items-center gap-2",children:[t.jsxs("label",{className:"btn inline-flex items-center gap-2",children:[t.jsx(V,{size:16})," Прикрепить изображение",t.jsx("input",{type:"file",accept:"image/*",hidden:!0,onChange:R})]}),p&&t.jsx("span",{className:"text-xs opacity-80",children:"Изображение прикреплено"}),t.jsx("button",{className:"btn btn-primary ml-auto",onClick:L,disabled:!m.trim(),children:"Опубликовать"})]})]}),t.jsx("div",{className:"grid gap-3",children:u.map(e=>t.jsxs("div",{className:"card p-4",children:[t.jsxs("div",{className:"flex items-center justify-between",children:[t.jsxs("button",{className:"text-left font-semibold hover:underline",onClick:()=>S(e),children:[e.pinned&&t.jsx("span",{className:"mr-2 inline-block rounded bg-white/10 px-2 py-0.5 text-xs",children:"Pinned"}),e.title]}),r&&t.jsxs("div",{className:"flex gap-2",children:[t.jsx("button",{className:"btn",onClick:()=>A(e),title:e.pinned?"Открепить":"Закрепить",children:t.jsx($,{size:16})}),t.jsx("button",{className:"btn",onClick:()=>z(e),title:e.locked?"Открыть":"Закрыть",children:e.locked?t.jsx(G,{size:16}):t.jsx(H,{size:16})})]})]}),t.jsxs("div",{className:"mt-1 text-xs opacity-70",children:["Replies ",e.replyCount," • Views ",e.viewCount," • Updated ",new Date(e.updatedAt).toLocaleString()]}),x===e.id&&t.jsxs("div",{className:"mt-3 grid gap-3",children:[(h[e.id]||[]).slice().sort((s,i)=>(i.pinned?1:0)-(s.pinned?1:0)||new Date(s.createdAt).getTime()-new Date(i.createdAt).getTime()).map(s=>t.jsxs("div",{className:"rounded-xl border border-white/10 bg-white/[0.04] p-3 text-sm",children:[s.pinned&&t.jsx("span",{className:"mr-2 inline-block rounded bg-white/10 px-2 py-0.5 text-xs",children:"Pinned"}),t.jsx("div",{className:"prose prose-invert max-w-none whitespace-pre-wrap",children:s.content}),t.jsx(q,{postId:s.id,currentUserId:a==null?void 0:a.id,onPostUpdated:async()=>{try{const i=await w(e.id);o(n=>({...n,[e.id]:i}))}catch{}}}),(r||a&&a.id===s.authorId)&&t.jsxs("div",{className:"mt-2 text-right",children:[r&&t.jsx("button",{className:"btn text-xs",onClick:()=>D(e.id,s),style:{marginRight:8},children:s.pinned?"Unpin reply":"Pin reply"}),t.jsx("button",{className:"btn text-xs",onClick:async()=>{try{await B(s.id),o(i=>({...i,[e.id]:(i[e.id]||[]).filter(n=>n.id!==s.id)}))}catch{}},children:"Delete"})]})]},s.id)),!e.locked&&a&&t.jsx(k,{value:"",onChange:()=>{},onSubmit:s=>T(e.id,s),placeholder:"Быстрый ответ...",submitLabel:"Ответить"}),e.locked&&t.jsx("div",{className:"text-xs opacity-70",children:"Тема закрыта."})]})]},e.id))})]})})}export{te as default};
