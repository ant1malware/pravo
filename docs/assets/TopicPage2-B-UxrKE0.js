import{c as $,j as i}from"./index-CYg9GIeh.js";import{u as z,R as l,L as v}from"./react-vendor-DTkXckhQ.js";import{getTopic as q,listPosts as N,listTopics as D,listSections as Q,updatePost as k,toggleLikePost as U,createPost as B,deletePost as O}from"./forumRemote-DZSWY5Uv.js";import{M as S}from"./MarkdownEditor-mR9YMl2X.js";import{R as V}from"./ReactionBar-DnVVuEeZ.js";import{ad as K,Q as X,ag as F,X as G}from"./icons-zK4tVMYI.js";import"./purify.es-DnfDK_hS.js";function H(a,s,r){try{a&&(document.title=a)}catch{}try{if(s!==void 0){let e=document.querySelector('meta[name="description"]');e||(e=document.createElement("meta"),e.name="description",document.head.appendChild(e)),e.content=s||""}}catch{}try{let o=document.getElementById("app-schema-jsonld");r||o&&o.remove()}catch{}}function J(a){try{const s=(r,e)=>{let o=document.querySelector(`meta[property="${r}"]`);o||(o=document.createElement("meta"),o.setAttribute("property",r),document.head.appendChild(o)),o.setAttribute("content",e)};if(a.title&&s("og:title",a.title),a.description!==void 0&&s("og:description",a.description||""),a.url&&s("og:url",a.url),a.image&&s("og:image",a.image),a.canonical){let r=document.querySelector('link[rel="canonical"]');r||(r=document.createElement("link"),r.rel="canonical",document.head.appendChild(r)),r.href=a.canonical}}catch{}}function se(){const{id:a=""}=z(),[s,r]=l.useState(null),[e,o]=l.useState(null),[C,m]=l.useState([]),[p,P]=l.useState([]),[j,A]=l.useState(""),[b,h]=l.useState(""),[E,x]=l.useState(null),[I,f]=l.useState(""),y=!!s&&(s.role==="developer"||s.role==="admin"||s.role==="moderator");l.useEffect(()=>{(async()=>{try{r(await $())}catch{}try{const t=await q(a);if(t){o(t);try{H(t.title,t.title)}catch{}}const n=await N(a);m(Array.isArray(n)?n:[])}catch{}try{const t=await D();P(Array.isArray(t)?t:[])}catch{}})()},[a]),l.useEffect(()=>{(async()=>{try{if(e!=null&&e.id){const t=`${window.location.origin}/forum/topic/${e.id}`;J({title:e.title,description:e.title,url:t,canonical:t})}}catch{}try{if(e!=null&&e.sectionId){const n=(await Q()||[]).find(d=>d.id===e.sectionId);n&&A(n.title||"")}}catch{}})()},[e==null?void 0:e.id,e==null?void 0:e.sectionId,e==null?void 0:e.title]);async function T(){const t=b.trim();if(!(!t||!s||!e||e.locked))try{const n=await B({topicId:e.id,content:t});m(d=>[...d,n]),h("")}catch{}}async function L(t){if(y)try{const n=await k(t.id,{pinned:!t.pinned});m(d=>d.map(c=>c.id===t.id?n:c))}catch{}}async function R(t){try{await O(t.id),m(n=>n.filter(d=>d.id!==t.id))}catch{}}const M=C.slice().sort((t,n)=>(n.pinned?1:0)-(t.pinned?1:0)||new Date(t.createdAt).getTime()-new Date(n.createdAt).getTime()),w=l.useMemo(()=>{if(!e)return[];const t=(e.title||"").toLowerCase();return p.filter(n=>n.id!==e.id&&(n.title||"").toLowerCase().includes(t.split(" ").slice(0,2).join(" "))).slice(0,5)},[p,e==null?void 0:e.id,e==null?void 0:e.title]);return i.jsx("main",{className:"min-h-screen",style:{background:"#0d0d12",color:"#f8fafc"},children:i.jsxs("div",{className:"mx-auto max-w-5xl px-4 py-6",children:[i.jsx("div",{className:"mb-4 flex items-center justify-between",children:i.jsxs("div",{className:"flex items-center gap-3",children:[i.jsxs(v,{to:"/forum",className:"btn flex items-center gap-2",children:[i.jsx(K,{size:16})," Назад"]}),i.jsx("div",{className:"text-sm opacity-70",children:j||"Тема"})]})}),i.jsxs("div",{className:"card p-4",children:[i.jsx("div",{className:"mb-1 text-xs opacity-70",children:j}),i.jsx("h1",{className:"text-xl font-bold text-white",children:(e==null?void 0:e.title)||"..."})]}),i.jsxs("div",{className:"mt-4 grid gap-3",children:[M.map(t=>{const n=!!s&&s.id===t.authorId,d=E===t.id;return i.jsxs("div",{className:"rounded-xl border border-white/10 bg-white/[0.04] p-3 text-sm",children:[t.pinned&&i.jsx("span",{className:"mr-2 inline-block rounded bg-white/10 px-2 py-0.5 text-xs",children:"Pinned"}),d?i.jsx(S,{value:I,onChange:f,onSubmit:async c=>{f(c),m(g=>g.map(u=>u.id===t.id?{...u,content:c,editedAt:new Date().toISOString()}:u)),x(null);try{await k(t.id,{content:c})}catch{}},submitLabel:"Save"}):i.jsx("div",{className:"prose prose-invert max-w-none whitespace-pre-wrap",children:t.content}),!d&&i.jsxs("div",{className:"mt-2 flex items-center gap-2",children:[i.jsxs("button",{className:"btn text-xs",title:"Цитировать",onClick:()=>h(c=>c+`

> ${t.content}

`),children:[i.jsx(X,{size:14})," Quote"]}),i.jsxs("button",{className:"btn text-xs",onClick:async()=>{try{const c=await U(t.id);m(g=>g.map(u=>u.id===t.id?c:u))}catch{}},children:["❤ ",(t.likes||[]).length]}),n&&i.jsxs("button",{className:"btn text-xs",onClick:()=>{x(t.id),f(t.content)},title:"Edit",children:[i.jsx(F,{size:14})," Edit"]})]}),d&&i.jsx("div",{className:"mt-2 flex items-center justify-end",children:i.jsxs("button",{className:"btn",onClick:()=>x(null),children:[i.jsx(G,{size:14})," Cancel"]})}),i.jsx(V,{postId:t.id,currentUserId:s==null?void 0:s.id,onPostUpdated:async()=>{try{const c=await N(a);m(Array.isArray(c)?c:[])}catch{}}}),(y||(s==null?void 0:s.id)===t.authorId)&&i.jsxs("div",{className:"mt-2 text-right",children:[y&&i.jsx("button",{className:"btn text-xs",onClick:()=>L(t),style:{marginRight:8},children:t.pinned?"Unpin":"Pin"}),i.jsx("button",{className:"btn text-xs",onClick:()=>R(t),children:"Delete"})]})]},t.id)}),!(e!=null&&e.locked)&&s&&i.jsx(S,{value:b,onChange:h,onSubmit:()=>T(),placeholder:"Reply in Markdown...",submitLabel:"Send",draftKey:e?`forum:draft:${e.id}`:void 0}),(e==null?void 0:e.locked)&&i.jsx("div",{className:"text-xs opacity-70",children:"Topic is locked."})]}),w.length>0&&i.jsxs("div",{className:"card mt-4 p-4",children:[i.jsx("div",{className:"mb-2 text-xs uppercase tracking-[0.28em] text-zinc-400/80",children:"Похожие темы"}),i.jsx("div",{className:"grid gap-2",children:w.map(t=>i.jsxs(v,{to:`/forum/topic/${t.id}`,className:"flex items-center justify-between rounded-lg border border-white/10 bg-white/[0.03] px-3 py-2 hover:bg-white/[0.06]",children:[i.jsx("div",{className:"min-w-0 truncate font-medium",children:t.title}),i.jsxs("div",{className:"ml-2 shrink-0 text-xs opacity-70",children:["ответов ",t.replyCount]})]},t.id))})]})]})})}export{se as default};
