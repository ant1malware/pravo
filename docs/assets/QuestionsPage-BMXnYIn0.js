import{b as $,m as F,j as t}from"./index-C5TXn_k8.js";import{R as c,L as h}from"./react-vendor-DTkXckhQ.js";import{listSections as O,listTopics as q,listPosts as v,deletePost as V,createTopic as G,createPost as H,updateTopic as k,updatePost as J}from"./forumRemote-D5s3MT8n.js";import{M as S}from"./MarkdownEditor-XXBrWTSU.js";import{R as K}from"./ReactionBar-swKW2WJe.js";import{a8 as W,a9 as C,aa as X,ab as Y,L as Z}from"./icons-CDjAZjRL.js";import"./purify.es-DnfDK_hS.js";function ce(){const[n,P]=c.useState(null),[r,L]=c.useState(null),[m,l]=c.useState([]),[f,z]=c.useState(null),[u,o]=c.useState({}),[x,j]=c.useState(""),[b,g]=c.useState(""),[p,y]=c.useState(null),R=e=>/\[\s*solved\s*\]/i.test(String(e||"")),[d,T]=c.useState({});c.useEffect(()=>{(async()=>{try{const e=await $();P(e)}catch{}try{const s=(await O()).find(i=>(i.title||"").toLowerCase()==="questions"||(i.title||"").toLowerCase()==="вопросы");if(L(s||null),s){const i=await q(s.id);l(i)}}catch{}try{const e=await F(),s={};for(const i of e)s[i.id]=i.username;T(s)}catch{}})()},[]);async function M(e){if(z(f===e.id?null:e.id),!u[e.id])try{const s=await v(e.id);o(i=>({...i,[e.id]:s}))}catch{}}const w=n&&(n.role==="admin"||n.role==="moderator"||n.role==="developer");async function A(){if(!(!n||!r))try{const e=b+(p?`

![attachment](${p})`:""),s=await G({sectionId:r.id,title:x.trim(),content:e});l([s,...m]),j(""),g(""),y(null)}catch{}}function I(e){var a;const s=(a=e.target.files)==null?void 0:a[0];if(!s)return;const i=new FileReader;i.onload=()=>y(String(i.result||"")),i.readAsDataURL(s)}async function D(e,s){if(n&&s.trim())try{const i=await H({topicId:e,content:s.trim()});o(a=>({...a,[e]:[...a[e]||[],i]}))}catch{}}async function U(e){try{const s=await k(e.id,{locked:!e.locked});l(i=>i.map(a=>a.id===e.id?s:a))}catch{}}async function B(e){try{const s=await k(e.id,{pinned:!e.pinned});l(i=>i.map(a=>a.id===e.id?s:a))}catch{}}async function E(e,s){try{const i=await J(s.id,{pinned:!s.pinned});o(a=>({...a,[e]:(a[e]||[]).map(N=>N.id===s.id?i:N)}))}catch{}}function Q(e){var i;return(u[e]||[]).some(a=>!!a.pinned)||R((i=m.find(a=>a.id===e))==null?void 0:i.title)}return t.jsx("main",{className:"min-h-screen",style:{background:"#0d0d12",color:"#f8fafc"},children:t.jsxs("div",{className:"mx-auto max-w-5xl px-4 py-6",children:[t.jsxs("div",{className:"mb-4 flex items-center justify-between",children:[t.jsx("h1",{className:"text-2xl font-extrabold",children:"Вопросы"}),t.jsx(h,{to:"/forum",className:"btn",children:"Назад"})]}),!r&&t.jsxs("div",{className:"card p-4 text-sm text-zinc-300",children:["Раздел ","<Questions>"," не найден. Создайте секцию ","<Questions>"," (или ","<Вопросы>",") и перезагрузите."]}),n&&r&&t.jsxs("div",{className:"card p-4 mb-6",children:[t.jsx("div",{className:"text-xs uppercase tracking-[0.28em] text-zinc-400/80 mb-2",children:"Новая тема"}),t.jsx("input",{className:"input mb-2",placeholder:"Короткий заголовок",value:x,onChange:e=>j(e.target.value)}),t.jsx(S,{value:b,onChange:g,placeholder:"Опишите вопрос подробнее..."}),t.jsxs("div",{className:"mt-2 flex items-center gap-2",children:[t.jsxs("label",{className:"btn inline-flex items-center gap-2",children:[t.jsx(W,{size:16})," Прикрепить изображение",t.jsx("input",{type:"file",accept:"image/*",hidden:!0,onChange:I})]}),p&&t.jsx("span",{className:"text-xs opacity-80",children:"Вложение добавлено"}),t.jsx("button",{className:"btn btn-primary ml-auto",onClick:A,disabled:!x.trim(),children:"Опубликовать"})]})]}),t.jsx("div",{className:"grid gap-3",children:m.map(e=>t.jsxs("div",{className:"card p-4",children:[t.jsxs("div",{className:"flex items-center justify-between",children:[t.jsxs("button",{className:"text-left font-semibold hover:underline",onClick:()=>M(e),children:[Q(e.id)&&t.jsxs("span",{className:"mr-2 inline-flex items-center gap-1 rounded bg-emerald-500/15 px-2 py-0.5 text-xs text-emerald-300",children:[t.jsx(C,{size:14})," Solved"]}),e.title]}),t.jsx("div",{className:"ml-3 text-xs text-zinc-400/80",children:t.jsx(h,{className:"hover:underline",to:`/forum/profile/${d[e.authorId]||""}`,children:d[e.authorId]||"user"})}),w&&t.jsxs("div",{className:"flex gap-2",children:[t.jsx("button",{className:"btn",onClick:()=>B(e),title:e.pinned?"Открепить":"Закрепить",children:t.jsx(X,{size:16})}),t.jsx("button",{className:"btn",onClick:()=>U(e),title:e.locked?"Открыть":"Закрыть",children:e.locked?t.jsx(Y,{size:16}):t.jsx(Z,{size:16})})]})]}),t.jsxs("div",{className:"mt-1 text-xs opacity-70",children:["Replies ",e.replyCount," • Views ",e.viewCount," • Updated ",new Date(e.updatedAt).toLocaleString()]}),f===e.id&&t.jsxs("div",{className:"mt-3 grid gap-3",children:[(u[e.id]||[]).slice().sort((s,i)=>(i.pinned?1:0)-(s.pinned?1:0)||new Date(s.createdAt).getTime()-new Date(i.createdAt).getTime()).map(s=>t.jsxs("div",{className:"rounded-xl border border-white/10 bg-white/[0.04] p-3 text-sm",children:[s.pinned&&t.jsxs("span",{className:"mr-2 inline-flex items-center gap-1 rounded bg-emerald-500/15 px-2 py-0.5 text-xs text-emerald-300",children:[t.jsx(C,{size:14})," Best answer"]}),t.jsx("div",{className:"mb-1 text-xs text-zinc-400/80",children:t.jsx(h,{className:"hover:underline",to:`/forum/profile/${d[s.authorId]||""}`,children:d[s.authorId]||"user"})}),t.jsx("div",{className:"prose prose-invert max-w-none whitespace-pre-wrap",children:s.content}),t.jsx(K,{postId:s.id,currentUserId:n==null?void 0:n.id,onPostUpdated:async()=>{try{const i=await v(e.id);o(a=>({...a,[e.id]:i}))}catch{}}}),(w||n&&n.id===e.authorId)&&t.jsxs("div",{className:"mt-2 text-right",children:[t.jsx("button",{className:"btn text-xs",onClick:()=>E(e.id,s),style:{marginRight:8},children:s.pinned?"Unmark best answer":"Mark best answer"}),t.jsx("button",{className:"btn text-xs",onClick:async()=>{try{await V(s.id),o(i=>({...i,[e.id]:(i[e.id]||[]).filter(a=>a.id!==s.id)}))}catch{}},children:"Delete"})]})]},s.id)),!e.locked&&n&&t.jsx(S,{value:"",onChange:()=>{},onSubmit:s=>D(e.id,s),placeholder:"Ответить...",submitLabel:"Отправить"}),e.locked&&t.jsx("div",{className:"text-xs opacity-70",children:"Тема закрыта."})]})]},e.id))})]})})}export{ce as default};
