import{c as ge,f as Je,h as be,j as t,k as Ve,m as We,n as me,s as Ge}from"./index-B5m3a0G1.js";import{u as Ke,R as d}from"./react-vendor-DTkXckhQ.js";import{f as we,g as ve,i as Re,c as Xe,u as Ye,a as _e}from"./forumHidden-Bfc6fJtN.js";import{B as qe,c as He}from"./Badge-vaFluK-D.js";import{a0 as Qe,a1 as Ze,a2 as et,a3 as ye,S as je,a4 as Ne,a5 as tt,a6 as Ee,a7 as st,M as at,a8 as nt,a9 as Se}from"./icons-D7Rqi-Bz.js";const H="forum:",pe=`${H}follows`,ze=`${H}profile_comments:`,rt=`${H}social-change`,ae=new Map,it={getItem:s=>ae.has(s)?ae.get(s):null,setItem:(s,e)=>void ae.set(s,e),removeItem:s=>void ae.delete(s)},j=(()=>{try{if(typeof window<"u"&&window.localStorage)return window.localStorage}catch{}return it})(),Pe=typeof window<"u";function oe(){return new Date().toISOString()}function fe(s,e){try{return s?JSON.parse(s):e}catch{return e}}function Fe(){try{const s=typeof crypto<"u"&&crypto.randomUUID?crypto.randomUUID():null;if(s)return s}catch{}return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,s=>{const e=Math.random()*16|0;return(s==="x"?e:e&3|8).toString(16)})}function S(s){if(Pe)try{window.dispatchEvent(new CustomEvent(rt,{detail:s}))}catch{}}Pe&&window.addEventListener("storage",s=>{s.key&&(s.key.startsWith(ze)||s.key===pe)&&S({key:s.key,type:"storage"})});function le(){return fe(j.getItem(pe),[])}function Ie(s){const e=new Set,n=[];for(const a of s){const r=`${a.followerId}=>${a.targetId}`;a.followerId!==a.targetId&&(e.has(r)||(e.add(r),n.push(a)))}try{j.setItem(pe,JSON.stringify(n))}catch{}S({scope:"follows"})}function ot(){try{const e=new URL(window.location.href),n=e.searchParams.get("api");if(n){localStorage.setItem("forum:api_base",n);try{e.searchParams.delete("api"),history.replaceState({},"",e.toString())}catch{}}const a=localStorage.getItem("forum:api_base");if(a)return a}catch{}return"https://notifications-worker.wizardiowhy.workers.dev/skyapi"}const Le=ot();function De(){try{return localStorage.getItem("forum:token")??sessionStorage.getItem("forum:token")}catch{return null}}async function C(s,e={}){const n=De(),a={"Content-Type":"application/json",...e.headers||{}};n&&(a.Authorization=`Bearer ${n}`);const r=await fetch(`${Le}${s}`,{...e,headers:a}),o=await r.text();let l={};try{l=o?JSON.parse(o):{}}catch{l={error:o||r.statusText}}if(!r.ok)throw new Error((l==null?void 0:l.error)||`${r.status} ${r.statusText}`);return l}function N(){return!!Le&&!!De()}function ne(s){if(N())try{const e=window.__socialRemoteFollowersCache||(window.__socialRemoteFollowersCache=new Map),n=e.get(s);if(n)return n;C(`/social/followers/${encodeURIComponent(s)}`).then(a=>{try{e.set(s,Array.isArray(a.followers)?a.followers:[]),S({scope:"follows",targetId:s})}catch{}})}catch{}return le().filter(e=>e.targetId===s).map(e=>e.followerId)}function lt(s,e){if(!s)return!1;if(N())try{const n=window.__socialRemoteFollowingCache||(window.__socialRemoteFollowingCache=new Map),a=n.get(s);if(a)return a.includes(e);C(`/social/following/${encodeURIComponent(s)}`).then(r=>{try{n.set(s,Array.isArray(r.following)?r.following:[]),S({scope:"follows",followerId:s})}catch{}})}catch{}return le().some(n=>n.followerId===s&&n.targetId===e)}function ct(s,e){if(!s||!e||s===e)return;if(N())try{C("/social/follow",{method:"POST",body:JSON.stringify({targetId:e})})}catch{}const n=le();n.some(a=>a.followerId===s&&a.targetId===e)||(n.push({followerId:s,targetId:e,createdAt:oe()}),Ie(n))}function dt(s,e){if(N())try{C("/social/unfollow",{method:"POST",body:JSON.stringify({targetId:e})})}catch{}const n=le().filter(a=>!(a.followerId===s&&a.targetId===e));Ie(n)}function Oe(s){return`${ze}${s}`}function xe(s){return s.map(e=>({id:e.id??Fe(),targetId:e.targetId,authorId:e.authorId,authorName:e.authorName,content:typeof e.content=="string"?e.content:"",createdAt:e.createdAt??oe(),parentId:e.parentId??null,updatedAt:e.updatedAt??null,edited:!!e.edited,deleted:!!e.deleted,deletedAt:e.deletedAt??null,deletedById:e.deletedById??null}))}function re(s){if(N())try{const a=window.__socialRemoteCommentsCache||(window.__socialRemoteCommentsCache=new Map),r=a.get(s);if(r)return r;C(`/profiles/${encodeURIComponent(s)}/comments`).then(o=>{try{const l=xe(Array.isArray(o.comments)?o.comments:[]);a.set(s,l),S({scope:"comments",targetId:s})}catch{}})}catch{}const e=j.getItem(Oe(s)),n=fe(e,[]);return xe(n)}function Te(s,e){try{j.setItem(Oe(s),JSON.stringify(e))}catch{}S({scope:"comments",targetId:s})}const mt=1e4;function ut(s,e){const n=`${H}last_post:${s}:${e}`,a=Number(j.getItem(n)||"0"),r=Date.now()-a>=mt;if(r)try{j.setItem(n,String(Date.now()))}catch{}return r}const ke=2e3;function P(s,e){const n=re(s),r=!1?n:n.filter(m=>!m.deleted);r.sort((m,f)=>m.createdAt<f.createdAt?1:-1);const o=Math.max(0,0);return r.slice(o,void 0)}function Me(s,e,n,a){const r=(n??"").trim();if(!r)throw new Error("Comment is empty");if(r.length>ke)throw new Error(`Comment too long (${r.length} > ${ke})`);if(!N()&&!ut(s,e))throw new Error("You are posting too fast. Please wait a bit.");if(N())try{C(`/profiles/${encodeURIComponent(s)}/comments`,{method:"POST",body:JSON.stringify({content:r,parentId:(a==null?void 0:a.parentId)||null})}).then(m=>{try{const f=window.__socialRemoteCommentsCache;if(f){const g=f.get(s)||[],h=xe(Array.isArray(m.comment)?m.comment:[m.comment]);f.set(s,[...h,...g]),S({scope:"comments",targetId:s})}}catch{}}).catch(()=>{})}catch{}if(a!=null&&a.parentId&&!re(s).find(f=>f.id===a.parentId))throw new Error("Parent comment not found");const o={id:Fe(),targetId:s,authorId:e,authorName:a==null?void 0:a.authorName,content:r,createdAt:oe(),parentId:(a==null?void 0:a.parentId)??null,updatedAt:null,edited:!1,deleted:!1,deletedAt:null,deletedById:null},l=re(s);return l.unshift(o),Te(s,l),o}function xt(s,e,n,a,r){return Me(s,e,a,{authorName:r,parentId:n})}function pt(s,e,n){if(N())try{C(`/profiles/${encodeURIComponent(s)}/comments/${encodeURIComponent(e)}`,{method:"DELETE"})}catch{}const a=re(s),r=a.findIndex(l=>l.id===e);if(r<0)return;const o=a[r];(o.authorId===n||s===n)&&(o.deleted||(a[r]={...o,content:"",deleted:!0,deletedAt:oe(),deletedById:n},Te(s,a)))}function Be(s){return`${H}comment_reactions:${s}`}function he(s){return fe(j.getItem(Be(s)),{})}function ft(s,e){try{j.setItem(Be(s),JSON.stringify(e))}catch{}S({scope:"reactions",targetId:s})}function ht(s){return he(s)}function gt(s,e,n){var a,r;return(r=(a=he(s)[e])==null?void 0:a.byUser)==null?void 0:r[n]}function bt(s,e,n,a){const r=he(s),o=r[e]||{counts:{like:0,smile:0,useful:0},byUser:{}},l=o.byUser[n];return l===a?(o.byUser[n]=void 0,o.counts[a]=Math.max(0,(o.counts[a]||0)-1)):(l&&(o.counts[l]=Math.max(0,(o.counts[l]||0)-1)),o.byUser[n]=a,o.counts[a]=(o.counts[a]||0)+1),r[e]=o,ft(s,r),o}const Ce={developer:{label:"Разработчик",color:"#22d3ee",glow:"from-cyan-400/35"},admin:{label:"Администратор",color:"#ef4444",glow:"from-rose-400/35"},moderator:{label:"Модератор",color:"#8b5cf6",glow:"from-violet-400/35"},vip:{label:"VIP",color:"#eab308",glow:"from-amber-400/35"},user:{label:"Участник",color:"#94a3b8",glow:"from-slate-300/30"},newbie:{label:"Новичок",color:"#22d3ee",glow:"from-cyan-400/35"}};function ue({value:s,label:e}){return t.jsxs("div",{className:`${b} text-center`,children:[t.jsx("div",{className:"text-3xl font-extrabold text-white",children:s}),t.jsx("div",{className:"mt-1 text-xs uppercase tracking-[0.3em] text-zinc-300/80",children:e})]})}function q({title:s,children:e,right:n}){return t.jsxs("div",{className:F,children:[t.jsxs("div",{className:"mb-3 flex items-center justify-between",children:[t.jsx("div",{className:"text-xs uppercase tracking-[0.3em] text-zinc-400/75",children:s}),n]}),e]})}function Ae({role:s}){const e=ie[s]??ie.user,n=e.Icon;return t.jsxs("span",{className:"relative inline-flex",children:[t.jsx("span",{className:`absolute -inset-[2px] rounded-full blur-md bg-gradient-to-r ${e.grad} opacity-50`}),t.jsxs("span",{className:"relative inline-flex items-center gap-2 rounded-full border border-white/10 bg-white/5 px-3.5 py-1.5 text-[11px] font-extrabold uppercase tracking-[0.22em] text-white shadow-[0_0_0_1px_rgba(255,255,255,0.06)_inset]",children:[t.jsx(n,{size:14,className:"opacity-90"}),e.label]})]})}function wt({role:s}){const e=ie[s]??ie.user;return t.jsx("span",{className:"rounded-full border border-white/15 bg-black/50 px-2 py-0.5 text-[10px] font-bold uppercase tracking-[0.18em] text-white backdrop-blur",style:{boxShadow:"0 0 16px rgba(255,255,255,0.08), inset 0 0 0 1px rgba(255,255,255,0.05)"},children:e.label})}const vt={Founder:"from-rose-500/25 to-rose-400/10 text-rose-200",Early:"from-sky-500/25 to-sky-400/10 text-sky-200",Contributor:"from-emerald-500/25 to-emerald-400/10 text-emerald-200",VIP:"from-amber-500/25 to-amber-400/10 text-amber-200",Designer:"from-violet-500/25 to-violet-400/10 text-violet-200"},F="rounded-3xl border border-white/10 bg-[#101321]/85 p-5 shadow-[0_40px_120px_-70px_rgba(15,23,42,0.9)] backdrop-blur",b="rounded-3xl border border-white/10 bg-white/[0.05] p-4 shadow-[0_30px_90px_-70px_rgba(15,23,42,0.85)] backdrop-blur",yt=new Intl.DateTimeFormat("ru-RU",{day:"2-digit",month:"long",year:"numeric"}),ie={owner:{label:"Owner",grad:"from-amber-400 via-rose-400 to-amber-400",Icon:Ne},developer:{label:"Developer",grad:"from-cyan-400 via-fuchsia-400 to-cyan-400",Icon:ye},admin:{label:"Admin",grad:"from-rose-400 via-amber-400 to-rose-400",Icon:je},moderator:{label:"Moderator",grad:"from-violet-400 via-sky-400 to-violet-400",Icon:tt},vip:{label:"Premium",grad:"from-amber-400 via-rose-400 to-amber-400",Icon:Ne},user:{label:"User",grad:"from-slate-300 via-slate-400 to-slate-300",Icon:je},newbie:{label:"Newbie",grad:"from-cyan-400 via-fuchsia-400 to-cyan-400",Icon:ye}};function $e(s){var w;const e=s.profile||{},n=s.stats||{},a=typeof n.posts=="number"?n.posts:0,r=typeof n.likes=="number"?n.likes:0,o=typeof n.topics=="number"?n.topics:0,l=s.lastActiveAt||s.lastSeenAt||s.lastOnlineAt||null,m=e.accentFrom||"#8b5cf6",f=e.accentTo||"#0ea5e9",g=e.avatarData||e.avatar||e.avatarUrl||void 0,h=e.bannerData||e.banner||e.bannerUrl||void 0,k=typeof((w=e.links)==null?void 0:w.website)=="string"&&e.links.website?String(e.links.website):void 0,v={bio:e.bio||"",signature:e.signature||"",links:k?{website:k}:{},accentFrom:m,accentTo:f,avatarData:g,bannerData:h,badges:Array.isArray(e.badges)?e.badges:[],privacy:{showEmail:!1,showStats:!0,showLinks:!0,allowComments:!0,showFollowers:!0,...e.privacy||{}}};Array.isArray(e.labels)&&(v.labels=e.labels);const p={id:s.user.id,username:s.user.username,email:s.user.email,createdAt:s.user.createdAt,role:s.user.role,userNumber:s.user.userNumber,posts:a,likes:r,topics:o,profile:v,bans:null,mutes:null};return typeof n.score=="number"&&(p.score=n.score),p.owner=!!s.user.owner,p.hidden=Re({id:s.user.id,userNumber:s.user.userNumber,owner:s.user.owner,hidden:s.hidden}),l&&(p.lastActiveAt=l),p}function jt({badges:s}){return!s||s.length===0?null:t.jsx("div",{className:"flex flex-wrap items-center gap-2",children:s.slice(0,3).map(e=>{const n=vt[e]||"from-white/20 to-white/5 text-zinc-200";return t.jsxs("span",{className:`inline-flex items-center gap-1 rounded-full border border-white/10 bg-gradient-to-br ${n} px-2.5 py-1 text-xs`,title:`Badge: ${e}`,children:[t.jsx(Ee,{size:14,className:"opacity-90"})," ",e]},e)})})}function It(){var T,Z,M,ee,_,B,U,J,te,V,se,W,G,K,X;const{username:s=""}=Ke(),[e,n]=d.useState(null),[a,r]=d.useState(null),[o,l]=d.useState(!1),[m,f]=d.useState(!1),[g,h]=d.useState({}),[k,v]=d.useState(!1);d.useEffect(()=>{(async()=>{var x;try{const i=await ge();if(i){l(!0),r({id:i.id,username:i.username});try{const E=await Je(),z={};for(const Y of E)z[Y.id]=Y.username;h(z)}catch{}const u=await be(s);if(u){n($e(u));try{f(!!((x=u.user)!=null&&x.owner))}catch{}return}}}catch{}l(!1),n(we(s)||null);const c=ve();r(c?{id:c.id,username:c.username}:null)})().finally(()=>v(!0))},[s]),d.useEffect(()=>{const c=async()=>{try{const i=await ge();if(i){r({id:i.id,username:i.username});return}}catch{}const x=ve();r(x?{id:x.id,username:x.username}:null),v(!0)};return window.addEventListener("forum:session",c),window.addEventListener("storage",c),()=>{window.removeEventListener("forum:session",c),window.removeEventListener("storage",c)}},[]);const p=(e==null?void 0:e.id)||"",[w,A]=d.useState(()=>p?ne(p):[]),[$,y]=d.useState(()=>p?P(p):[]),R=d.useMemo(()=>lt((a==null?void 0:a.id)||null,p),[a==null?void 0:a.id,p,w.length]);d.useEffect(()=>{if(!p){A([]),y([]);return}A(ne(p)),y(P(p))},[p]),d.useEffect(()=>{const c=()=>{p&&(A(ne(p)),y(P(p)))};return window.addEventListener("forum:social-change",c),()=>window.removeEventListener("forum:social-change",c)},[p]);const ce=(a==null?void 0:a.id)||null,I=e?Re(e):!1,L=c=>t.jsx("main",{className:"min-h-screen text-slate-200",style:{background:"radial-gradient(1100px 680px at 15% -10%, rgba(56,189,248,0.18), transparent 65%), radial-gradient(1000px 720px at 90% -6%, rgba(167,139,250,0.14), transparent 70%), linear-gradient(180deg, #04060d 0%, #090b16 100%)"},children:t.jsx("div",{className:"mx-auto max-w-3xl px-4 py-16",children:c})});if(!e)return L(t.jsx("div",{className:`${F} text-center text-sm text-zinc-300`,children:"Профиль не найден."}));if(I&&!k)return L(t.jsx("div",{className:`${F} text-center text-sm text-zinc-300`,children:"Загрузка профиля…"}));if(I&&k&&!Xe(e,ce))return L(t.jsx("div",{className:`${F} text-center text-sm text-zinc-300`,children:"Профиль не найден."}));const D=(a==null?void 0:a.id)===e.id,Q=e.profile.accentFrom||"#22d3ee",O=e.profile.accentTo||"#8b5cf6",de=Ce[e.role]||Ce.user;return t.jsx("main",{className:"min-h-screen text-slate-100",style:{background:"radial-gradient(1200px 700px at 12% -10%, rgba(56,189,248,0.18), transparent 65%), radial-gradient(1000px 720px at 90% -6%, rgba(167,139,250,0.14), transparent 70%), linear-gradient(180deg, #04060d 0%, #090b16 100%)"},children:t.jsxs("div",{className:"mx-auto max-w-5xl px-4 py-8 space-y-6",children:[t.jsxs("section",{className:"relative overflow-hidden rounded-3xl border border-white/10 bg-[#101321]/85 shadow-[0_50px_140px_-80px_rgba(15,23,42,0.9)] backdrop-blur",children:[t.jsx("div",{className:"h-[220px] w-full",style:{background:e.profile.bannerData?`url(${e.profile.bannerData}) center/cover`:`linear-gradient(135deg, ${Q}, ${O})`}}),t.jsx("div",{className:"pointer-events-none absolute inset-0 bg-gradient-to-b from-black/15 via-transparent to-black/70"}),t.jsx("div",{className:"pointer-events-none absolute inset-x-0 top-0 h-32 bg-gradient-to-b from-white/10 to-transparent mix-blend-overlay"}),t.jsxs("div",{className:"relative -mt-16 flex flex-col gap-5 px-6 pb-6 sm:flex-row sm:flex-wrap sm:items-end",children:[t.jsxs("div",{className:"relative",children:[t.jsx("div",{className:"h-24 w-24 overflow-hidden rounded-full border-4 border-[#101321] shadow-[0_25px_70px_-35px_rgba(15,23,42,0.9)]",style:{background:e.profile.avatarData?`url(${e.profile.avatarData}) center/cover`:`linear-gradient(135deg, ${Q}, ${O})`}}),t.jsx("div",{className:`absolute -inset-1 -z-10 rounded-full bg-gradient-to-br ${de.glow} to-transparent blur-lg`}),t.jsx("div",{className:"absolute -bottom-2 left-1",children:t.jsx(wt,{role:e.role})})]}),t.jsxs("div",{className:"min-w-0 flex-1 space-y-3",children:[t.jsxs("div",{className:"flex flex-wrap items-center gap-3",children:[t.jsx("h1",{className:"text-3xl font-extrabold tracking-tight text-white",children:e.username}),t.jsxs("span",{className:"rounded-full border border-white/10 bg-white/10 px-2 py-0.5 text-[11px] uppercase tracking-[0.28em] text-zinc-200/80",children:["#",e.userNumber]}),t.jsx(qe,{points:e.score??He({posts:e.posts,likes:e.likes,topics:e.topics})})]}),t.jsxs("div",{className:"flex flex-wrap items-center gap-2",children:[m&&t.jsx(Ae,{role:"owner"}),((Z=(T=e.profile)==null?void 0:T.privacy)==null?void 0:Z.showSecondaryRole)!==!1&&t.jsx(Ae,{role:e.role})]}),t.jsxs("div",{className:"flex flex-wrap items-center gap-3 text-xs text-zinc-300/90",children:[t.jsxs("span",{children:["Joined: ",yt.format(new Date(e.createdAt))]}),(M=e.profile.privacy)!=null&&M.showEmail&&e.email?t.jsx("span",{className:"rounded-full border border-white/10 bg-white/10 px-2 py-1",children:e.email}):null]}),(()=>{const c=e.lastActiveAt||Ve(e.id);return c?t.jsxs("div",{className:"text-xs text-zinc-300/90",children:["Last seen: ",We(c)]}):null})(),t.jsxs("div",{className:"space-y-2",children:[t.jsx(jt,{badges:e.profile.badges}),Array.isArray((ee=e.profile)==null?void 0:ee.labels)&&e.profile.labels.length>0&&t.jsx("div",{className:"flex flex-wrap gap-2",children:e.profile.labels.slice(0,7).map((c,x)=>t.jsx("span",{className:"rounded-full border border-white/10 bg-white/10 px-2.5 py-1 text-xs text-white/85",children:c},x))})]})]}),D?t.jsx(Nt,{user:e,onUpdated:async()=>{if(o){const c=await be(s);c&&n($e(c))}else n(we(s)||null)},saveProfile:async c=>{o?await me(c):Ye(e.id,c)}}):t.jsx("div",{className:"flex gap-2",children:t.jsx("button",{className:`btn ${R?"":"btn-primary"}`,onClick:()=>{a!=null&&a.id&&(R?dt(a.id,e.id):ct(a.id,e.id),A(ne(e.id)))},children:R?t.jsxs(t.Fragment,{children:[t.jsx(Qe,{size:16})," Отписаться"]}):t.jsxs(t.Fragment,{children:[t.jsx(Ze,{size:16})," Подписаться"]})})})]})]}),o&&D&&m&&t.jsxs("div",{className:F,children:[t.jsx("div",{className:"mb-3 text-xs uppercase tracking-[0.3em] text-zinc-400/80",children:"Вторая роль"}),t.jsxs("div",{className:"flex flex-wrap items-center gap-3",children:[t.jsxs("select",{className:"input",value:((B=(_=e.profile)==null?void 0:_.privacy)==null?void 0:B.showSecondaryRole)===!1?"none":e.role,onChange:async c=>{var i;const x=c.target.value;try{const u=((i=e.profile)==null?void 0:i.privacy)||{showEmail:!1,showStats:!0};x==="none"?(await me({privacy:{...u,showSecondaryRole:!1}}),n({...e,profile:{...e.profile,privacy:{...u,showSecondaryRole:!1}}})):(await Ge(e.id,x),await me({privacy:{...u,showSecondaryRole:!0}}),n({...e,role:x,profile:{...e.profile,privacy:{...u,showSecondaryRole:!0}}}))}catch(u){alert((u==null?void 0:u.message)||"Не удалось изменить роль")}},children:[t.jsx("option",{value:"none",children:"Не показывать"}),t.jsx("option",{value:"developer",children:"Разработчик"}),t.jsx("option",{value:"admin",children:"Администратор"}),t.jsx("option",{value:"moderator",children:"Модератор"}),t.jsx("option",{value:"vip",children:"VIP"}),t.jsx("option",{value:"user",children:"Участник"}),t.jsx("option",{value:"newbie",children:"Новичок"})]}),t.jsx("div",{className:"text-xs text-zinc-300/80",children:"Роль владельца постоянна; здесь можно выбрать отображаемую."})]})]}),((J=(U=e.profile)==null?void 0:U.privacy)==null?void 0:J.showStats)!==!1&&t.jsxs("div",{className:"grid gap-4 sm:grid-cols-3",children:[t.jsx(ue,{value:e.posts,label:"Посты"}),t.jsx(ue,{value:e.topics,label:"Темы"}),t.jsx(ue,{value:e.likes,label:"Лайки"})]}),t.jsxs("div",{className:"grid gap-4 lg:grid-cols-[1.35fr_.85fr]",children:[t.jsx(q,{title:"О себе",children:t.jsx("p",{className:"whitespace-pre-wrap text-sm text-zinc-200/85",children:e.profile.bio||"Пока нет описания."})}),((V=(te=e.profile)==null?void 0:te.privacy)==null?void 0:V.showLinks)!==!1&&t.jsx(q,{title:"Ссылки",children:t.jsx("div",{className:"flex flex-wrap gap-2 text-sm text-zinc-200/90",children:(se=e.profile.links)!=null&&se.website?t.jsxs("a",{className:"inline-flex items-center gap-2 rounded-full border border-white/10 bg-white/10 px-3 py-1 hover:border-white/30",href:e.profile.links.website,target:"_blank",rel:"noreferrer",children:[t.jsx(et,{size:14})," Сайт"]}):t.jsx("span",{className:"opacity-70",children:"Ссылки ещё не добавлены."})})})]}),t.jsx(q,{title:"Подпись",children:t.jsx("div",{className:"whitespace-pre-wrap text-sm text-zinc-200/85",children:e.profile.signature||"Подпись не заполнена."})}),((G=(W=e.profile)==null?void 0:W.privacy)==null?void 0:G.showFollowers)!==!1&&t.jsx(q,{title:`Подписчики (${w.length})`,children:t.jsx("div",{className:"flex flex-wrap gap-2 text-sm text-zinc-200/90",children:w.length===0?t.jsx("span",{className:"opacity-70",children:"Подписчиков пока нет."}):w.slice(0,18).map(c=>{const x=_e(c),i=(x==null?void 0:x.username)||g[c];return t.jsx("span",{className:"rounded-full border border-white/10 bg-white/10 px-3 py-1",children:i?t.jsx("a",{href:`/forum/profile/${i}`,className:"hover:underline",children:i}):"Участник"},c)})})}),((X=(K=e.profile)==null?void 0:K.privacy)==null?void 0:X.allowComments)!==!1&&t.jsx(q,{title:"Комментарии профиля",children:t.jsxs("div",{className:"grid gap-3",children:[(a==null?void 0:a.id)&&t.jsx(Ct,{onPost:c=>{a!=null&&a.id&&(Me(e.id,a.id,c,{authorName:a.username}),y(P(e.id)))}}),t.jsxs("div",{className:"grid gap-2",children:[$.length===0&&t.jsx("div",{className:"text-sm text-zinc-400/80",children:"Комментариев пока нет."}),At($).map(c=>t.jsx(Ue,{node:c,currentUserId:(a==null?void 0:a.id)||"",ownerId:e.id,onReply:(x,i)=>{a!=null&&a.id&&(xt(e.id,a.id,x,i,a.username),y(P(e.id)))},onDelete:x=>{a!=null&&a.id&&(pt(e.id,x,a.id),y(P(e.id)))}},c.comment.id))]})]})})]})})}function Nt({user:s,onUpdated:e,saveProfile:n}){const[a,r]=d.useState(!1);return t.jsxs(t.Fragment,{children:[t.jsxs("button",{className:"btn",onClick:()=>r(!0),children:[t.jsx(st,{size:16})," Настроить профиль"]}),a&&t.jsx(kt,{user:s,onClose:()=>r(!1),onSaved:()=>{e(),r(!1)},saveProfile:n})]})}const St=["Founder","Early","Contributor","VIP","Designer"];function kt({user:s,onClose:e,onSaved:n,saveProfile:a}){var W,G,K,X,c,x;const[r,o]=d.useState(s.profile.avatarData||""),[l,m]=d.useState(s.profile.bannerData||""),[f,g]=d.useState(s.profile.accentFrom||"#22d3ee"),[h,k]=d.useState(s.profile.accentTo||"#8b5cf6"),[v,p]=d.useState(s.profile.bio||""),[w,A]=d.useState(s.profile.signature||""),[$,y]=d.useState(((W=s.profile.links)==null?void 0:W.website)||""),[R,ce]=d.useState(s.profile.badges||[]),[I,L]=d.useState(((G=s.profile.privacy)==null?void 0:G.showEmail)??!1),[D,Q]=d.useState(((K=s.profile.privacy)==null?void 0:K.showStats)??!0),[O,de]=d.useState(((X=s.profile.privacy)==null?void 0:X.showLinks)??!0),[T,Z]=d.useState(((c=s.profile.privacy)==null?void 0:c.allowComments)??!0),[M,ee]=d.useState(((x=s.profile.privacy)==null?void 0:x.showFollowers)??!0),[_,B]=d.useState(!1),[U,J]=d.useState(null),te=i=>{ce(u=>u.includes(i)?u.filter(E=>E!==i):u.length>=3?u:[...u,i])},V=i=>u=>{var Y;const E=(Y=u.target.files)==null?void 0:Y[0];if(!E)return;const z=new FileReader;z.onload=()=>i(String(z.result||"")),z.readAsDataURL(E)},se=async()=>{const i={avatarData:r||void 0,bannerData:l||void 0,accentFrom:f,accentTo:h,bio:v.trim()||void 0,signature:w.trim()||void 0,links:$.trim()?{website:$.trim()}:void 0,badges:R,privacy:{showEmail:I,showStats:D,showLinks:O,allowComments:T,showFollowers:M}};try{B(!0),J(null),await a(i),n()}catch(u){J((u==null?void 0:u.message)||"Не удалось сохранить изменения.")}finally{B(!1)}};return t.jsx("div",{className:"fixed inset-0 z-[120] grid place-items-center bg-black/70 px-4 py-6",children:t.jsxs("div",{className:`${F} w-[min(820px,96vw)] max-h-[90vh] overflow-y-auto space-y-5`,children:[t.jsxs("div",{className:"flex items-center justify-between",children:[t.jsx("div",{className:"text-lg font-semibold text-white",children:"Настройка профиля"}),t.jsx("button",{className:"btn",onClick:e,children:"Закрыть"})]}),t.jsxs("div",{className:"grid gap-4 sm:grid-cols-2",children:[t.jsxs("div",{className:b,children:[t.jsx("div",{className:"text-xs uppercase tracking-[0.28em] text-zinc-400/80",children:"Аватар"}),t.jsxs("div",{className:"mt-3 flex items-center gap-3",children:[t.jsx("div",{className:"h-20 w-20 rounded-full",style:{background:r?`url(${r}) center/cover`:`linear-gradient(135deg, ${f}, ${h})`}}),t.jsxs("div",{className:"flex flex-col gap-2",children:[t.jsxs("label",{className:"btn flex items-center gap-2",children:[t.jsx(Se,{size:16})," Загрузить",t.jsx("input",{type:"file",accept:"image/*",hidden:!0,onChange:V(o)})]}),r&&t.jsx("button",{className:"btn",onClick:()=>o(""),children:"Удалить"})]})]})]}),t.jsxs("div",{className:b,children:[t.jsx("div",{className:"text-xs uppercase tracking-[0.28em] text-zinc-400/80",children:"Баннер"}),t.jsx("div",{className:"mt-3 h-20 w-full rounded-xl",style:{background:l?`url(${l}) center/cover`:`linear-gradient(135deg, ${f}, ${h})`}}),t.jsxs("div",{className:"mt-3 flex gap-2",children:[t.jsxs("label",{className:"btn flex items-center gap-2",children:[t.jsx(Se,{size:16})," Загрузить",t.jsx("input",{type:"file",accept:"image/*",hidden:!0,onChange:V(m)})]}),l&&t.jsx("button",{className:"btn",onClick:()=>m(""),children:"Удалить"})]})]}),t.jsxs("div",{className:b,children:[t.jsx("div",{className:"text-xs uppercase tracking-[0.28em] text-zinc-400/80",children:"Градиент"}),t.jsxs("div",{className:"mt-3 flex items-center gap-4",children:[t.jsxs("label",{className:"flex items-center gap-2 text-xs text-zinc-400/80",children:[t.jsx("span",{children:"От"}),t.jsx("input",{type:"color",value:f,onChange:i=>g(i.target.value)})]}),t.jsxs("label",{className:"flex items-center gap-2 text-xs text-zinc-400/80",children:[t.jsx("span",{children:"До"}),t.jsx("input",{type:"color",value:h,onChange:i=>k(i.target.value)})]})]})]}),t.jsxs("div",{className:b,children:[t.jsx("div",{className:"text-xs uppercase tracking-[0.28em] text-zinc-400/80",children:"Бейджи (до 3)"}),t.jsx("div",{className:"mt-3 flex flex-wrap gap-2",children:St.map(i=>{const u=R.includes(i);return t.jsxs("button",{className:`btn flex items-center gap-2 ${u?"btn-primary":""}`,onClick:()=>te(i),type:"button",title:u?"Нажмите, чтобы убрать":"Нажмите, чтобы добавить",children:[t.jsx(Ee,{size:16})," ",i]},i)})})]}),t.jsxs("div",{className:`${b} sm:col-span-2`,children:[t.jsx("div",{className:"text-xs uppercase tracking-[0.28em] text-zinc-400/80",children:"О себе"}),t.jsx("textarea",{className:"input mt-2 min-h-[120px]",value:v,onChange:i=>p(i.target.value),placeholder:"Расскажите сообществу немного о себе"})]}),t.jsxs("div",{className:`${b} sm:col-span-2`,children:[t.jsx("div",{className:"text-xs uppercase tracking-[0.28em] text-zinc-400/80",children:"Подпись"}),t.jsx("textarea",{className:"input mt-2 min-h-[90px]",value:w,onChange:i=>A(i.target.value),placeholder:"Текст, который появится под вашими сообщениями"})]}),t.jsxs("div",{className:`${b} sm:col-span-2`,children:[t.jsx("div",{className:"text-xs uppercase tracking-[0.28em] text-zinc-400/80",children:"Ссылки"}),t.jsxs("div",{className:"mt-3 grid gap-2 sm:grid-cols-3",children:[t.jsx("input",{className:"input sm:col-span-1",placeholder:"https://website",value:$,onChange:i=>y(i.target.value)}),t.jsx("div",{className:"sm:col-span-2 text-xs text-zinc-400/80",children:"Укажите персональный сайт или страницу с портфолио. Соцсети скрыты для гостей."})]})]}),t.jsxs("div",{className:`${b} sm:col-span-2`,children:[t.jsx("div",{className:"text-xs uppercase tracking-[0.28em] text-zinc-400/80",children:"Приватность"}),t.jsxs("div",{className:"mt-3 grid gap-2 text-sm",children:[t.jsxs("label",{className:"flex items-center gap-2",children:[t.jsx("input",{type:"checkbox",checked:I,onChange:i=>L(i.target.checked)})," Показывать e-mail"]}),t.jsxs("label",{className:"flex items-center gap-2",children:[t.jsx("input",{type:"checkbox",checked:D,onChange:i=>Q(i.target.checked)})," Показывать статистику"]}),t.jsxs("label",{className:"flex items-center gap-2",children:[t.jsx("input",{type:"checkbox",checked:O,onChange:i=>de(i.target.checked)})," Показывать ссылки"]}),t.jsxs("label",{className:"flex items-center gap-2",children:[t.jsx("input",{type:"checkbox",checked:M,onChange:i=>ee(i.target.checked)})," Показывать подписчиков"]}),t.jsxs("label",{className:"flex items-center gap-2",children:[t.jsx("input",{type:"checkbox",checked:T,onChange:i=>Z(i.target.checked)})," Разрешить комментарии"]})]})]})]}),U&&t.jsx("div",{className:"rounded-2xl border border-rose-500/30 bg-rose-500/10 px-4 py-3 text-sm text-rose-200",children:U}),t.jsxs("div",{className:"flex justify-end gap-2",children:[t.jsx("button",{className:"btn",onClick:e,disabled:_,children:"Отмена"}),t.jsx("button",{className:"btn btn-primary",onClick:se,disabled:_,children:_?"Сохранение…":"Сохранить"})]})]})})}function Ct({onPost:s}){const[e,n]=d.useState("");return t.jsxs("div",{className:b,children:[t.jsxs("div",{className:"flex items-start gap-2",children:[t.jsx(at,{size:16,className:"mt-1 shrink-0"}),t.jsx("textarea",{className:"input min-h-[80px] flex-1",placeholder:"Напишите комментарий...",value:e,onChange:a=>n(a.target.value)})]}),t.jsx("div",{className:"mt-2 flex justify-end",children:t.jsx("button",{className:"btn btn-primary",onClick:()=>{const a=e.trim();a&&(s(a),n(""))},children:"Отправить"})})]})}function At(s){const e={};s.forEach(r=>{e[r.id]={comment:r,replies:[]}});const n=[];s.forEach(r=>{const o=r.parentId||"";o&&e[o]?e[o].replies.push(e[r.id]):n.push(e[r.id])}),n.sort((r,o)=>r.comment.createdAt<o.comment.createdAt?1:-1);const a=r=>r.replies.sort((o,l)=>o.comment.createdAt>l.comment.createdAt?1:-1).forEach(a);return n.forEach(a),n}function Ue({node:s,currentUserId:e,ownerId:n,onReply:a,onDelete:r}){const[o,l]=d.useState(!1),m=_e(s.comment.authorId),f=s.comment.authorName||(m==null?void 0:m.username)||(s.comment.authorId===n?"Владелец":s.comment.authorId===e?"Вы":"Участник"),g=(m==null?void 0:m.username)||s.comment.authorName;return t.jsx("div",{className:b,children:t.jsxs("div",{className:"flex items-start gap-3",children:[t.jsx("div",{className:"h-8 w-8 shrink-0 rounded-full bg-gradient-to-br from-sky-500/60 to-violet-500/60"}),t.jsxs("div",{className:"min-w-0 flex-1",children:[t.jsxs("div",{className:"flex items-center justify-between gap-3",children:[t.jsxs("div",{className:"text-xs text-zinc-300/90",children:[g?t.jsx("a",{href:`/forum/profile/${g}`,className:"font-semibold text-white hover:underline",children:f}):t.jsx("span",{className:"font-semibold text-white",children:f}),t.jsxs("span",{className:"opacity-70",children:[" · ",new Date(s.comment.createdAt).toLocaleString("ru-RU")]})]}),(e===s.comment.authorId||e===n)&&t.jsx("button",{className:"btn",title:"Удалить",onClick:()=>r(s.comment.id),children:t.jsx(nt,{size:14})})]}),t.jsx("div",{className:"mt-1 whitespace-pre-wrap text-sm text-zinc-100/90",children:s.comment.content}),t.jsx(Rt,{targetId:n,commentId:s.comment.id,currentUserId:e}),t.jsx("div",{className:"mt-2 flex items-center gap-2",children:t.jsx("button",{className:"btn",onClick:()=>l(h=>!h),children:"Ответить"})}),o&&t.jsx("div",{className:"mt-2",children:t.jsx($t,{onSend:h=>{a(s.comment.id,h),l(!1)}})}),s.replies.length>0&&t.jsx("div",{className:"mt-3 space-y-2 border-l border-white/10 pl-3",children:s.replies.map(h=>t.jsx(Ue,{node:h,currentUserId:e,ownerId:n,onReply:a,onDelete:r},h.comment.id))})]})]})})}function $t({onSend:s}){const[e,n]=d.useState("");return t.jsxs("div",{className:"flex items-start gap-2",children:[t.jsx("textarea",{className:"input min-h-[60px] flex-1",placeholder:"Ответ...",value:e,onChange:a=>n(a.target.value)}),t.jsx("button",{className:"btn btn-primary",onClick:()=>{const a=e.trim();a&&(s(a),n(""))},children:"Отправить"})]})}function Rt({targetId:s,commentId:e,currentUserId:n}){const[,a]=d.useReducer(m=>m+1,0),r=ht(s)[e]||{counts:{like:0,smile:0,useful:0}},o=n?gt(s,e,n):void 0,l=({r:m,label:f})=>{var g;return t.jsxs("button",{className:`btn text-xs ${o===m?"btn-primary":""}`,onClick:()=>{n&&(bt(s,e,n,m),a())},children:[f," ",(g=r.counts)!=null&&g[m]?t.jsx("span",{className:"opacity-80",children:r.counts[m]}):null]})};return t.jsxs("div",{className:"mt-2 flex flex-wrap items-center gap-2",children:[t.jsx(l,{r:"like",label:"👍"}),t.jsx(l,{r:"smile",label:"😊"}),t.jsx(l,{r:"useful",label:"💡"})]})}export{It as default};
