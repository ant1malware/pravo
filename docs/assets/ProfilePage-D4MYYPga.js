import{c as we,m as Ue,n as ve,j as t,o as Je,p as We,q as xe,s as Ge}from"./index-DDMfrihc.js";import{u as Ve,R as d}from"./react-vendor-DTkXckhQ.js";import{B as Ke,c as Xe}from"./Badge-DH6K8e6y.js";import{a2 as Ye,a3 as qe,a4 as He,a5 as je,a6 as ye,S as Ne,a7 as ke,a8 as Qe,a9 as Re,aa as Ze,M as et,ab as tt,ac as Se}from"./icons-zK4tVMYI.js";const W="forum:",fe=`${W}follows`,$e=`${W}profile_comments:`,st=`${W}social-change`,ne=new Map,at={getItem:s=>ne.has(s)?ne.get(s):null,setItem:(s,e)=>void ne.set(s,e),removeItem:s=>void ne.delete(s)},N=(()=>{try{if(typeof window<"u"&&window.localStorage)return window.localStorage}catch{}return at})(),ze=typeof window<"u";function ce(){return new Date().toISOString()}function he(s,e){try{return s?JSON.parse(s):e}catch{return e}}function Pe(){try{const s=typeof crypto<"u"&&crypto.randomUUID?crypto.randomUUID():null;if(s)return s}catch{}return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,s=>{const e=Math.random()*16|0;return(s==="x"?e:e&3|8).toString(16)})}function S(s){if(ze)try{window.dispatchEvent(new CustomEvent(st,{detail:s}))}catch{}}ze&&window.addEventListener("storage",s=>{s.key&&(s.key.startsWith($e)||s.key===fe)&&S({key:s.key,type:"storage"})});function de(){return he(N.getItem(fe),[])}function Fe(s){const e=new Set,n=[];for(const a of s){const r=`${a.followerId}=>${a.targetId}`;a.followerId!==a.targetId&&(e.has(r)||(e.add(r),n.push(a)))}try{N.setItem(fe,JSON.stringify(n))}catch{}S({scope:"follows"})}function nt(){try{const e=new URL(window.location.href),n=e.searchParams.get("api");if(n){localStorage.setItem("forum:api_base",n);try{e.searchParams.delete("api"),history.replaceState({},"",e.toString())}catch{}}const a=localStorage.getItem("forum:api_base");if(a)return a}catch{}return"https://notifications-worker.wizardiowhy.workers.dev/skyapi"}const De=nt();function Ie(){try{return localStorage.getItem("forum:token")??sessionStorage.getItem("forum:token")}catch{return null}}async function C(s,e={}){const n=Ie(),a={"Content-Type":"application/json",...e.headers||{}};n&&(a.Authorization=`Bearer ${n}`);const r=await fetch(`${De}${s}`,{...e,headers:a}),i=await r.text();let l={};try{l=i?JSON.parse(i):{}}catch{l={error:i||r.statusText}}if(!r.ok)throw new Error((l==null?void 0:l.error)||`${r.status} ${r.statusText}`);return l}function k(){return!!De&&!!Ie()}function re(s){if(k())try{const e=window.__socialRemoteFollowersCache||(window.__socialRemoteFollowersCache=new Map),n=e.get(s);if(n)return n;C(`/social/followers/${encodeURIComponent(s)}`).then(a=>{try{e.set(s,Array.isArray(a.followers)?a.followers:[]),S({scope:"follows",targetId:s})}catch{}})}catch{}return de().filter(e=>e.targetId===s).map(e=>e.followerId)}function rt(s,e){if(!s)return!1;if(k())try{const n=window.__socialRemoteFollowingCache||(window.__socialRemoteFollowingCache=new Map),a=n.get(s);if(a)return a.includes(e);C(`/social/following/${encodeURIComponent(s)}`).then(r=>{try{n.set(s,Array.isArray(r.following)?r.following:[]),S({scope:"follows",followerId:s})}catch{}})}catch{}return de().some(n=>n.followerId===s&&n.targetId===e)}function it(s,e){if(!s||!e||s===e)return;if(k())try{C("/social/follow",{method:"POST",body:JSON.stringify({targetId:e})})}catch{}const n=de();n.some(a=>a.followerId===s&&a.targetId===e)||(n.push({followerId:s,targetId:e,createdAt:ce()}),Fe(n))}function lt(s,e){if(k())try{C("/social/unfollow",{method:"POST",body:JSON.stringify({targetId:e})})}catch{}const n=de().filter(a=>!(a.followerId===s&&a.targetId===e));Fe(n)}function Le(s){return`${$e}${s}`}function pe(s){return s.map(e=>({id:e.id??Pe(),targetId:e.targetId,authorId:e.authorId,authorName:e.authorName,content:typeof e.content=="string"?e.content:"",createdAt:e.createdAt??ce(),parentId:e.parentId??null,updatedAt:e.updatedAt??null,edited:!!e.edited,deleted:!!e.deleted,deletedAt:e.deletedAt??null,deletedById:e.deletedById??null}))}function ie(s){if(k())try{const a=window.__socialRemoteCommentsCache||(window.__socialRemoteCommentsCache=new Map),r=a.get(s);if(r)return r;C(`/profiles/${encodeURIComponent(s)}/comments`).then(i=>{try{const l=pe(Array.isArray(i.comments)?i.comments:[]);a.set(s,l),S({scope:"comments",targetId:s})}catch{}})}catch{}const e=N.getItem(Le(s)),n=he(e,[]);return pe(n)}function Te(s,e){try{N.setItem(Le(s),JSON.stringify(e))}catch{}S({scope:"comments",targetId:s})}const ot=1e4;function ct(s,e){const n=`${W}last_post:${s}:${e}`,a=Number(N.getItem(n)||"0"),r=Date.now()-a>=ot;if(r)try{N.setItem(n,String(Date.now()))}catch{}return r}const Ce=2e3;function E(s,e){const n=ie(s),r=!1?n:n.filter(m=>!m.deleted);r.sort((m,p)=>m.createdAt<p.createdAt?1:-1);const i=Math.max(0,0);return r.slice(i,void 0)}function Oe(s,e,n,a){const r=(n??"").trim();if(!r)throw new Error("Comment is empty");if(r.length>Ce)throw new Error(`Comment too long (${r.length} > ${Ce})`);if(!k()&&!ct(s,e))throw new Error("You are posting too fast. Please wait a bit.");if(k())try{C(`/profiles/${encodeURIComponent(s)}/comments`,{method:"POST",body:JSON.stringify({content:r,parentId:(a==null?void 0:a.parentId)||null})}).then(m=>{try{const p=window.__socialRemoteCommentsCache;if(p){const f=p.get(s)||[],g=pe(Array.isArray(m.comment)?m.comment:[m.comment]);p.set(s,[...g,...f]),S({scope:"comments",targetId:s})}}catch{}}).catch(()=>{})}catch{}if(a!=null&&a.parentId&&!ie(s).find(p=>p.id===a.parentId))throw new Error("Parent comment not found");const i={id:Pe(),targetId:s,authorId:e,authorName:a==null?void 0:a.authorName,content:r,createdAt:ce(),parentId:(a==null?void 0:a.parentId)??null,updatedAt:null,edited:!1,deleted:!1,deletedAt:null,deletedById:null},l=ie(s);return l.unshift(i),Te(s,l),i}function dt(s,e,n,a,r){return Oe(s,e,a,{authorName:r,parentId:n})}function mt(s,e,n){if(k())try{C(`/profiles/${encodeURIComponent(s)}/comments/${encodeURIComponent(e)}`,{method:"DELETE"})}catch{}const a=ie(s),r=a.findIndex(l=>l.id===e);if(r<0)return;const i=a[r];(i.authorId===n||s===n)&&(i.deleted||(a[r]={...i,content:"",deleted:!0,deletedAt:ce(),deletedById:n},Te(s,a)))}function Me(s){return`${W}comment_reactions:${s}`}function ge(s){return he(N.getItem(Me(s)),{})}function xt(s,e){try{N.setItem(Me(s),JSON.stringify(e))}catch{}S({scope:"reactions",targetId:s})}function ut(s){return ge(s)}function pt(s,e,n){var a,r;return(r=(a=ge(s)[e])==null?void 0:a.byUser)==null?void 0:r[n]}function ft(s,e,n,a){const r=ge(s),i=r[e]||{counts:{like:0,smile:0,useful:0},byUser:{}},l=i.byUser[n];return l===a?(i.byUser[n]=void 0,i.counts[a]=Math.max(0,(i.counts[a]||0)-1)):(l&&(i.counts[l]=Math.max(0,(i.counts[l]||0)-1)),i.byUser[n]=a,i.counts[a]=(i.counts[a]||0)+1),r[e]=i,xt(s,r),i}const Ae={developer:{label:"Разработчик",color:"#22d3ee",glow:"from-cyan-400/35"},admin:{label:"Администратор",color:"#ef4444",glow:"from-rose-400/35"},moderator:{label:"Модератор",color:"#8b5cf6",glow:"from-violet-400/35"},vip:{label:"VIP",color:"#eab308",glow:"from-amber-400/35"},user:{label:"Участник",color:"#94a3b8",glow:"from-slate-300/30"},newbie:{label:"Новичок",color:"#22d3ee",glow:"from-cyan-400/35"}};function ue({value:s,label:e}){return t.jsxs("div",{className:`${v} text-center`,children:[t.jsx("div",{className:"text-3xl font-extrabold text-white",children:s}),t.jsx("div",{className:"mt-1 text-xs uppercase tracking-[0.3em] text-zinc-300/80",children:e})]})}function J({title:s,children:e,right:n}){return t.jsxs("div",{className:le,children:[t.jsxs("div",{className:"mb-3 flex items-center justify-between",children:[t.jsx("div",{className:"text-xs uppercase tracking-[0.3em] text-zinc-400/75",children:s}),n]}),e]})}function _e({role:s}){const e=oe[s]??oe.user,n=e.Icon;return t.jsxs("span",{className:"relative inline-flex",children:[t.jsx("span",{className:`absolute -inset-[2px] rounded-full blur-md bg-gradient-to-r ${e.grad} opacity-50`}),t.jsxs("span",{className:"relative inline-flex items-center gap-2 rounded-full border border-white/10 bg-white/5 px-3.5 py-1.5 text-[11px] font-extrabold uppercase tracking-[0.22em] text-white shadow-[0_0_0_1px_rgba(255,255,255,0.06)_inset]",children:[t.jsx(n,{size:14,className:"opacity-90"}),e.label]})]})}function ht({role:s}){const e=oe[s]??oe.user;return t.jsx("span",{className:"rounded-full border border-white/15 bg-black/50 px-2 py-0.5 text-[10px] font-bold uppercase tracking-[0.18em] text-white backdrop-blur",style:{boxShadow:"0 0 16px rgba(255,255,255,0.08), inset 0 0 0 1px rgba(255,255,255,0.05)"},children:e.label})}const gt={Founder:"from-rose-500/25 to-rose-400/10 text-rose-200",Early:"from-sky-500/25 to-sky-400/10 text-sky-200",Contributor:"from-emerald-500/25 to-emerald-400/10 text-emerald-200",VIP:"from-amber-500/25 to-amber-400/10 text-amber-200",Designer:"from-violet-500/25 to-violet-400/10 text-violet-200"},le="rounded-3xl border border-white/10 bg-[#101321]/85 p-5 shadow-[0_40px_120px_-70px_rgba(15,23,42,0.9)] backdrop-blur",v="rounded-3xl border border-white/10 bg-white/[0.05] p-4 shadow-[0_30px_90px_-70px_rgba(15,23,42,0.85)] backdrop-blur",bt=new Intl.DateTimeFormat("ru-RU",{day:"2-digit",month:"long",year:"numeric"}),oe={owner:{label:"Owner",grad:"from-amber-400 via-rose-400 to-amber-400",Icon:ke},developer:{label:"Developer",grad:"from-cyan-400 via-fuchsia-400 to-cyan-400",Icon:ye},admin:{label:"Admin",grad:"from-rose-400 via-amber-400 to-rose-400",Icon:Ne},moderator:{label:"Moderator",grad:"from-violet-400 via-sky-400 to-violet-400",Icon:Qe},vip:{label:"Premium",grad:"from-amber-400 via-rose-400 to-amber-400",Icon:ke},user:{label:"User",grad:"from-slate-300 via-slate-400 to-slate-300",Icon:Ne},newbie:{label:"Newbie",grad:"from-cyan-400 via-fuchsia-400 to-cyan-400",Icon:ye}};function Ee(s){const e=s.profile||{},n=s.stats||{},a=typeof n.posts=="number"?n.posts:0,r=typeof n.likes=="number"?n.likes:0,i=typeof n.topics=="number"?n.topics:0,l=s.lastActiveAt||s.lastSeenAt||s.lastOnlineAt||null,m=e.accentFrom||"#8b5cf6",p=e.accentTo||"#0ea5e9",f=e.avatarData||e.avatar||e.avatarUrl||void 0,g=e.bannerData||e.banner||e.bannerUrl||void 0,x={bio:e.bio||"",signature:e.signature||"",links:e.links?{...e.links}:{},accentFrom:m,accentTo:p,avatarData:f,bannerData:g,badges:Array.isArray(e.badges)?e.badges:[],privacy:{showEmail:!1,showStats:!0,showLinks:!0,allowComments:!0,showFollowers:!0,...e.privacy||{}}};Array.isArray(e.labels)&&(x.labels=e.labels);const w={id:s.user.id,username:s.user.username,email:s.user.email,createdAt:s.user.createdAt,role:s.user.role,userNumber:s.user.userNumber,posts:a,likes:r,topics:i,profile:x,bans:null,mutes:null};return typeof n.score=="number"&&(w.score=n.score),l&&(w.lastActiveAt=l),w}function wt({badges:s}){return!s||s.length===0?null:t.jsx("div",{className:"flex flex-wrap items-center gap-2",children:s.slice(0,3).map(e=>{const n=gt[e]||"from-white/20 to-white/5 text-zinc-200";return t.jsxs("span",{className:`inline-flex items-center gap-1 rounded-full border border-white/10 bg-gradient-to-br ${n} px-2.5 py-1 text-xs`,title:`Badge: ${e}`,children:[t.jsx(Re,{size:14,className:"opacity-90"})," ",e]},e)})})}function $t(){var X,z,Y,P,q,F,H,D,Q,I,Z,L,ee,te,T,se,O,M,B,U;const{username:s=""}=Ve(),[e,n]=d.useState(null),[a,r]=d.useState(null),[i,l]=d.useState(!0),[m,p]=d.useState(!1),[f,g]=d.useState({});d.useEffect(()=>{(async()=>{var u;try{const b=await we();b?(l(!0),r({id:b.id,username:b.username})):(l(!0),r(null))}catch{l(!0),r(null)}try{const b=await Ue(),h={};for(const o of b)h[o.id]=o.username;g(h)}catch{}const c=await ve(s);n(c?Ee(c):null);try{p(!!((u=c==null?void 0:c.user)!=null&&u.owner))}catch{}})()},[s]),d.useEffect(()=>{const c=async()=>{try{const u=await we();r(u?{id:u.id,username:u.username}:null)}catch{r(null)}};return window.addEventListener("forum:session",c),window.addEventListener("storage",c),()=>{window.removeEventListener("forum:session",c),window.removeEventListener("storage",c)}},[]);const x=(e==null?void 0:e.id)||"",[w,A]=d.useState(()=>x?re(x):[]),[R,y]=d.useState(()=>x?E(x):[]),_=d.useMemo(()=>rt((a==null?void 0:a.id)||null,x),[a==null?void 0:a.id,x,w.length]);if(d.useEffect(()=>{if(!x){A([]),y([]);return}A(re(x)),y(E(x))},[x]),d.useEffect(()=>{const c=()=>{x&&(A(re(x)),y(E(x)))};return window.addEventListener("forum:social-change",c),()=>window.removeEventListener("forum:social-change",c)},[x]),!e)return t.jsx("main",{className:"min-h-screen text-slate-200",style:{background:"radial-gradient(1100px 680px at 15% -10%, rgba(56,189,248,0.18), transparent 65%), radial-gradient(1000px 720px at 90% -6%, rgba(167,139,250,0.14), transparent 70%), linear-gradient(180deg, #04060d 0%, #090b16 100%)"},children:t.jsx("div",{className:"mx-auto max-w-3xl px-4 py-16",children:t.jsx("div",{className:`${le} text-center text-sm text-zinc-300`,children:"Профиль не найден."})})});const G=(a==null?void 0:a.id)===e.id,$=e.profile.accentFrom||"#22d3ee",V=e.profile.accentTo||"#8b5cf6",K=Ae[e.role]||Ae.user;return t.jsx("main",{className:"min-h-screen text-slate-100",style:{background:"radial-gradient(1200px 700px at 12% -10%, rgba(56,189,248,0.18), transparent 65%), radial-gradient(1000px 720px at 90% -6%, rgba(167,139,250,0.14), transparent 70%), linear-gradient(180deg, #04060d 0%, #090b16 100%)"},children:t.jsxs("div",{className:"mx-auto max-w-5xl px-4 py-8 space-y-6",children:[t.jsxs("section",{className:"relative overflow-hidden rounded-3xl border border-white/10 bg-[#101321]/85 shadow-[0_50px_140px_-80px_rgba(15,23,42,0.9)] backdrop-blur",children:[t.jsx("div",{className:"h-[220px] w-full",style:{background:e.profile.bannerData?`url(${e.profile.bannerData}) center/cover`:`linear-gradient(135deg, ${$}, ${V})`}}),t.jsx("div",{className:"pointer-events-none absolute inset-0 bg-gradient-to-b from-black/15 via-transparent to-black/70"}),t.jsx("div",{className:"pointer-events-none absolute inset-x-0 top-0 h-32 bg-gradient-to-b from-white/10 to-transparent mix-blend-overlay"}),t.jsxs("div",{className:"relative -mt-16 flex flex-wrap items-end gap-5 px-6 pb-6",children:[t.jsxs("div",{className:"relative",children:[t.jsx("div",{className:"h-24 w-24 overflow-hidden rounded-full border-4 border-[#101321] shadow-[0_25px_70px_-35px_rgba(15,23,42,0.9)]",style:{background:e.profile.avatarData?`url(${e.profile.avatarData}) center/cover`:`linear-gradient(135deg, ${$}, ${V})`}}),t.jsx("div",{className:`absolute -inset-1 -z-10 rounded-full bg-gradient-to-br ${K.glow} to-transparent blur-lg`}),t.jsx("div",{className:"absolute -bottom-2 left-1",children:t.jsx(ht,{role:e.role})})]}),t.jsxs("div",{className:"min-w-0 flex-1 space-y-3",children:[t.jsxs("div",{className:"flex flex-wrap items-center gap-3",children:[t.jsx("h1",{className:"text-3xl font-extrabold tracking-tight text-white",children:e.username}),t.jsxs("span",{className:"rounded-full border border-white/10 bg-white/10 px-2 py-0.5 text-[11px] uppercase tracking-[0.28em] text-zinc-200/80",children:["#",e.userNumber]}),t.jsx(Ke,{points:e.score??Xe({posts:e.posts,likes:e.likes,topics:e.topics})})]}),t.jsxs("div",{className:"flex flex-wrap items-center gap-2",children:[m&&t.jsx(_e,{role:"owner"}),((z=(X=e.profile)==null?void 0:X.privacy)==null?void 0:z.showSecondaryRole)!==!1&&t.jsx(_e,{role:e.role})]}),t.jsxs("div",{className:"flex flex-wrap items-center gap-3 text-xs text-zinc-300/90",children:[t.jsxs("span",{children:["Joined: ",bt.format(new Date(e.createdAt))]}),(Y=e.profile.privacy)!=null&&Y.showEmail&&e.email?t.jsx("span",{className:"rounded-full border border-white/10 bg-white/10 px-2 py-1",children:e.email}):null]}),(()=>{const c=e.lastActiveAt||Je(e.id);return c?t.jsxs("div",{className:"text-xs text-zinc-300/90",children:["Last seen: ",We(c)]}):null})(),t.jsxs("div",{className:"space-y-2",children:[t.jsx(wt,{badges:e.profile.badges}),Array.isArray((P=e.profile)==null?void 0:P.labels)&&e.profile.labels.length>0&&t.jsx("div",{className:"flex flex-wrap gap-2",children:e.profile.labels.slice(0,7).map((c,u)=>t.jsx("span",{className:"rounded-full border border-white/10 bg-white/10 px-2.5 py-1 text-xs text-white/85",children:c},u))})]})]}),G?t.jsx(vt,{user:e,onUpdated:async()=>{const c=await ve(s);c&&n(Ee(c))},saveProfile:async c=>{await xe(c)}}):t.jsx("div",{className:"flex gap-2",children:t.jsx("button",{className:`btn ${_?"":"btn-primary"}`,onClick:()=>{a!=null&&a.id&&(_?lt(a.id,e.id):it(a.id,e.id),A(re(e.id)))},children:_?t.jsxs(t.Fragment,{children:[t.jsx(Ye,{size:16})," Отписаться"]}):t.jsxs(t.Fragment,{children:[t.jsx(qe,{size:16})," Подписаться"]})})})]})]}),i&&G&&m&&t.jsxs("div",{className:le,children:[t.jsx("div",{className:"mb-3 text-xs uppercase tracking-[0.3em] text-zinc-400/80",children:"Вторая роль"}),t.jsxs("div",{className:"flex flex-wrap items-center gap-3",children:[t.jsxs("select",{className:"input",value:((F=(q=e.profile)==null?void 0:q.privacy)==null?void 0:F.showSecondaryRole)===!1?"none":e.role,onChange:async c=>{var b;const u=c.target.value;try{const h=((b=e.profile)==null?void 0:b.privacy)||{showEmail:!1,showStats:!0};u==="none"?(await xe({privacy:{...h,showSecondaryRole:!1}}),n({...e,profile:{...e.profile,privacy:{...h,showSecondaryRole:!1}}})):(await Ge(e.id,u),await xe({privacy:{...h,showSecondaryRole:!0}}),n({...e,role:u,profile:{...e.profile,privacy:{...h,showSecondaryRole:!0}}}))}catch(h){alert((h==null?void 0:h.message)||"Не удалось изменить роль")}},children:[t.jsx("option",{value:"none",children:"Не показывать"}),t.jsx("option",{value:"developer",children:"Разработчик"}),t.jsx("option",{value:"admin",children:"Администратор"}),t.jsx("option",{value:"moderator",children:"Модератор"}),t.jsx("option",{value:"vip",children:"VIP"}),t.jsx("option",{value:"user",children:"Участник"}),t.jsx("option",{value:"newbie",children:"Новичок"})]}),t.jsx("div",{className:"text-xs text-zinc-300/80",children:"Роль владельца постоянна; здесь можно выбрать отображаемую."})]})]}),((D=(H=e.profile)==null?void 0:H.privacy)==null?void 0:D.showStats)!==!1&&t.jsxs("div",{className:"grid gap-4 sm:grid-cols-3",children:[t.jsx(ue,{value:e.posts,label:"Посты"}),t.jsx(ue,{value:e.topics,label:"Темы"}),t.jsx(ue,{value:e.likes,label:"Лайки"})]}),t.jsxs("div",{className:"grid gap-4 lg:grid-cols-[1.35fr_.85fr]",children:[t.jsx(J,{title:"О себе",children:t.jsx("p",{className:"whitespace-pre-wrap text-sm text-zinc-200/85",children:e.profile.bio||"Пока нет описания."})}),((I=(Q=e.profile)==null?void 0:Q.privacy)==null?void 0:I.showLinks)!==!1&&t.jsx(J,{title:"Ссылки",children:t.jsxs("div",{className:"flex flex-wrap gap-2 text-sm text-zinc-200/90",children:[((Z=e.profile.links)==null?void 0:Z.website)&&t.jsxs("a",{className:"inline-flex items-center gap-2 rounded-full border border-white/10 bg-white/10 px-3 py-1 hover:border-white/30",href:e.profile.links.website,target:"_blank",rel:"noreferrer",children:[t.jsx(He,{size:14})," Сайт"]}),((L=e.profile.links)==null?void 0:L.discord)&&t.jsxs("span",{className:"inline-flex items-center gap-2 rounded-full border border-white/10 bg-white/10 px-3 py-1",children:[t.jsx(je,{size:14})," ",e.profile.links.discord]}),((ee=e.profile.links)==null?void 0:ee.telegram)&&t.jsxs("span",{className:"inline-flex items-center gap-2 rounded-full border border-white/10 bg-white/10 px-3 py-1",children:[t.jsx(je,{size:14})," ",e.profile.links.telegram]}),!((te=e.profile.links)!=null&&te.website)&&!((T=e.profile.links)!=null&&T.discord)&&!((se=e.profile.links)!=null&&se.telegram)&&t.jsx("span",{className:"opacity-70",children:"Ссылки ещё не добавлены."})]})})]}),t.jsx(J,{title:"Подпись",children:t.jsx("div",{className:"whitespace-pre-wrap text-sm text-zinc-200/85",children:e.profile.signature||"Подпись не заполнена."})}),((M=(O=e.profile)==null?void 0:O.privacy)==null?void 0:M.showFollowers)!==!1&&t.jsx(J,{title:`Подписчики (${w.length})`,children:t.jsx("div",{className:"flex flex-wrap gap-2 text-sm text-zinc-200/90",children:w.length===0?t.jsx("span",{className:"opacity-70",children:"Подписчиков пока нет."}):w.slice(0,18).map(c=>{const u=f[c];return t.jsx("span",{className:"rounded-full border border-white/10 bg-white/10 px-3 py-1",children:u?t.jsx("a",{href:`/forum/profile/${u}`,className:"hover:underline",children:u}):"Участник"},c)})})}),((U=(B=e.profile)==null?void 0:B.privacy)==null?void 0:U.allowComments)!==!1&&t.jsx(J,{title:"Комментарии профиля",children:t.jsxs("div",{className:"grid gap-3",children:[(a==null?void 0:a.id)&&t.jsx(Nt,{onPost:c=>{a!=null&&a.id&&(Oe(e.id,a.id,c,{authorName:a.username}),y(E(e.id)))}}),t.jsxs("div",{className:"grid gap-2",children:[R.length===0&&t.jsx("div",{className:"text-sm text-zinc-400/80",children:"Комментариев пока нет."}),kt(R).map(c=>t.jsx(Be,{node:c,currentUserId:(a==null?void 0:a.id)||"",ownerId:e.id,resolveUsername:u=>f[u],onReply:(u,b)=>{a!=null&&a.id&&(dt(e.id,a.id,u,b,a.username),y(E(e.id)))},onDelete:u=>{a!=null&&a.id&&(mt(e.id,u,a.id),y(E(e.id)))}},c.comment.id))]})]})})]})})}function vt({user:s,onUpdated:e,saveProfile:n}){const[a,r]=d.useState(!1);return t.jsxs(t.Fragment,{children:[t.jsxs("button",{className:"btn",onClick:()=>r(!0),children:[t.jsx(Ze,{size:16})," Настроить профиль"]}),a&&t.jsx(yt,{user:s,onClose:()=>r(!1),onSaved:()=>{e(),r(!1)},saveProfile:n})]})}const jt=["Founder","Early","Contributor","VIP","Designer"];function yt({user:s,onClose:e,onSaved:n,saveProfile:a}){var O,M,B,U,c,u,b,h;const[r,i]=d.useState(s.profile.avatarData||""),[l,m]=d.useState(s.profile.bannerData||""),[p,f]=d.useState(s.profile.accentFrom||"#22d3ee"),[g,x]=d.useState(s.profile.accentTo||"#8b5cf6"),[w,A]=d.useState(s.profile.bio||""),[R,y]=d.useState(s.profile.signature||""),[_,G]=d.useState(((O=s.profile.links)==null?void 0:O.website)||""),[$,V]=d.useState(((M=s.profile.links)==null?void 0:M.discord)||""),[K,X]=d.useState(((B=s.profile.links)==null?void 0:B.telegram)||""),[z,Y]=d.useState(s.profile.badges||[]),[P,q]=d.useState(((U=s.profile.privacy)==null?void 0:U.showEmail)??!1),[F,H]=d.useState(((c=s.profile.privacy)==null?void 0:c.showStats)??!0),[D,Q]=d.useState(((u=s.profile.privacy)==null?void 0:u.showLinks)??!0),[I,Z]=d.useState(((b=s.profile.privacy)==null?void 0:b.allowComments)??!0),[L,ee]=d.useState(((h=s.profile.privacy)==null?void 0:h.showFollowers)??!0),te=o=>{Y(j=>j.includes(o)?j.filter(ae=>ae!==o):j.length>=3?j:[...j,o])},T=o=>j=>{var be;const ae=(be=j.target.files)==null?void 0:be[0];if(!ae)return;const me=new FileReader;me.onload=()=>o(String(me.result||"")),me.readAsDataURL(ae)},se=async()=>{await a({avatarData:r||void 0,bannerData:l||void 0,accentFrom:p,accentTo:g,bio:w.trim()||void 0,signature:R.trim()||void 0,links:{website:_.trim()||void 0,discord:$.trim()||void 0,telegram:K.trim()||void 0},badges:z,privacy:{showEmail:P,showStats:F,showLinks:D,allowComments:I,showFollowers:L}}),n()};return t.jsx("div",{className:"fixed inset-0 z-[120] grid place-items-center bg-black/70 px-4 py-6",children:t.jsxs("div",{className:`${le} w-[min(820px,96vw)] max-h-[90vh] overflow-y-auto space-y-5`,children:[t.jsxs("div",{className:"flex items-center justify-between",children:[t.jsx("div",{className:"text-lg font-semibold text-white",children:"Настройка профиля"}),t.jsx("button",{className:"btn",onClick:e,children:"Закрыть"})]}),t.jsxs("div",{className:"grid gap-4 sm:grid-cols-2",children:[t.jsxs("div",{className:v,children:[t.jsx("div",{className:"text-xs uppercase tracking-[0.28em] text-zinc-400/80",children:"Аватар"}),t.jsxs("div",{className:"mt-3 flex items-center gap-3",children:[t.jsx("div",{className:"h-20 w-20 rounded-full",style:{background:r?`url(${r}) center/cover`:`linear-gradient(135deg, ${p}, ${g})`}}),t.jsxs("div",{className:"flex flex-col gap-2",children:[t.jsxs("label",{className:"btn flex items-center gap-2",children:[t.jsx(Se,{size:16})," Загрузить",t.jsx("input",{type:"file",accept:"image/*",hidden:!0,onChange:T(i)})]}),r&&t.jsx("button",{className:"btn",onClick:()=>i(""),children:"Удалить"})]})]})]}),t.jsxs("div",{className:v,children:[t.jsx("div",{className:"text-xs uppercase tracking-[0.28em] text-zinc-400/80",children:"Баннер"}),t.jsx("div",{className:"mt-3 h-20 w-full rounded-xl",style:{background:l?`url(${l}) center/cover`:`linear-gradient(135deg, ${p}, ${g})`}}),t.jsxs("div",{className:"mt-3 flex gap-2",children:[t.jsxs("label",{className:"btn flex items-center gap-2",children:[t.jsx(Se,{size:16})," Загрузить",t.jsx("input",{type:"file",accept:"image/*",hidden:!0,onChange:T(m)})]}),l&&t.jsx("button",{className:"btn",onClick:()=>m(""),children:"Удалить"})]})]}),t.jsxs("div",{className:v,children:[t.jsx("div",{className:"text-xs uppercase tracking-[0.28em] text-zinc-400/80",children:"Градиент"}),t.jsxs("div",{className:"mt-3 flex items-center gap-4",children:[t.jsxs("label",{className:"flex items-center gap-2 text-xs text-zinc-400/80",children:[t.jsx("span",{children:"От"}),t.jsx("input",{type:"color",value:p,onChange:o=>f(o.target.value)})]}),t.jsxs("label",{className:"flex items-center gap-2 text-xs text-zinc-400/80",children:[t.jsx("span",{children:"До"}),t.jsx("input",{type:"color",value:g,onChange:o=>x(o.target.value)})]})]})]}),t.jsxs("div",{className:v,children:[t.jsx("div",{className:"text-xs uppercase tracking-[0.28em] text-zinc-400/80",children:"Бейджи (до 3)"}),t.jsx("div",{className:"mt-3 flex flex-wrap gap-2",children:jt.map(o=>{const j=z.includes(o);return t.jsxs("button",{className:`btn flex items-center gap-2 ${j?"btn-primary":""}`,onClick:()=>te(o),type:"button",title:j?"Нажмите, чтобы убрать":"Нажмите, чтобы добавить",children:[t.jsx(Re,{size:16})," ",o]},o)})})]}),t.jsxs("div",{className:`${v} sm:col-span-2`,children:[t.jsx("div",{className:"text-xs uppercase tracking-[0.28em] text-zinc-400/80",children:"О себе"}),t.jsx("textarea",{className:"input mt-2 min-h-[120px]",value:w,onChange:o=>A(o.target.value),placeholder:"Расскажите сообществу немного о себе"})]}),t.jsxs("div",{className:`${v} sm:col-span-2`,children:[t.jsx("div",{className:"text-xs uppercase tracking-[0.28em] text-zinc-400/80",children:"Подпись"}),t.jsx("textarea",{className:"input mt-2 min-h-[90px]",value:R,onChange:o=>y(o.target.value),placeholder:"Текст, который появится под вашими сообщениями"})]}),t.jsxs("div",{className:`${v} sm:col-span-2`,children:[t.jsx("div",{className:"text-xs uppercase tracking-[0.28em] text-zinc-400/80",children:"Ссылки"}),t.jsxs("div",{className:"mt-3 grid gap-2 sm:grid-cols-3",children:[t.jsx("input",{className:"input",placeholder:"https://website",value:_,onChange:o=>G(o.target.value)}),t.jsx("input",{className:"input",placeholder:"discord username",value:$,onChange:o=>V(o.target.value)}),t.jsx("input",{className:"input",placeholder:"@telegram",value:K,onChange:o=>X(o.target.value)})]})]}),t.jsxs("div",{className:`${v} sm:col-span-2`,children:[t.jsx("div",{className:"text-xs uppercase tracking-[0.28em] text-zinc-400/80",children:"Приватность"}),t.jsxs("div",{className:"mt-3 grid gap-2 text-sm",children:[t.jsxs("label",{className:"flex items-center gap-2",children:[t.jsx("input",{type:"checkbox",checked:P,onChange:o=>q(o.target.checked)})," Показывать e-mail"]}),t.jsxs("label",{className:"flex items-center gap-2",children:[t.jsx("input",{type:"checkbox",checked:F,onChange:o=>H(o.target.checked)})," Показывать статистику"]}),t.jsxs("label",{className:"flex items-center gap-2",children:[t.jsx("input",{type:"checkbox",checked:D,onChange:o=>Q(o.target.checked)})," Показывать ссылки"]}),t.jsxs("label",{className:"flex items-center gap-2",children:[t.jsx("input",{type:"checkbox",checked:L,onChange:o=>ee(o.target.checked)})," Показывать подписчиков"]}),t.jsxs("label",{className:"flex items-center gap-2",children:[t.jsx("input",{type:"checkbox",checked:I,onChange:o=>Z(o.target.checked)})," Разрешить комментарии"]})]})]})]}),t.jsxs("div",{className:"flex justify-end gap-2",children:[t.jsx("button",{className:"btn",onClick:e,children:"Отмена"}),t.jsx("button",{className:"btn btn-primary",onClick:se,children:"Сохранить"})]})]})})}function Nt({onPost:s}){const[e,n]=d.useState("");return t.jsxs("div",{className:v,children:[t.jsxs("div",{className:"flex items-start gap-2",children:[t.jsx(et,{size:16,className:"mt-1 shrink-0"}),t.jsx("textarea",{className:"input min-h-[80px] flex-1",placeholder:"Напишите комментарий...",value:e,onChange:a=>n(a.target.value)})]}),t.jsx("div",{className:"mt-2 flex justify-end",children:t.jsx("button",{className:"btn btn-primary",onClick:()=>{const a=e.trim();a&&(s(a),n(""))},children:"Отправить"})})]})}function kt(s){const e={};s.forEach(r=>{e[r.id]={comment:r,replies:[]}});const n=[];s.forEach(r=>{const i=r.parentId||"";i&&e[i]?e[i].replies.push(e[r.id]):n.push(e[r.id])}),n.sort((r,i)=>r.comment.createdAt<i.comment.createdAt?1:-1);const a=r=>r.replies.sort((i,l)=>i.comment.createdAt>l.comment.createdAt?1:-1).forEach(a);return n.forEach(a),n}function Be({node:s,currentUserId:e,ownerId:n,resolveUsername:a,onReply:r,onDelete:i}){const[l,m]=d.useState(!1),p=a?a(s.comment.authorId):void 0,f=s.comment.authorName||p||(s.comment.authorId===n?"Владелец":s.comment.authorId===e?"Вы":"Участник"),g=p||s.comment.authorName;return t.jsx("div",{className:v,children:t.jsxs("div",{className:"flex items-start gap-3",children:[t.jsx("div",{className:"h-8 w-8 shrink-0 rounded-full bg-gradient-to-br from-sky-500/60 to-violet-500/60"}),t.jsxs("div",{className:"min-w-0 flex-1",children:[t.jsxs("div",{className:"flex items-center justify-between gap-3",children:[t.jsxs("div",{className:"text-xs text-zinc-300/90",children:[g?t.jsx("a",{href:`/forum/profile/${g}`,className:"font-semibold text-white hover:underline",children:f}):t.jsx("span",{className:"font-semibold text-white",children:f}),t.jsxs("span",{className:"opacity-70",children:[" · ",new Date(s.comment.createdAt).toLocaleString("ru-RU")]})]}),(e===s.comment.authorId||e===n)&&t.jsx("button",{className:"btn",title:"Удалить",onClick:()=>i(s.comment.id),children:t.jsx(tt,{size:14})})]}),t.jsx("div",{className:"mt-1 whitespace-pre-wrap text-sm text-zinc-100/90",children:s.comment.content}),t.jsx(Ct,{targetId:n,commentId:s.comment.id,currentUserId:e}),t.jsx("div",{className:"mt-2 flex items-center gap-2",children:t.jsx("button",{className:"btn",onClick:()=>m(x=>!x),children:"Ответить"})}),l&&t.jsx("div",{className:"mt-2",children:t.jsx(St,{onSend:x=>{r(s.comment.id,x),m(!1)}})}),s.replies.length>0&&t.jsx("div",{className:"mt-3 space-y-2 border-l border-white/10 pl-3",children:s.replies.map(x=>t.jsx(Be,{node:x,currentUserId:e,ownerId:n,resolveUsername:a,onReply:r,onDelete:i},x.comment.id))})]})]})})}function St({onSend:s}){const[e,n]=d.useState("");return t.jsxs("div",{className:"flex items-start gap-2",children:[t.jsx("textarea",{className:"input min-h-[60px] flex-1",placeholder:"Ответ...",value:e,onChange:a=>n(a.target.value)}),t.jsx("button",{className:"btn btn-primary",onClick:()=>{const a=e.trim();a&&(s(a),n(""))},children:"Отправить"})]})}function Ct({targetId:s,commentId:e,currentUserId:n}){const[,a]=d.useReducer(m=>m+1,0),r=ut(s)[e]||{counts:{like:0,smile:0,useful:0}},i=n?pt(s,e,n):void 0,l=({r:m,label:p})=>{var f;return t.jsxs("button",{className:`btn text-xs ${i===m?"btn-primary":""}`,onClick:()=>{n&&(ft(s,e,n,m),a())},children:[p," ",(f=r.counts)!=null&&f[m]?t.jsx("span",{className:"opacity-80",children:r.counts[m]}):null]})};return t.jsxs("div",{className:"mt-2 flex flex-wrap items-center gap-2",children:[t.jsx(l,{r:"like",label:"👍"}),t.jsx(l,{r:"smile",label:"😊"}),t.jsx(l,{r:"useful",label:"💡"})]})}export{$t as default};
