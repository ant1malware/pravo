import{b as Q,k as U,j as s}from"./index-CAURlCar.js";import{u as O,e as V,R as r,L as y}from"./react-vendor-DTkXckhQ.js";import{getTopic as q,listPosts as w,listTopics as B,listSections as K,updatePost as N,toggleLikePost as X,createPost as F,deletePost as G}from"./forumRemote-D5s3MT8n.js";import{M as v}from"./MarkdownEditor-D2DK_Jvw.js";import{R as H}from"./ReactionBar-CREamPcP.js";import{s as J,a as W}from"./seo-CUoHaANs.js";import{a1 as Y,Q as Z,a4 as _,X as ee}from"./icons-vKdVo13Z.js";import"./purify.es-DnfDK_hS.js";function de(){const{id:l=""}=O(),k=V(),[a,S]=r.useState(null),[t,P]=r.useState(null),[I,o]=r.useState([]),[j,C]=r.useState([]),[p,A]=r.useState(""),[b,m]=r.useState(""),[T,u]=r.useState(null),[M,x]=r.useState(""),[L,E]=r.useState({}),h=!!a&&(a.role==="developer"||a.role==="admin"||a.role==="moderator");r.useEffect(()=>{(async()=>{try{const e=await Q();if(S(e),!e)try{k("/forum",{replace:!0})}catch{}}catch{}try{const e=await q(l);if(e){P(e);try{J(e.title,e.title)}catch{}}const i=await w(l);o(Array.isArray(i)?i:[])}catch{}try{const e=await B();C(Array.isArray(e)?e:[])}catch{}try{const e=await U(),i={};for(const c of e||[])i[c.id]=c.username;E(i)}catch{}})()},[l]),r.useEffect(()=>{(async()=>{try{if(t!=null&&t.id){const e=`${window.location.origin}/forum/topic/${t.id}`;W({title:t.title,description:t.title,url:e,canonical:e})}}catch{}try{if(t!=null&&t.sectionId){const i=(await K()||[]).find(c=>c.id===t.sectionId);i&&A(i.title||"")}}catch{}})()},[t==null?void 0:t.id,t==null?void 0:t.sectionId,t==null?void 0:t.title]);async function R(){const e=b.trim();if(!(!e||!a||!t||t.locked))try{const i=await F({topicId:t.id,content:e});o(c=>[...c,i]),m("")}catch{}}async function z(e){if(h)try{const i=await N(e.id,{pinned:!e.pinned});o(c=>c.map(n=>n.id===e.id?i:n))}catch{}}async function $(e){try{await G(e.id),o(i=>i.filter(c=>c.id!==e.id))}catch{}}const D=I.slice().sort((e,i)=>(i.pinned?1:0)-(e.pinned?1:0)||new Date(e.createdAt).getTime()-new Date(i.createdAt).getTime()),g=r.useMemo(()=>{if(!t)return[];const e=(t.title||"").toLowerCase();return j.filter(i=>i.id!==t.id&&(i.title||"").toLowerCase().includes(e.split(" ").slice(0,2).join(" "))).slice(0,5)},[j,t==null?void 0:t.id,t==null?void 0:t.title]);return s.jsx("main",{className:"min-h-screen",style:{background:"#0d0d12",color:"#f8fafc"},children:s.jsxs("div",{className:"mx-auto max-w-5xl px-4 py-6",children:[s.jsx("div",{className:"mb-4 flex items-center justify-between",children:s.jsxs("div",{className:"flex items-center gap-3",children:[s.jsxs(y,{to:"/forum",className:"btn flex items-center gap-2",children:[s.jsx(Y,{size:16})," Назад"]}),s.jsx("div",{className:"text-sm opacity-70",children:p||"Тема"})]})}),s.jsxs("div",{className:"card p-4",children:[s.jsx("div",{className:"mb-1 text-xs opacity-70",children:p}),s.jsx("h1",{className:"text-xl font-bold text-white",children:(t==null?void 0:t.title)||"..."})]}),s.jsxs("div",{className:"mt-4 grid gap-3",children:[D.map(e=>{const i=!!a&&a.id===e.authorId,c=T===e.id;return s.jsxs("div",{className:"rounded-xl border border-white/10 bg-white/[0.04] p-3 text-sm",children:[s.jsxs("div",{className:"mb-1 text-xs text-zinc-300/90",children:[(()=>{const n=L[e.authorId]||(e.authorId===(a==null?void 0:a.id)?a==null?void 0:a.username:"");return n?s.jsx(y,{to:`/forum/profile/${n}`,className:"font-semibold text-white hover:underline",children:n}):s.jsx("span",{className:"opacity-80",children:"Участник"})})(),s.jsxs("span",{className:"opacity-70",children:[" · ",new Date(e.createdAt).toLocaleString()]})]}),e.pinned&&s.jsx("span",{className:"mr-2 inline-block rounded bg-white/10 px-2 py-0.5 text-xs",children:"Pinned"}),c?s.jsx(v,{value:M,onChange:x,onSubmit:async n=>{x(n),o(f=>f.map(d=>d.id===e.id?{...d,content:n,editedAt:new Date().toISOString()}:d)),u(null);try{await N(e.id,{content:n})}catch{}},submitLabel:"Save"}):s.jsx("div",{className:"prose prose-invert max-w-none whitespace-pre-wrap",children:e.content}),!c&&s.jsxs("div",{className:"mt-2 flex items-center gap-2",children:[s.jsxs("button",{className:"btn text-xs",title:"Цитировать",onClick:()=>m(n=>n+`

> ${e.content}

`),children:[s.jsx(Z,{size:14})," Quote"]}),s.jsxs("button",{className:"btn text-xs",onClick:async()=>{try{const n=await X(e.id);o(f=>f.map(d=>d.id===e.id?n:d))}catch{}},children:["❤ ",(e.likes||[]).length]}),i&&s.jsxs("button",{className:"btn text-xs",onClick:()=>{u(e.id),x(e.content)},title:"Edit",children:[s.jsx(_,{size:14})," Edit"]})]}),c&&s.jsx("div",{className:"mt-2 flex items-center justify-end",children:s.jsxs("button",{className:"btn",onClick:()=>u(null),children:[s.jsx(ee,{size:14})," Cancel"]})}),s.jsx(H,{postId:e.id,currentUserId:a==null?void 0:a.id,onPostUpdated:async()=>{try{const n=await w(l);o(Array.isArray(n)?n:[])}catch{}}}),(h||(a==null?void 0:a.id)===e.authorId)&&s.jsxs("div",{className:"mt-2 text-right",children:[h&&s.jsx("button",{className:"btn text-xs",onClick:()=>z(e),style:{marginRight:8},children:e.pinned?"Unpin":"Pin"}),s.jsx("button",{className:"btn text-xs",onClick:()=>$(e),children:"Delete"})]})]},e.id)}),!(t!=null&&t.locked)&&a&&s.jsx(v,{value:b,onChange:m,onSubmit:()=>R(),placeholder:"Reply in Markdown...",submitLabel:"Send",draftKey:t?`forum:draft:${t.id}`:void 0}),(t==null?void 0:t.locked)&&s.jsx("div",{className:"text-xs opacity-70",children:"Topic is locked."})]}),g.length>0&&s.jsxs("div",{className:"card mt-4 p-4",children:[s.jsx("div",{className:"mb-2 text-xs uppercase tracking-[0.28em] text-zinc-400/80",children:"Похожие темы"}),s.jsx("div",{className:"grid gap-2",children:g.map(e=>s.jsxs(y,{to:`/forum/topic/${e.id}`,className:"flex items-center justify-between rounded-lg border border-white/10 bg-white/[0.03] px-3 py-2 hover:bg-white/[0.06]",children:[s.jsx("div",{className:"min-w-0 truncate font-medium",children:e.title}),s.jsxs("div",{className:"ml-2 shrink-0 text-xs opacity-70",children:["ответов ",e.replyCount]})]},e.id))})]})]})})}export{de as default};
