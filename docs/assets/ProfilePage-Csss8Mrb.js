import{f as we,n as We,o as ve,j as t,p as Ge,q as Ke,t as ue,w as Xe}from"./index-CJwLWLol.js";import{u as Ye,R as d}from"./react-vendor-DTkXckhQ.js";import{f as je,g as ye,u as qe,a as ze}from"./forumStore-C3RV0HLX.js";import{B as He,c as Qe}from"./Badge-BlD43B5Q.js";import{a0 as Ze,a1 as et,a2 as tt,a3 as Ne,a4 as ke,S as Se,a5 as Ce,a6 as st,a7 as Pe,a8 as at,M as nt,a9 as rt,aa as Ae}from"./icons-GyIOUIPt.js";const W="forum:",fe=`${W}follows`,Fe=`${W}profile_comments:`,it=`${W}social-change`,ne=new Map,ot={getItem:s=>ne.has(s)?ne.get(s):null,setItem:(s,e)=>void ne.set(s,e),removeItem:s=>void ne.delete(s)},y=(()=>{try{if(typeof window<"u"&&window.localStorage)return window.localStorage}catch{}return ot})(),Ie=typeof window<"u";function ce(){return new Date().toISOString()}function he(s,e){try{return s?JSON.parse(s):e}catch{return e}}function Le(){try{const s=typeof crypto<"u"&&crypto.randomUUID?crypto.randomUUID():null;if(s)return s}catch{}return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,s=>{const e=Math.random()*16|0;return(s==="x"?e:e&3|8).toString(16)})}function k(s){if(Ie)try{window.dispatchEvent(new CustomEvent(it,{detail:s}))}catch{}}Ie&&window.addEventListener("storage",s=>{s.key&&(s.key.startsWith(Fe)||s.key===fe)&&k({key:s.key,type:"storage"})});function de(){return he(y.getItem(fe),[])}function De(s){const e=new Set,n=[];for(const a of s){const r=`${a.followerId}=>${a.targetId}`;a.followerId!==a.targetId&&(e.has(r)||(e.add(r),n.push(a)))}try{y.setItem(fe,JSON.stringify(n))}catch{}k({scope:"follows"})}function lt(){try{const e=new URL(window.location.href),n=e.searchParams.get("api");if(n){localStorage.setItem("forum:api_base",n);try{e.searchParams.delete("api"),history.replaceState({},"",e.toString())}catch{}}const a=localStorage.getItem("forum:api_base");if(a)return a}catch{}return"https://notifications-worker.wizardiowhy.workers.dev/skyapi"}const Te=lt();function Oe(){try{return localStorage.getItem("forum:token")??sessionStorage.getItem("forum:token")}catch{return null}}async function A(s,e={}){const n=Oe(),a={"Content-Type":"application/json",...e.headers||{}};n&&(a.Authorization=`Bearer ${n}`);const r=await fetch(`${Te}${s}`,{...e,headers:a}),i=await r.text();let o={};try{o=i?JSON.parse(i):{}}catch{o={error:i||r.statusText}}if(!r.ok)throw new Error((o==null?void 0:o.error)||`${r.status} ${r.statusText}`);return o}function N(){return!!Te&&!!Oe()}function re(s){if(N())try{const e=window.__socialRemoteFollowersCache||(window.__socialRemoteFollowersCache=new Map),n=e.get(s);if(n)return n;A(`/social/followers/${encodeURIComponent(s)}`).then(a=>{try{e.set(s,Array.isArray(a.followers)?a.followers:[]),k({scope:"follows",targetId:s})}catch{}})}catch{}return de().filter(e=>e.targetId===s).map(e=>e.followerId)}function ct(s,e){if(!s)return!1;if(N())try{const n=window.__socialRemoteFollowingCache||(window.__socialRemoteFollowingCache=new Map),a=n.get(s);if(a)return a.includes(e);A(`/social/following/${encodeURIComponent(s)}`).then(r=>{try{n.set(s,Array.isArray(r.following)?r.following:[]),k({scope:"follows",followerId:s})}catch{}})}catch{}return de().some(n=>n.followerId===s&&n.targetId===e)}function dt(s,e){if(!s||!e||s===e)return;if(N())try{A("/social/follow",{method:"POST",body:JSON.stringify({targetId:e})})}catch{}const n=de();n.some(a=>a.followerId===s&&a.targetId===e)||(n.push({followerId:s,targetId:e,createdAt:ce()}),De(n))}function mt(s,e){if(N())try{A("/social/unfollow",{method:"POST",body:JSON.stringify({targetId:e})})}catch{}const n=de().filter(a=>!(a.followerId===s&&a.targetId===e));De(n)}function Be(s){return`${Fe}${s}`}function pe(s){return s.map(e=>({id:e.id??Le(),targetId:e.targetId,authorId:e.authorId,authorName:e.authorName,content:typeof e.content=="string"?e.content:"",createdAt:e.createdAt??ce(),parentId:e.parentId??null,updatedAt:e.updatedAt??null,edited:!!e.edited,deleted:!!e.deleted,deletedAt:e.deletedAt??null,deletedById:e.deletedById??null}))}function ie(s){if(N())try{const a=window.__socialRemoteCommentsCache||(window.__socialRemoteCommentsCache=new Map),r=a.get(s);if(r)return r;A(`/profiles/${encodeURIComponent(s)}/comments`).then(i=>{try{const o=pe(Array.isArray(i.comments)?i.comments:[]);a.set(s,o),k({scope:"comments",targetId:s})}catch{}})}catch{}const e=y.getItem(Be(s)),n=he(e,[]);return pe(n)}function Me(s,e){try{y.setItem(Be(s),JSON.stringify(e))}catch{}k({scope:"comments",targetId:s})}const ut=1e4;function xt(s,e){const n=`${W}last_post:${s}:${e}`,a=Number(y.getItem(n)||"0"),r=Date.now()-a>=ut;if(r)try{y.setItem(n,String(Date.now()))}catch{}return r}const _e=2e3;function R(s,e){const n=ie(s),r=!1?n:n.filter(m=>!m.deleted);r.sort((m,x)=>m.createdAt<x.createdAt?1:-1);const i=Math.max(0,0);return r.slice(i,void 0)}function Ue(s,e,n,a){const r=(n??"").trim();if(!r)throw new Error("Comment is empty");if(r.length>_e)throw new Error(`Comment too long (${r.length} > ${_e})`);if(!N()&&!xt(s,e))throw new Error("You are posting too fast. Please wait a bit.");if(N())try{A(`/profiles/${encodeURIComponent(s)}/comments`,{method:"POST",body:JSON.stringify({content:r,parentId:(a==null?void 0:a.parentId)||null})}).then(m=>{try{const x=window.__socialRemoteCommentsCache;if(x){const b=x.get(s)||[],h=pe(Array.isArray(m.comment)?m.comment:[m.comment]);x.set(s,[...h,...b]),k({scope:"comments",targetId:s})}}catch{}}).catch(()=>{})}catch{}if(a!=null&&a.parentId&&!ie(s).find(x=>x.id===a.parentId))throw new Error("Parent comment not found");const i={id:Le(),targetId:s,authorId:e,authorName:a==null?void 0:a.authorName,content:r,createdAt:ce(),parentId:(a==null?void 0:a.parentId)??null,updatedAt:null,edited:!1,deleted:!1,deletedAt:null,deletedById:null},o=ie(s);return o.unshift(i),Me(s,o),i}function pt(s,e,n,a,r){return Ue(s,e,a,{authorName:r,parentId:n})}function ft(s,e,n){if(N())try{A(`/profiles/${encodeURIComponent(s)}/comments/${encodeURIComponent(e)}`,{method:"DELETE"})}catch{}const a=ie(s),r=a.findIndex(o=>o.id===e);if(r<0)return;const i=a[r];(i.authorId===n||s===n)&&(i.deleted||(a[r]={...i,content:"",deleted:!0,deletedAt:ce(),deletedById:n},Me(s,a)))}function Je(s){return`${W}comment_reactions:${s}`}function ge(s){return he(y.getItem(Je(s)),{})}function ht(s,e){try{y.setItem(Je(s),JSON.stringify(e))}catch{}k({scope:"reactions",targetId:s})}function gt(s){return ge(s)}function bt(s,e,n){var a,r;return(r=(a=ge(s)[e])==null?void 0:a.byUser)==null?void 0:r[n]}function wt(s,e,n,a){const r=ge(s),i=r[e]||{counts:{like:0,smile:0,useful:0},byUser:{}},o=i.byUser[n];return o===a?(i.byUser[n]=void 0,i.counts[a]=Math.max(0,(i.counts[a]||0)-1)):(o&&(i.counts[o]=Math.max(0,(i.counts[o]||0)-1)),i.byUser[n]=a,i.counts[a]=(i.counts[a]||0)+1),r[e]=i,ht(s,r),i}const $e={developer:{label:"Разработчик",color:"#22d3ee",glow:"from-cyan-400/35"},admin:{label:"Администратор",color:"#ef4444",glow:"from-rose-400/35"},moderator:{label:"Модератор",color:"#8b5cf6",glow:"from-violet-400/35"},vip:{label:"VIP",color:"#eab308",glow:"from-amber-400/35"},user:{label:"Участник",color:"#94a3b8",glow:"from-slate-300/30"},newbie:{label:"Новичок",color:"#22d3ee",glow:"from-cyan-400/35"}},oe={owner:{label:"Владелец",grad:"from-amber-400 via-rose-400 to-amber-400",Icon:Ce},developer:{label:"Разработчик",grad:"from-cyan-400 via-fuchsia-400 to-cyan-400",Icon:ke},admin:{label:"Администратор",grad:"from-rose-400 via-amber-400 to-rose-400",Icon:Se},moderator:{label:"Модератор",grad:"from-violet-400 via-sky-400 to-violet-400",Icon:st},vip:{label:"VIP",grad:"from-amber-400 via-rose-400 to-amber-400",Icon:Ce},user:{label:"Участник",grad:"from-slate-300 via-slate-400 to-slate-300",Icon:Se},newbie:{label:"Новичок",grad:"from-cyan-400 via-fuchsia-400 to-cyan-400",Icon:ke}};function xe({value:s,label:e}){return t.jsxs("div",{className:`${v} text-center`,children:[t.jsx("div",{className:"text-3xl font-extrabold text-white",children:s}),t.jsx("div",{className:"mt-1 text-xs uppercase tracking-[0.3em] text-zinc-300/80",children:e})]})}function V({title:s,children:e,right:n}){return t.jsxs("div",{className:le,children:[t.jsxs("div",{className:"mb-3 flex items-center justify-between",children:[t.jsx("div",{className:"text-xs uppercase tracking-[0.3em] text-zinc-400/75",children:s}),n]}),e]})}function Re({role:s}){const e=oe[s]??oe.user,n=e.Icon;return t.jsxs("span",{className:"relative inline-flex",children:[t.jsx("span",{className:`absolute -inset-[2px] rounded-full blur-md bg-gradient-to-r ${e.grad} opacity-50`}),t.jsxs("span",{className:"relative inline-flex items-center gap-2 rounded-full border border-white/10 bg-white/5 px-3.5 py-1.5 text-[11px] font-extrabold uppercase tracking-[0.22em] text-white shadow-[0_0_0_1px_rgba(255,255,255,0.06)_inset]",children:[t.jsx(n,{size:14,className:"opacity-90"}),e.label]})]})}function vt({role:s}){const e=oe[s]??oe.user;return t.jsx("span",{className:"rounded-full border border-white/15 bg-black/50 px-2 py-0.5 text-[10px] font-bold uppercase tracking-[0.18em] text-white backdrop-blur",style:{boxShadow:"0 0 16px rgba(255,255,255,0.08), inset 0 0 0 1px rgba(255,255,255,0.05)"},children:e.label})}const jt={Founder:"from-rose-500/25 to-rose-400/10 text-rose-200",Early:"from-sky-500/25 to-sky-400/10 text-sky-200",Contributor:"from-emerald-500/25 to-emerald-400/10 text-emerald-200",VIP:"from-amber-500/25 to-amber-400/10 text-amber-200",Designer:"from-violet-500/25 to-violet-400/10 text-violet-200"},le="rounded-3xl border border-white/10 bg-[#101321]/85 p-5 shadow-[0_40px_120px_-70px_rgba(15,23,42,0.9)] backdrop-blur",v="rounded-3xl border border-white/10 bg-white/[0.05] p-4 shadow-[0_30px_90px_-70px_rgba(15,23,42,0.85)] backdrop-blur",yt=new Intl.DateTimeFormat("ru-RU",{day:"2-digit",month:"long",year:"numeric"});function Ee(s){const e=s.profile||{},n=s.stats||{},a=typeof n.posts=="number"?n.posts:0,r=typeof n.likes=="number"?n.likes:0,i=typeof n.topics=="number"?n.topics:0,o=e.accentFrom||"#8b5cf6",m=e.accentTo||"#0ea5e9",x=e.avatarData||e.avatar||e.avatarUrl||void 0,b=e.bannerData||e.banner||e.bannerUrl||void 0,h={bio:e.bio||"",signature:e.signature||"",links:e.links?{...e.links}:{},accentFrom:o,accentTo:m,avatarData:x,bannerData:b,badges:Array.isArray(e.badges)?e.badges:[],privacy:{showEmail:!1,showStats:!0,showLinks:!0,allowComments:!0,showFollowers:!0,...e.privacy||{}}};Array.isArray(e.labels)&&(h.labels=e.labels);const p={id:s.user.id,username:s.user.username,email:s.user.email,createdAt:s.user.createdAt,role:s.user.role,userNumber:s.user.userNumber,posts:a,likes:r,topics:i,profile:h,bans:null,mutes:null};return typeof n.score=="number"&&(p.score=n.score),p}function Nt({badges:s}){return!s||s.length===0?null:t.jsx("div",{className:"flex flex-wrap items-center gap-2",children:s.slice(0,3).map(e=>{const n=jt[e]||"from-white/20 to-white/5 text-zinc-200";return t.jsxs("span",{className:`inline-flex items-center gap-1 rounded-full border border-white/10 bg-gradient-to-br ${n} px-2.5 py-1 text-xs`,title:`Badge: ${e}`,children:[t.jsx(Pe,{size:14,className:"opacity-90"})," ",e]},e)})})}function Lt(){var Y,P,q,F,H,I,Q,L,Z,D,ee,T,te,se,O,ae,B,M,U,J;const{username:s=""}=Ye(),[e,n]=d.useState(null),[a,r]=d.useState(null),[i,o]=d.useState(!1),[m,x]=d.useState(!1),[b,h]=d.useState({});d.useEffect(()=>{(async()=>{var u;try{const f=await we();if(f){o(!0),r({id:f.id,username:f.username});try{const c=await We(),w={};for(const C of c)w[C.id]=C.username;h(w)}catch{}const g=await ve(s);if(g){n(Ee(g));try{x(!!((u=g.user)!=null&&u.owner))}catch{}return}}}catch{}o(!1),n(je(s)||null);const l=ye();r(l?{id:l.id,username:l.username}:null)})()},[s]),d.useEffect(()=>{const l=async()=>{try{const f=await we();if(f){r({id:f.id,username:f.username});return}}catch{}const u=ye();r(u?{id:u.id,username:u.username}:null)};return window.addEventListener("forum:session",l),window.addEventListener("storage",l),()=>{window.removeEventListener("forum:session",l),window.removeEventListener("storage",l)}},[]);const p=(e==null?void 0:e.id)||"",[S,_]=d.useState(()=>p?re(p):[]),[E,j]=d.useState(()=>p?R(p):[]),$=d.useMemo(()=>ct((a==null?void 0:a.id)||null,p),[a==null?void 0:a.id,p,S.length]);if(d.useEffect(()=>{if(!p){_([]),j([]);return}_(re(p)),j(R(p))},[p]),d.useEffect(()=>{const l=()=>{p&&(_(re(p)),j(R(p)))};return window.addEventListener("forum:social-change",l),()=>window.removeEventListener("forum:social-change",l)},[p]),!e)return t.jsx("main",{className:"min-h-screen text-slate-200",style:{background:"radial-gradient(1100px 680px at 15% -10%, rgba(56,189,248,0.18), transparent 65%), radial-gradient(1000px 720px at 90% -6%, rgba(167,139,250,0.14), transparent 70%), linear-gradient(180deg, #04060d 0%, #090b16 100%)"},children:t.jsx("div",{className:"mx-auto max-w-3xl px-4 py-16",children:t.jsx("div",{className:`${le} text-center text-sm text-zinc-300`,children:"Профиль не найден."})})});const G=(a==null?void 0:a.id)===e.id,z=e.profile.accentFrom||"#22d3ee",K=e.profile.accentTo||"#8b5cf6",X=$e[e.role]||$e.user;return t.jsx("main",{className:"min-h-screen text-slate-100",style:{background:"radial-gradient(1200px 700px at 12% -10%, rgba(56,189,248,0.18), transparent 65%), radial-gradient(1000px 720px at 90% -6%, rgba(167,139,250,0.14), transparent 70%), linear-gradient(180deg, #04060d 0%, #090b16 100%)"},children:t.jsxs("div",{className:"mx-auto max-w-5xl px-4 py-8 space-y-6",children:[t.jsxs("section",{className:"relative overflow-hidden rounded-3xl border border-white/10 bg-[#101321]/85 shadow-[0_50px_140px_-80px_rgba(15,23,42,0.9)] backdrop-blur",children:[t.jsx("div",{className:"h-[220px] w-full",style:{background:e.profile.bannerData?`url(${e.profile.bannerData}) center/cover`:`linear-gradient(135deg, ${z}, ${K})`}}),t.jsx("div",{className:"pointer-events-none absolute inset-0 bg-gradient-to-b from-black/15 via-transparent to-black/70"}),t.jsx("div",{className:"pointer-events-none absolute inset-x-0 top-0 h-32 bg-gradient-to-b from-white/10 to-transparent mix-blend-overlay"}),t.jsxs("div",{className:"relative -mt-16 flex flex-wrap items-end gap-5 px-6 pb-6",children:[t.jsxs("div",{className:"relative",children:[t.jsx("div",{className:"h-24 w-24 overflow-hidden rounded-full border-4 border-[#101321] shadow-[0_25px_70px_-35px_rgba(15,23,42,0.9)]",style:{background:e.profile.avatarData?`url(${e.profile.avatarData}) center/cover`:`linear-gradient(135deg, ${z}, ${K})`}}),t.jsx("div",{className:`absolute -inset-1 -z-10 rounded-full bg-gradient-to-br ${X.glow} to-transparent blur-lg`}),t.jsx("div",{className:"absolute -bottom-2 left-1",children:t.jsx(vt,{role:e.role})})]}),t.jsxs("div",{className:"min-w-0 flex-1 space-y-3",children:[t.jsxs("div",{className:"flex flex-wrap items-center gap-3",children:[t.jsx("h1",{className:"text-3xl font-extrabold tracking-tight text-white",children:e.username}),t.jsxs("span",{className:"rounded-full border border-white/10 bg-white/10 px-2 py-0.5 text-[11px] uppercase tracking-[0.28em] text-zinc-200/80",children:["#",e.userNumber]}),t.jsx(He,{points:e.score??Qe({posts:e.posts,likes:e.likes,topics:e.topics})})]}),t.jsxs("div",{className:"flex flex-wrap items-center gap-2",children:[m&&t.jsx(Re,{role:"owner"}),((P=(Y=e.profile)==null?void 0:Y.privacy)==null?void 0:P.showSecondaryRole)!==!1&&t.jsx(Re,{role:e.role})]}),t.jsxs("div",{className:"flex flex-wrap items-center gap-3 text-xs text-zinc-300/90",children:[t.jsxs("span",{children:["С нами с ",yt.format(new Date(e.createdAt))]}),(q=e.profile.privacy)!=null&&q.showEmail&&e.email?t.jsx("span",{className:"rounded-full border border-white/10 bg-white/10 px-2 py-1",children:e.email}):null]}),(()=>{const l=Ge(e.id);return l?t.jsxs("div",{className:"text-xs text-zinc-300/90",children:["Last seen: ",Ke(l)]}):null})(),t.jsxs("div",{className:"space-y-2",children:[t.jsx(Nt,{badges:e.profile.badges}),Array.isArray((F=e.profile)==null?void 0:F.labels)&&e.profile.labels.length>0&&t.jsx("div",{className:"flex flex-wrap gap-2",children:e.profile.labels.slice(0,7).map((l,u)=>t.jsx("span",{className:"rounded-full border border-white/10 bg-white/10 px-2.5 py-1 text-xs text-white/85",children:l},u))})]})]}),G?t.jsx(kt,{user:e,onUpdated:async()=>{if(i){const l=await ve(s);l&&n(Ee(l))}else n(je(s)||null)},saveProfile:async l=>{i?await ue(l):qe(e.id,l)}}):t.jsx("div",{className:"flex gap-2",children:t.jsx("button",{className:`btn ${$?"":"btn-primary"}`,onClick:()=>{a!=null&&a.id&&($?mt(a.id,e.id):dt(a.id,e.id),_(re(e.id)))},children:$?t.jsxs(t.Fragment,{children:[t.jsx(Ze,{size:16})," Отписаться"]}):t.jsxs(t.Fragment,{children:[t.jsx(et,{size:16})," Подписаться"]})})})]})]}),i&&G&&m&&t.jsxs("div",{className:le,children:[t.jsx("div",{className:"mb-3 text-xs uppercase tracking-[0.3em] text-zinc-400/80",children:"Вторая роль"}),t.jsxs("div",{className:"flex flex-wrap items-center gap-3",children:[t.jsxs("select",{className:"input",value:((I=(H=e.profile)==null?void 0:H.privacy)==null?void 0:I.showSecondaryRole)===!1?"none":e.role,onChange:async l=>{var f;const u=l.target.value;try{const g=((f=e.profile)==null?void 0:f.privacy)||{showEmail:!1,showStats:!0};u==="none"?(await ue({privacy:{...g,showSecondaryRole:!1}}),n({...e,profile:{...e.profile,privacy:{...g,showSecondaryRole:!1}}})):(await Xe(e.id,u),await ue({privacy:{...g,showSecondaryRole:!0}}),n({...e,role:u,profile:{...e.profile,privacy:{...g,showSecondaryRole:!0}}}))}catch(g){alert((g==null?void 0:g.message)||"Не удалось изменить роль")}},children:[t.jsx("option",{value:"none",children:"Не показывать"}),t.jsx("option",{value:"developer",children:"Разработчик"}),t.jsx("option",{value:"admin",children:"Администратор"}),t.jsx("option",{value:"moderator",children:"Модератор"}),t.jsx("option",{value:"vip",children:"VIP"}),t.jsx("option",{value:"user",children:"Участник"}),t.jsx("option",{value:"newbie",children:"Новичок"})]}),t.jsx("div",{className:"text-xs text-zinc-300/80",children:"Роль владельца постоянна; здесь можно выбрать отображаемую."})]})]}),((L=(Q=e.profile)==null?void 0:Q.privacy)==null?void 0:L.showStats)!==!1&&t.jsxs("div",{className:"grid gap-4 sm:grid-cols-3",children:[t.jsx(xe,{value:e.posts,label:"Посты"}),t.jsx(xe,{value:e.topics,label:"Темы"}),t.jsx(xe,{value:e.likes,label:"Лайки"})]}),t.jsxs("div",{className:"grid gap-4 lg:grid-cols-[1.35fr_.85fr]",children:[t.jsx(V,{title:"О себе",children:t.jsx("p",{className:"whitespace-pre-wrap text-sm text-zinc-200/85",children:e.profile.bio||"Пока нет описания."})}),((D=(Z=e.profile)==null?void 0:Z.privacy)==null?void 0:D.showLinks)!==!1&&t.jsx(V,{title:"Ссылки",children:t.jsxs("div",{className:"flex flex-wrap gap-2 text-sm text-zinc-200/90",children:[((ee=e.profile.links)==null?void 0:ee.website)&&t.jsxs("a",{className:"inline-flex items-center gap-2 rounded-full border border-white/10 bg-white/10 px-3 py-1 hover:border-white/30",href:e.profile.links.website,target:"_blank",rel:"noreferrer",children:[t.jsx(tt,{size:14})," Сайт"]}),((T=e.profile.links)==null?void 0:T.discord)&&t.jsxs("span",{className:"inline-flex items-center gap-2 rounded-full border border-white/10 bg-white/10 px-3 py-1",children:[t.jsx(Ne,{size:14})," ",e.profile.links.discord]}),((te=e.profile.links)==null?void 0:te.telegram)&&t.jsxs("span",{className:"inline-flex items-center gap-2 rounded-full border border-white/10 bg-white/10 px-3 py-1",children:[t.jsx(Ne,{size:14})," ",e.profile.links.telegram]}),!((se=e.profile.links)!=null&&se.website)&&!((O=e.profile.links)!=null&&O.discord)&&!((ae=e.profile.links)!=null&&ae.telegram)&&t.jsx("span",{className:"opacity-70",children:"Ссылки ещё не добавлены."})]})})]}),t.jsx(V,{title:"Подпись",children:t.jsx("div",{className:"whitespace-pre-wrap text-sm text-zinc-200/85",children:e.profile.signature||"Подпись не заполнена."})}),((M=(B=e.profile)==null?void 0:B.privacy)==null?void 0:M.showFollowers)!==!1&&t.jsx(V,{title:`Подписчики (${S.length})`,children:t.jsx("div",{className:"flex flex-wrap gap-2 text-sm text-zinc-200/90",children:S.length===0?t.jsx("span",{className:"opacity-70",children:"Подписчиков пока нет."}):S.slice(0,18).map(l=>{const u=ze(l),f=(u==null?void 0:u.username)||b[l];return t.jsx("span",{className:"rounded-full border border-white/10 bg-white/10 px-3 py-1",children:f?t.jsx("a",{href:`/forum/profile/${f}`,className:"hover:underline",children:f}):"Участник"},l)})})}),((J=(U=e.profile)==null?void 0:U.privacy)==null?void 0:J.allowComments)!==!1&&t.jsx(V,{title:"Комментарии профиля",children:t.jsxs("div",{className:"grid gap-3",children:[(a==null?void 0:a.id)&&t.jsx(At,{onPost:l=>{a!=null&&a.id&&(Ue(e.id,a.id,l,{authorName:a.username}),j(R(e.id)))}}),t.jsxs("div",{className:"grid gap-2",children:[E.length===0&&t.jsx("div",{className:"text-sm text-zinc-400/80",children:"Комментариев пока нет."}),_t(E).map(l=>t.jsx(Ve,{node:l,currentUserId:(a==null?void 0:a.id)||"",ownerId:e.id,onReply:(u,f)=>{a!=null&&a.id&&(pt(e.id,a.id,u,f,a.username),j(R(e.id)))},onDelete:u=>{a!=null&&a.id&&(ft(e.id,u,a.id),j(R(e.id)))}},l.comment.id))]})]})})]})})}function kt({user:s,onUpdated:e,saveProfile:n}){const[a,r]=d.useState(!1);return t.jsxs(t.Fragment,{children:[t.jsxs("button",{className:"btn",onClick:()=>r(!0),children:[t.jsx(at,{size:16})," Настроить профиль"]}),a&&t.jsx(Ct,{user:s,onClose:()=>r(!1),onSaved:()=>{e(),r(!1)},saveProfile:n})]})}const St=["Founder","Early","Contributor","VIP","Designer"];function Ct({user:s,onClose:e,onSaved:n,saveProfile:a}){var B,M,U,J,l,u,f,g;const[r,i]=d.useState(s.profile.avatarData||""),[o,m]=d.useState(s.profile.bannerData||""),[x,b]=d.useState(s.profile.accentFrom||"#22d3ee"),[h,p]=d.useState(s.profile.accentTo||"#8b5cf6"),[S,_]=d.useState(s.profile.bio||""),[E,j]=d.useState(s.profile.signature||""),[$,G]=d.useState(((B=s.profile.links)==null?void 0:B.website)||""),[z,K]=d.useState(((M=s.profile.links)==null?void 0:M.discord)||""),[X,Y]=d.useState(((U=s.profile.links)==null?void 0:U.telegram)||""),[P,q]=d.useState(s.profile.badges||[]),[F,H]=d.useState(((J=s.profile.privacy)==null?void 0:J.showEmail)??!1),[I,Q]=d.useState(((l=s.profile.privacy)==null?void 0:l.showStats)??!0),[L,Z]=d.useState(((u=s.profile.privacy)==null?void 0:u.showLinks)??!0),[D,ee]=d.useState(((f=s.profile.privacy)==null?void 0:f.allowComments)??!0),[T,te]=d.useState(((g=s.profile.privacy)==null?void 0:g.showFollowers)??!0),se=c=>{q(w=>w.includes(c)?w.filter(C=>C!==c):w.length>=3?w:[...w,c])},O=c=>w=>{var be;const C=(be=w.target.files)==null?void 0:be[0];if(!C)return;const me=new FileReader;me.onload=()=>c(String(me.result||"")),me.readAsDataURL(C)},ae=async()=>{await a({avatarData:r||void 0,bannerData:o||void 0,accentFrom:x,accentTo:h,bio:S.trim()||void 0,signature:E.trim()||void 0,links:{website:$.trim()||void 0,discord:z.trim()||void 0,telegram:X.trim()||void 0},badges:P,privacy:{showEmail:F,showStats:I,showLinks:L,allowComments:D,showFollowers:T}}),n()};return t.jsx("div",{className:"fixed inset-0 z-[120] grid place-items-center bg-black/70 px-4 py-6",children:t.jsxs("div",{className:`${le} w-[min(820px,96vw)] max-h-[90vh] overflow-y-auto space-y-5`,children:[t.jsxs("div",{className:"flex items-center justify-between",children:[t.jsx("div",{className:"text-lg font-semibold text-white",children:"Настройка профиля"}),t.jsx("button",{className:"btn",onClick:e,children:"Закрыть"})]}),t.jsxs("div",{className:"grid gap-4 sm:grid-cols-2",children:[t.jsxs("div",{className:v,children:[t.jsx("div",{className:"text-xs uppercase tracking-[0.28em] text-zinc-400/80",children:"Аватар"}),t.jsxs("div",{className:"mt-3 flex items-center gap-3",children:[t.jsx("div",{className:"h-20 w-20 rounded-full",style:{background:r?`url(${r}) center/cover`:`linear-gradient(135deg, ${x}, ${h})`}}),t.jsxs("div",{className:"flex flex-col gap-2",children:[t.jsxs("label",{className:"btn flex items-center gap-2",children:[t.jsx(Ae,{size:16})," Загрузить",t.jsx("input",{type:"file",accept:"image/*",hidden:!0,onChange:O(i)})]}),r&&t.jsx("button",{className:"btn",onClick:()=>i(""),children:"Удалить"})]})]})]}),t.jsxs("div",{className:v,children:[t.jsx("div",{className:"text-xs uppercase tracking-[0.28em] text-zinc-400/80",children:"Баннер"}),t.jsx("div",{className:"mt-3 h-20 w-full rounded-xl",style:{background:o?`url(${o}) center/cover`:`linear-gradient(135deg, ${x}, ${h})`}}),t.jsxs("div",{className:"mt-3 flex gap-2",children:[t.jsxs("label",{className:"btn flex items-center gap-2",children:[t.jsx(Ae,{size:16})," Загрузить",t.jsx("input",{type:"file",accept:"image/*",hidden:!0,onChange:O(m)})]}),o&&t.jsx("button",{className:"btn",onClick:()=>m(""),children:"Удалить"})]})]}),t.jsxs("div",{className:v,children:[t.jsx("div",{className:"text-xs uppercase tracking-[0.28em] text-zinc-400/80",children:"Градиент"}),t.jsxs("div",{className:"mt-3 flex items-center gap-4",children:[t.jsxs("label",{className:"flex items-center gap-2 text-xs text-zinc-400/80",children:[t.jsx("span",{children:"От"}),t.jsx("input",{type:"color",value:x,onChange:c=>b(c.target.value)})]}),t.jsxs("label",{className:"flex items-center gap-2 text-xs text-zinc-400/80",children:[t.jsx("span",{children:"До"}),t.jsx("input",{type:"color",value:h,onChange:c=>p(c.target.value)})]})]})]}),t.jsxs("div",{className:v,children:[t.jsx("div",{className:"text-xs uppercase tracking-[0.28em] text-zinc-400/80",children:"Бейджи (до 3)"}),t.jsx("div",{className:"mt-3 flex flex-wrap gap-2",children:St.map(c=>{const w=P.includes(c);return t.jsxs("button",{className:`btn flex items-center gap-2 ${w?"btn-primary":""}`,onClick:()=>se(c),type:"button",title:w?"Нажмите, чтобы убрать":"Нажмите, чтобы добавить",children:[t.jsx(Pe,{size:16})," ",c]},c)})})]}),t.jsxs("div",{className:`${v} sm:col-span-2`,children:[t.jsx("div",{className:"text-xs uppercase tracking-[0.28em] text-zinc-400/80",children:"О себе"}),t.jsx("textarea",{className:"input mt-2 min-h-[120px]",value:S,onChange:c=>_(c.target.value),placeholder:"Расскажите сообществу немного о себе"})]}),t.jsxs("div",{className:`${v} sm:col-span-2`,children:[t.jsx("div",{className:"text-xs uppercase tracking-[0.28em] text-zinc-400/80",children:"Подпись"}),t.jsx("textarea",{className:"input mt-2 min-h-[90px]",value:E,onChange:c=>j(c.target.value),placeholder:"Текст, который появится под вашими сообщениями"})]}),t.jsxs("div",{className:`${v} sm:col-span-2`,children:[t.jsx("div",{className:"text-xs uppercase tracking-[0.28em] text-zinc-400/80",children:"Ссылки"}),t.jsxs("div",{className:"mt-3 grid gap-2 sm:grid-cols-3",children:[t.jsx("input",{className:"input",placeholder:"https://website",value:$,onChange:c=>G(c.target.value)}),t.jsx("input",{className:"input",placeholder:"discord username",value:z,onChange:c=>K(c.target.value)}),t.jsx("input",{className:"input",placeholder:"@telegram",value:X,onChange:c=>Y(c.target.value)})]})]}),t.jsxs("div",{className:`${v} sm:col-span-2`,children:[t.jsx("div",{className:"text-xs uppercase tracking-[0.28em] text-zinc-400/80",children:"Приватность"}),t.jsxs("div",{className:"mt-3 grid gap-2 text-sm",children:[t.jsxs("label",{className:"flex items-center gap-2",children:[t.jsx("input",{type:"checkbox",checked:F,onChange:c=>H(c.target.checked)})," Показывать e-mail"]}),t.jsxs("label",{className:"flex items-center gap-2",children:[t.jsx("input",{type:"checkbox",checked:I,onChange:c=>Q(c.target.checked)})," Показывать статистику"]}),t.jsxs("label",{className:"flex items-center gap-2",children:[t.jsx("input",{type:"checkbox",checked:L,onChange:c=>Z(c.target.checked)})," Показывать ссылки"]}),t.jsxs("label",{className:"flex items-center gap-2",children:[t.jsx("input",{type:"checkbox",checked:T,onChange:c=>te(c.target.checked)})," Показывать подписчиков"]}),t.jsxs("label",{className:"flex items-center gap-2",children:[t.jsx("input",{type:"checkbox",checked:D,onChange:c=>ee(c.target.checked)})," Разрешить комментарии"]})]})]})]}),t.jsxs("div",{className:"flex justify-end gap-2",children:[t.jsx("button",{className:"btn",onClick:e,children:"Отмена"}),t.jsx("button",{className:"btn btn-primary",onClick:ae,children:"Сохранить"})]})]})})}function At({onPost:s}){const[e,n]=d.useState("");return t.jsxs("div",{className:v,children:[t.jsxs("div",{className:"flex items-start gap-2",children:[t.jsx(nt,{size:16,className:"mt-1 shrink-0"}),t.jsx("textarea",{className:"input min-h-[80px] flex-1",placeholder:"Напишите комментарий...",value:e,onChange:a=>n(a.target.value)})]}),t.jsx("div",{className:"mt-2 flex justify-end",children:t.jsx("button",{className:"btn btn-primary",onClick:()=>{const a=e.trim();a&&(s(a),n(""))},children:"Отправить"})})]})}function _t(s){const e={};s.forEach(r=>{e[r.id]={comment:r,replies:[]}});const n=[];s.forEach(r=>{const i=r.parentId||"";i&&e[i]?e[i].replies.push(e[r.id]):n.push(e[r.id])}),n.sort((r,i)=>r.comment.createdAt<i.comment.createdAt?1:-1);const a=r=>r.replies.sort((i,o)=>i.comment.createdAt>o.comment.createdAt?1:-1).forEach(a);return n.forEach(a),n}function Ve({node:s,currentUserId:e,ownerId:n,onReply:a,onDelete:r}){const[i,o]=d.useState(!1),m=ze(s.comment.authorId),x=s.comment.authorName||(m==null?void 0:m.username)||(s.comment.authorId===n?"Владелец":s.comment.authorId===e?"Вы":"Участник"),b=(m==null?void 0:m.username)||s.comment.authorName;return t.jsx("div",{className:v,children:t.jsxs("div",{className:"flex items-start gap-3",children:[t.jsx("div",{className:"h-8 w-8 shrink-0 rounded-full bg-gradient-to-br from-sky-500/60 to-violet-500/60"}),t.jsxs("div",{className:"min-w-0 flex-1",children:[t.jsxs("div",{className:"flex items-center justify-between gap-3",children:[t.jsxs("div",{className:"text-xs text-zinc-300/90",children:[b?t.jsx("a",{href:`/forum/profile/${b}`,className:"font-semibold text-white hover:underline",children:x}):t.jsx("span",{className:"font-semibold text-white",children:x}),t.jsxs("span",{className:"opacity-70",children:[" · ",new Date(s.comment.createdAt).toLocaleString("ru-RU")]})]}),(e===s.comment.authorId||e===n)&&t.jsx("button",{className:"btn",title:"Удалить",onClick:()=>r(s.comment.id),children:t.jsx(rt,{size:14})})]}),t.jsx("div",{className:"mt-1 whitespace-pre-wrap text-sm text-zinc-100/90",children:s.comment.content}),t.jsx(Rt,{targetId:n,commentId:s.comment.id,currentUserId:e}),t.jsx("div",{className:"mt-2 flex items-center gap-2",children:t.jsx("button",{className:"btn",onClick:()=>o(h=>!h),children:"Ответить"})}),i&&t.jsx("div",{className:"mt-2",children:t.jsx($t,{onSend:h=>{a(s.comment.id,h),o(!1)}})}),s.replies.length>0&&t.jsx("div",{className:"mt-3 space-y-2 border-l border-white/10 pl-3",children:s.replies.map(h=>t.jsx(Ve,{node:h,currentUserId:e,ownerId:n,onReply:a,onDelete:r},h.comment.id))})]})]})})}function $t({onSend:s}){const[e,n]=d.useState("");return t.jsxs("div",{className:"flex items-start gap-2",children:[t.jsx("textarea",{className:"input min-h-[60px] flex-1",placeholder:"Ответ...",value:e,onChange:a=>n(a.target.value)}),t.jsx("button",{className:"btn btn-primary",onClick:()=>{const a=e.trim();a&&(s(a),n(""))},children:"Отправить"})]})}function Rt({targetId:s,commentId:e,currentUserId:n}){const[,a]=d.useReducer(m=>m+1,0),r=gt(s)[e]||{counts:{like:0,smile:0,useful:0}},i=n?bt(s,e,n):void 0,o=({r:m,label:x})=>{var b;return t.jsxs("button",{className:`btn text-xs ${i===m?"btn-primary":""}`,onClick:()=>{n&&(wt(s,e,n,m),a())},children:[x," ",(b=r.counts)!=null&&b[m]?t.jsx("span",{className:"opacity-80",children:r.counts[m]}):null]})};return t.jsxs("div",{className:"mt-2 flex flex-wrap items-center gap-2",children:[t.jsx(o,{r:"like",label:"👍"}),t.jsx(o,{r:"smile",label:"😊"}),t.jsx(o,{r:"useful",label:"💡"})]})}export{Lt as default};
