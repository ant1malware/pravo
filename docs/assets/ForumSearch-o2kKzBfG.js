import{j as s}from"./index-BkPrgxUx.js";import{R as a}from"./react-vendor-DTkXckhQ.js";import{listSections as P,listTopics as R,listPosts as $}from"./forumRemote-D5s3MT8n.js";import{a as z,au as E,av as I}from"./icons-ByfTEOcz.js";function v(l){return(l||"").toLowerCase().normalize("NFKD")}function K(){const[l,w]=a.useState(""),[h,b]=a.useState([]),[m,j]=a.useState([]),[x,g]=a.useState({}),[d,C]=a.useState(!1),[p,S]=a.useState("any"),[y,A]=a.useState(!1),[f,F]=a.useState("relevance"),[T,N]=a.useState(!1);a.useEffect(()=>{let e=!0;return(async()=>{try{const[n,c]=await Promise.all([P(),R()]);if(!e)return;b(Array.isArray(n)?n:[]),j(Array.isArray(c)?c:[])}catch{if(!e)return;b([]),j([])}})(),()=>{e=!1}},[]),a.useEffect(()=>{if(!d)return;let e=!1;return(async()=>{for(const n of m){if(e)break;if(!x[n.id])try{const c=await $(n.id);g(r=>({...r,[n.id]:c}))}catch{}}})(),()=>{e=!0}},[d,m.length]);const k=a.useMemo(()=>{const e=[],n=v(l).trim();if(!n)return e;const c=t=>{if(!t||p==="any")return!0;const o=Date.now()-new Date(t).getTime(),i=24*60*60*1e3;return p==="24h"?o<=i:p==="7d"?o<=7*i:p==="30d"?o<=30*i:!0};for(const t of m){if(y&&t.replyCount>0||!c(t.updatedAt))continue;if(v(t.title||"").includes(n)&&e.push({kind:"topic",topic:t,section:h.find(i=>i.id===t.sectionId)}),d){const i=x[t.id]||[];for(const u of i)c(u.createdAt)&&v(u.content).includes(n)&&e.push({kind:"post",post:u,topic:t,section:h.find(D=>D.id===t.sectionId)})}}const r=t=>{var o,i;if(f==="newest"){const u=t.kind==="topic"?t.topic.updatedAt:t.post.createdAt;return new Date(u).getTime()}return f==="popular"?t.kind==="topic"?(t.topic.replyCount||0)*10+(t.topic.viewCount||0):(((o=t.topic)==null?void 0:o.replyCount)||0)*10+(((i=t.topic)==null?void 0:i.viewCount)||0):t.kind==="topic"?2:1};return e.sort((t,o)=>r(o)-r(t)).slice(0,50)},[l,m,x,h,d,p,y,f]);return s.jsxs("div",{className:"card p-3",children:[s.jsxs("div",{className:"flex flex-wrap items-center gap-2",children:[s.jsxs("div",{className:"relative flex-1 min-w-[200px]",children:[s.jsx(z,{className:"absolute left-2 top-2.5 h-4 w-4 opacity-60"}),s.jsx("input",{id:"forum-search-input",className:"input pl-8",placeholder:"Поиск по темам и постам",value:l,onChange:e=>w(e.target.value),onFocus:()=>N(!0)})]}),s.jsxs("button",{className:"btn",onClick:()=>N(e=>!e),children:[s.jsx(E,{className:"h-4 w-4"})," Фильтры ",s.jsx(I,{size:14})]})]}),T&&s.jsxs("div",{className:"mt-2 flex flex-wrap items-center gap-2 text-xs",children:[s.jsxs("label",{className:"btn",children:[s.jsx("input",{type:"checkbox",className:"mr-2",checked:d,onChange:e=>C(e.target.checked)})," Искать в постах"]}),s.jsxs("label",{className:"btn",children:[s.jsx("input",{type:"checkbox",className:"mr-2",checked:y,onChange:e=>A(e.target.checked)})," Без ответов"]}),s.jsxs("div",{className:"flex items-center gap-1",children:[s.jsx("span",{className:"opacity-70",children:"Период:"}),["any","24h","7d","30d"].map(e=>s.jsx("button",{className:`tab ${p===e?"tab-active":""}`,onClick:()=>S(e),children:e==="any"?"За всё время":e},e))]}),s.jsxs("div",{className:"flex items-center gap-1",children:[s.jsx("span",{className:"opacity-70",children:"Сортировка:"}),["relevance","newest","popular"].map(e=>s.jsx("button",{className:`tab ${f===e?"tab-active":""}`,onClick:()=>F(e),children:e==="relevance"?"релевантность":e==="newest"?"новые":"популярное"},e))]})]}),!!l.trim()&&s.jsxs("div",{className:"mt-3 grid gap-2",children:[k.length===0&&s.jsx("div",{className:"rounded-xl border p-3 text-sm opacity-70",style:{borderColor:"var(--border)",background:"var(--surface-2)"},children:"Ничего не найдено. Попробуйте изменить запрос или фильтры."}),k.map((e,n)=>{var c,r,t;return s.jsxs("a",{href:e.kind==="topic"?`/forum/topic/${e.topic.id}`:`/forum/topic/${((c=e.topic)==null?void 0:c.id)||""}`,className:"block rounded-xl border p-3 hover:bg-white/5",style:{borderColor:"var(--border)",background:"var(--surface)"},children:[s.jsxs("div",{className:"text-xs opacity-70 mb-0.5",children:[((r=e.section)==null?void 0:r.title)||"Раздел"," ",e.kind==="post"?"• Пост":"• Тема"]}),s.jsx("div",{className:"font-semibold truncate",children:e.kind==="topic"?e.topic.title:((t=e.topic)==null?void 0:t.title)||"..."}),e.kind==="post"&&s.jsx("div",{className:"mt-1 line-clamp-2 text-sm opacity-80",children:e.post.content})]},n)})]})]})}export{K as F};
