import{j as u}from"./index-SvquseAp.js";import{R as n}from"./react-vendor-DTkXckhQ.js";import{listSections as B,listTopics as T,listPosts as P}from"./forumRemote-D5s3MT8n.js";import{a as R,am as $,an as z}from"./icons-wEjUy8Cq.js";function b(r){return(r||"").toLowerCase().normalize("NFKD")}function K(){const[r,k]=n.useState(""),[h,v]=n.useState([]),[m,j]=n.useState([]),[x,E]=n.useState({}),[p,w]=n.useState(!1),[l,g]=n.useState("any"),[y,F]=n.useState(!1),[f,D]=n.useState("relevance"),[S,C]=n.useState(!1);n.useEffect(()=>{let e=!0;return(async()=>{try{const[s,a]=await Promise.all([B(),T()]);if(!e)return;v(Array.isArray(s)?s:[]),j(Array.isArray(a)?a:[])}catch{if(!e)return;v([]),j([])}})(),()=>{e=!1}},[]),n.useEffect(()=>{if(!p)return;let e=!1;return(async()=>{for(const s of m){if(e)break;if(!x[s.id])try{const a=await P(s.id);E(o=>({...o,[s.id]:a}))}catch{}}})(),()=>{e=!0}},[p,m.length]);const N=n.useMemo(()=>{const e=[],s=b(r).trim();if(!s)return e;const a=t=>{if(!t||l==="any")return!0;const i=Date.now()-new Date(t).getTime(),c=24*60*60*1e3;return l==="24h"?i<=c:l==="7d"?i<=7*c:l==="30d"?i<=30*c:!0};for(const t of m){if(y&&t.replyCount>0||!a(t.updatedAt))continue;if(b(t.title||"").includes(s)&&e.push({kind:"topic",topic:t,section:h.find(c=>c.id===t.sectionId)}),p){const c=x[t.id]||[];for(const d of c)a(d.createdAt)&&b(d.content).includes(s)&&e.push({kind:"post",post:d,topic:t,section:h.find(A=>A.id===t.sectionId)})}}const o=t=>{var i,c;if(f==="newest"){const d=t.kind==="topic"?t.topic.updatedAt:t.post.createdAt;return new Date(d).getTime()}return f==="popular"?t.kind==="topic"?(t.topic.replyCount||0)*10+(t.topic.viewCount||0):(((i=t.topic)==null?void 0:i.replyCount)||0)*10+(((c=t.topic)==null?void 0:c.viewCount)||0):t.kind==="topic"?2:1};return e.sort((t,i)=>o(i)-o(t)).slice(0,50)},[r,m,x,h,p,l,y,f]);return u.jsxs("div",{className:"card p-3",children:[u.jsxs("div",{className:"flex flex-wrap items-center gap-2",children:[u.jsxs("div",{className:"relative flex-1 min-w-[200px]",children:[u.jsx(R,{className:"absolute left-2 top-2.5 h-4 w-4 opacity-60"}),u.jsx("input",{id:"forum-search-input",className:"input pl-8",placeholder:"\u041F\u043E\u0438\u0441\u043A \u043F\u043E \u0442\u0435\u043C\u0430\u043C \u0438 \u043F\u043E\u0441\u0442\u0430\u043C",value:r,onChange:e=>k(e.target.value),onFocus:()=>C(!0)})]}),u.jsxs("button",{className:"btn",onClick:()=>C(e=>!e),children:[u.jsx($,{className:"h-4 w-4"})," \u0424\u0438\u043B\u044C\u0442\u0440\u044B ",u.jsx(z,{size:14})]})]}),S&&u.jsxs("div",{className:"mt-2 flex flex-wrap items-center gap-2 text-xs",children:[u.jsxs("label",{className:"btn",children:[u.jsx("input",{type:"checkbox",className:"mr-2",checked:p,onChange:e=>w(e.target.checked)})," \u0418\u0441\u043A\u0430\u0442\u044C \u0432 \u043F\u043E\u0441\u0442\u0430\u0445"]}),u.jsxs("label",{className:"btn",children:[u.jsx("input",{type:"checkbox",className:"mr-2",checked:y,onChange:e=>F(e.target.checked)})," \u0411\u0435\u0437 \u043E\u0442\u0432\u0435\u0442\u043E\u0432"]}),u.jsxs("div",{className:"flex items-center gap-1",children:[u.jsx("span",{className:"opacity-70",children:"\u041F\u0435\u0440\u0438\u043E\u0434:"}),["any","24h","7d","30d"].map(e=>u.jsx("button",{className:`tab ${l===e?"tab-active":""}`,onClick:()=>g(e),children:e==="any"?"\u0417\u0430 \u0432\u0441\u0451 \u0432\u0440\u0435\u043C\u044F":e},e))]}),u.jsxs("div",{className:"flex items-center gap-1",children:[u.jsx("span",{className:"opacity-70",children:"\u0421\u043E\u0440\u0442\u0438\u0440\u043E\u0432\u043A\u0430:"}),["relevance","newest","popular"].map(e=>u.jsx("button",{className:`tab ${f===e?"tab-active":""}`,onClick:()=>D(e),children:e==="relevance"?"\u0440\u0435\u043B\u0435\u0432\u0430\u043D\u0442\u043D\u043E\u0441\u0442\u044C":e==="newest"?"\u043D\u043E\u0432\u044B\u0435":"\u043F\u043E\u043F\u0443\u043B\u044F\u0440\u043D\u043E\u0435"},e))]})]}),!!r.trim()&&u.jsxs("div",{className:"mt-3 grid gap-2",children:[N.length===0&&u.jsx("div",{className:"rounded-xl border p-3 text-sm opacity-70",style:{borderColor:"var(--border)",background:"var(--surface-2)"},children:"\u041D\u0438\u0447\u0435\u0433\u043E \u043D\u0435 \u043D\u0430\u0439\u0434\u0435\u043D\u043E. \u041F\u043E\u043F\u0440\u043E\u0431\u0443\u0439\u0442\u0435 \u0438\u0437\u043C\u0435\u043D\u0438\u0442\u044C \u0437\u0430\u043F\u0440\u043E\u0441 \u0438\u043B\u0438 \u0444\u0438\u043B\u044C\u0442\u0440\u044B."}),N.map((e,s)=>{var a,o,t;return u.jsxs("a",{href:e.kind==="topic"?`/forum/topic/${e.topic.id}`:`/forum/topic/${((a=e.topic)==null?void 0:a.id)||""}`,className:"block rounded-xl border p-3 hover:bg-white/5",style:{borderColor:"var(--border)",background:"var(--surface)"},children:[u.jsxs("div",{className:"text-xs opacity-70 mb-0.5",children:[((o=e.section)==null?void 0:o.title)||"\u0420\u0430\u0437\u0434\u0435\u043B"," ",e.kind==="post"?"\u2022 \u041F\u043E\u0441\u0442":"\u2022 \u0422\u0435\u043C\u0430"]}),u.jsx("div",{className:"font-semibold truncate",children:e.kind==="topic"?e.topic.title:((t=e.topic)==null?void 0:t.title)||"..."}),e.kind==="post"&&u.jsx("div",{className:"mt-1 line-clamp-2 text-sm opacity-80",children:e.post.content})]},s)})]})]})}export{K as F};
