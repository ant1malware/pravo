import{j as t}from"./index-Co1JD_1i.js";import{R as a,b as L,L as $}from"./react-vendor-DTkXckhQ.js";import{g as E,F as R}from"./ForumSubnav-B2W0LlP6.js";import{l as M,b as C,d as z}from"./forumRemote-BYvX5m8l.js";import{a as I,ar as U,as as q}from"./icons-B96iOv9Z.js";import{s as B}from"./seo-CqyG8vOX.js";function w(o){return(o||"").toLowerCase().normalize("NFKD")}function O(){const[o,u]=a.useState(""),[r,c]=a.useState([]),[n,m]=a.useState([]),[f,y]=a.useState({}),[b,S]=a.useState(!1),[x,A]=a.useState("any"),[N,F]=a.useState(!1),[v,D]=a.useState("relevance"),[T,g]=a.useState(!1);a.useEffect(()=>{let e=!0;return(async()=>{try{const[i,l]=await Promise.all([M(),C()]);if(!e)return;c(Array.isArray(i)?i:[]),m(Array.isArray(l)?l:[])}catch{if(!e)return;c([]),m([])}})(),()=>{e=!1}},[]),a.useEffect(()=>{if(!b)return;let e=!1;return(async()=>{for(const i of n){if(e)break;if(!f[i.id])try{const l=await z(i.id);y(h=>({...h,[i.id]:l}))}catch{}}})(),()=>{e=!0}},[b,n.length]);const k=a.useMemo(()=>{const e=[],i=w(o).trim();if(!i)return e;const l=s=>{if(!s||x==="any")return!0;const p=Date.now()-new Date(s).getTime(),d=24*60*60*1e3;return x==="24h"?p<=d:x==="7d"?p<=7*d:x==="30d"?p<=30*d:!0};for(const s of n){if(N&&s.replyCount>0||!l(s.updatedAt))continue;if(w(s.title||"").includes(i)&&e.push({kind:"topic",topic:s,section:r.find(d=>d.id===s.sectionId)}),b){const d=f[s.id]||[];for(const j of d)l(j.createdAt)&&w(j.content).includes(i)&&e.push({kind:"post",post:j,topic:s,section:r.find(P=>P.id===s.sectionId)})}}const h=s=>{var p,d;if(v==="newest"){const j=s.kind==="topic"?s.topic.updatedAt:s.post.createdAt;return new Date(j).getTime()}return v==="popular"?s.kind==="topic"?(s.topic.replyCount||0)*10+(s.topic.viewCount||0):(((p=s.topic)==null?void 0:p.replyCount)||0)*10+(((d=s.topic)==null?void 0:d.viewCount)||0):s.kind==="topic"?2:1};return e.sort((s,p)=>h(p)-h(s)).slice(0,50)},[o,n,f,r,b,x,N,v]);return t.jsxs("div",{className:"card p-3",children:[t.jsxs("div",{className:"flex flex-wrap items-center gap-2",children:[t.jsxs("div",{className:"relative flex-1 min-w-[200px]",children:[t.jsx(I,{className:"absolute left-2 top-2.5 h-4 w-4 opacity-60"}),t.jsx("input",{className:"input pl-8",placeholder:"Поиск по темам и постам",value:o,onChange:e=>u(e.target.value),onFocus:()=>g(!0)})]}),t.jsxs("button",{className:"btn",onClick:()=>g(e=>!e),children:[t.jsx(U,{className:"h-4 w-4"})," Фильтры ",t.jsx(q,{size:14})]})]}),T&&t.jsxs("div",{className:"mt-2 flex flex-wrap items-center gap-2 text-xs",children:[t.jsxs("label",{className:"btn",children:[t.jsx("input",{type:"checkbox",className:"mr-2",checked:b,onChange:e=>S(e.target.checked)})," Искать в постах"]}),t.jsxs("label",{className:"btn",children:[t.jsx("input",{type:"checkbox",className:"mr-2",checked:N,onChange:e=>F(e.target.checked)})," Без ответов"]}),t.jsxs("div",{className:"flex items-center gap-1",children:[t.jsx("span",{className:"opacity-70",children:"Период:"}),["any","24h","7d","30d"].map(e=>t.jsx("button",{className:`tab ${x===e?"tab-active":""}`,onClick:()=>A(e),children:e==="any"?"За всё время":e},e))]}),t.jsxs("div",{className:"flex items-center gap-1",children:[t.jsx("span",{className:"opacity-70",children:"Сортировка:"}),["relevance","newest","popular"].map(e=>t.jsx("button",{className:`tab ${v===e?"tab-active":""}`,onClick:()=>D(e),children:e==="relevance"?"релевантность":e==="newest"?"новые":"популярное"},e))]})]}),!!o.trim()&&t.jsxs("div",{className:"mt-3 grid gap-2",children:[k.length===0&&t.jsx("div",{className:"rounded-xl border p-3 text-sm opacity-70",style:{borderColor:"var(--border)",background:"var(--surface-2)"},children:"Ничего не найдено. Попробуйте изменить запрос или фильтры."}),k.map((e,i)=>{var l,h,s;return t.jsxs("a",{href:e.kind==="topic"?`/forum/topic/${e.topic.id}`:`/forum/topic/${((l=e.topic)==null?void 0:l.id)||""}`,className:"block rounded-xl border p-3 hover:bg-white/5",style:{borderColor:"var(--border)",background:"var(--surface)"},children:[t.jsxs("div",{className:"text-xs opacity-70 mb-0.5",children:[((h=e.section)==null?void 0:h.title)||"Раздел"," ",e.kind==="post"?"• Пост":"• Тема"]}),t.jsx("div",{className:"font-semibold truncate",children:e.kind==="topic"?e.topic.title:((s=e.topic)==null?void 0:s.title)||"..."}),e.kind==="post"&&t.jsx("div",{className:"mt-1 line-clamp-2 text-sm opacity-80",children:e.post.content})]},i)})]})]})}function X(){const o=L(),u=new URLSearchParams(o.search||"").get("feed"),[r,c]=a.useState(u||E()),[n,m]=a.useState([]);return a.useEffect(()=>{try{B("Ленты — Форум","Горячее, новое и вопросы форума")}catch{}},[]),a.useEffect(()=>{let f=!0;return(async()=>{try{const y=await C();f&&m(y||[])}catch{f&&m([])}})(),()=>{f=!1}},[]),a.useEffect(()=>{u&&c(u)},[u]),t.jsx("main",{className:"min-h-screen",style:{background:"#0d0d12",color:"#f8fafc"},children:t.jsxs("div",{className:"mx-auto max-w-6xl px-4 py-6",children:[t.jsx(R,{}),t.jsxs("div",{className:"mb-4 flex items-center gap-2",children:[t.jsx("button",{className:`tab ${r==="hot"?"tab-active":""}`,onClick:()=>c("hot"),children:"Горячее"}),t.jsx("button",{className:`tab ${r==="new"?"tab-active":""}`,onClick:()=>c("new"),children:"Новое"}),t.jsx($,{className:"tab",to:"/forum/questions",children:"Вопросы"})]}),t.jsx(O,{}),t.jsx("div",{className:"mt-4",children:t.jsx(K,{feed:r,topics:n})})]})})}function K({feed:o,topics:u}){const r=a.useMemo(()=>{const c=(u||[]).slice();return o==="new"?c.sort((n,m)=>new Date(m.createdAt).getTime()-new Date(n.createdAt).getTime()).slice(0,20):c.map(n=>({t:n,s:(n.replyCount||0)*2+(n.viewCount||0)*.1-Math.max(0,(Date.now()-new Date(n.updatedAt).getTime())/36e5)*.02})).sort((n,m)=>m.s-n.s).slice(0,20).map(n=>n.t)},[o,u]);return r.length===0?t.jsx("div",{className:"card p-4 text-sm opacity-70",children:"Лента пуста."}):t.jsx("div",{className:"grid gap-3",children:r.map(c=>t.jsxs("a",{href:`/forum/topic/${c.id}`,className:"block rounded-xl border border-white/10 bg-white/[0.04] p-3",children:[t.jsx("div",{className:"font-semibold truncate",children:c.title}),t.jsxs("div",{className:"mt-1 text-xs opacity-70",children:["Ответов ",c.replyCount," • Просмотры ",c.viewCount," • Обновлено ",new Date(c.updatedAt).toLocaleString()]})]},c.id))})}export{X as default};
