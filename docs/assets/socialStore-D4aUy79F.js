const m="forum:",g=`${m}follows`,_=`${m}profile_comments:`,b=`${m}social-change`,w=new Map,M={getItem:e=>w.has(e)?w.get(e):null,setItem:(e,t)=>void w.set(e,t),removeItem:e=>void w.delete(e)},a=(()=>{try{if(typeof window<"u"&&window.localStorage)return window.localStorage}catch{}return M})(),$=typeof window<"u";function p(){return new Date().toISOString()}function S(e,t){try{return e?JSON.parse(e):t}catch{return t}}function R(){try{const e=typeof crypto<"u"&&crypto.randomUUID?crypto.randomUUID():null;if(e)return e}catch{}return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,e=>{const t=Math.random()*16|0;return(e==="x"?t:t&3|8).toString(16)})}function u(e){if($)try{window.dispatchEvent(new CustomEvent(b,{detail:e}))}catch{}}$&&window.addEventListener("storage",e=>{e.key&&(e.key.startsWith(_)||e.key===g)&&u({key:e.key,type:"storage"})});function h(){return S(a.getItem(g),[])}function E(e){const t=new Set,o=[];for(const n of e){const r=`${n.followerId}=>${n.targetId}`;n.followerId!==n.targetId&&(t.has(r)||(t.add(r),o.push(n)))}try{a.setItem(g,JSON.stringify(o))}catch{}u({scope:"follows"})}function F(){try{const t=new URL(window.location.href),o=t.searchParams.get("api");if(o){localStorage.setItem("forum:api_base",o);try{t.searchParams.delete("api"),history.replaceState({},"",t.toString())}catch{}}const n=localStorage.getItem("forum:api_base");if(n)return n}catch{}return"https://notifications-worker.wizardiowhy.workers.dev/skyapi"}const v=F();function N(){try{return localStorage.getItem("forum:token")??sessionStorage.getItem("forum:token")}catch{return null}}async function d(e,t={}){const o=N(),n={"Content-Type":"application/json",...t.headers||{}};o&&(n.Authorization=`Bearer ${o}`);const r=await fetch(`${v}${e}`,{...t,headers:n}),c=await r.text();let s={};try{s=c?JSON.parse(c):{}}catch{s={error:c||r.statusText}}if(!r.ok)throw new Error((s==null?void 0:s.error)||`${r.status} ${r.statusText}`);return s}function l(){return!!v&&!!N()}function L(e){if(l())try{const t=window.__socialRemoteFollowersCache||(window.__socialRemoteFollowersCache=new Map),o=t.get(e);if(o)return o;d(`/social/followers/${encodeURIComponent(e)}`).then(n=>{try{t.set(e,Array.isArray(n.followers)?n.followers:[]),u({scope:"follows",targetId:e})}catch{}})}catch{}return h().filter(t=>t.targetId===e).map(t=>t.followerId)}function W(e){return h().filter(t=>t.followerId===e).map(t=>t.targetId)}function K(e,t){if(!e)return!1;if(l())try{const o=window.__socialRemoteFollowingCache||(window.__socialRemoteFollowingCache=new Map),n=o.get(e);if(n)return n.includes(t);d(`/social/following/${encodeURIComponent(e)}`).then(r=>{try{o.set(e,Array.isArray(r.following)?r.following:[]),u({scope:"follows",followerId:e})}catch{}})}catch{}return h().some(o=>o.followerId===e&&o.targetId===t)}function z(e,t){if(!e||!t||e===t)return;if(l())try{d("/social/follow",{method:"POST",body:JSON.stringify({targetId:t})})}catch{}const o=h();o.some(n=>n.followerId===e&&n.targetId===t)||(o.push({followerId:e,targetId:t,createdAt:p()}),E(o))}function X(e,t){if(l())try{d("/social/unfollow",{method:"POST",body:JSON.stringify({targetId:t})})}catch{}const o=h().filter(n=>!(n.followerId===e&&n.targetId===t));E(o)}function O(e){return`${_}${e}`}function x(e){return e.map(t=>({id:t.id??R(),targetId:t.targetId,authorId:t.authorId,authorName:t.authorName,content:typeof t.content=="string"?t.content:"",createdAt:t.createdAt??p(),parentId:t.parentId??null,updatedAt:t.updatedAt??null,edited:!!t.edited,deleted:!!t.deleted,deletedAt:t.deletedAt??null,deletedById:t.deletedById??null}))}function y(e){if(l())try{const n=window.__socialRemoteCommentsCache||(window.__socialRemoteCommentsCache=new Map),r=n.get(e);if(r)return r;d(`/profiles/${encodeURIComponent(e)}/comments`).then(c=>{try{const s=x(Array.isArray(c.comments)?c.comments:[]);n.set(e,s),u({scope:"comments",targetId:e})}catch{}})}catch{}const t=a.getItem(O(e)),o=S(t,[]);return x(o)}function I(e,t){try{a.setItem(O(e),JSON.stringify(t))}catch{}u({scope:"comments",targetId:e})}const T=1e4;function D(e,t){const o=`${m}last_post:${e}:${t}`,n=Number(a.getItem(o)||"0"),r=Date.now()-n>=T;if(r)try{a.setItem(o,String(Date.now()))}catch{}return r}const A=2e3;function Y(e,t){const o=y(e),r=!1?o:o.filter(i=>!i.deleted);r.sort((i,f)=>i.createdAt<f.createdAt?1:-1);const c=Math.max(0,0);return r.slice(c,void 0)}function J(e,t,o,n){const r=(o??"").trim();if(!r)throw new Error("Comment is empty");if(r.length>A)throw new Error(`Comment too long (${r.length} > ${A})`);if(!l()&&!D(e,t))throw new Error("You are posting too fast. Please wait a bit.");if(l())try{d(`/profiles/${encodeURIComponent(e)}/comments`,{method:"POST",body:JSON.stringify({content:r,parentId:(n==null?void 0:n.parentId)||null})}).then(i=>{try{const f=window.__socialRemoteCommentsCache;if(f){const U=f.get(e)||[],P=x(Array.isArray(i.comment)?i.comment:[i.comment]);f.set(e,[...P,...U]),u({scope:"comments",targetId:e})}}catch{}}).catch(()=>{})}catch{}if(n!=null&&n.parentId&&!y(e).find(f=>f.id===n.parentId))throw new Error("Parent comment not found");const c={id:R(),targetId:e,authorId:t,authorName:n==null?void 0:n.authorName,content:r,createdAt:p(),parentId:(n==null?void 0:n.parentId)??null,updatedAt:null,edited:!1,deleted:!1,deletedAt:null,deletedById:null},s=y(e);return s.unshift(c),I(e,s),c}function j(e,t,o,n,r){return J(e,t,n,{authorName:r,parentId:o})}function G(e,t,o){if(l())try{d(`/profiles/${encodeURIComponent(e)}/comments/${encodeURIComponent(t)}`,{method:"DELETE"})}catch{}const n=y(e),r=n.findIndex(s=>s.id===t);if(r<0)return;const c=n[r];(c.authorId===o||e===o)&&(c.deleted||(n[r]={...c,content:"",deleted:!0,deletedAt:p(),deletedById:o},I(e,n)))}function k(e){return`${m}comment_reactions:${e}`}function C(e){return S(a.getItem(k(e)),{})}function B(e,t){try{a.setItem(k(e),JSON.stringify(t))}catch{}u({scope:"reactions",targetId:e})}function H(e){return C(e)}function Q(e,t,o){var n,r;return(r=(n=C(e)[t])==null?void 0:n.byUser)==null?void 0:r[o]}function V(e,t,o,n){const r=C(e),c=r[t]||{counts:{like:0,smile:0,useful:0},byUser:{}},s=c.byUser[o];return s===n?(c.byUser[o]=void 0,c.counts[n]=Math.max(0,(c.counts[n]||0)-1)):(s&&(c.counts[s]=Math.max(0,(c.counts[s]||0)-1)),c.byUser[o]=n,c.counts[n]=(c.counts[n]||0)+1),r[t]=c,B(e,r),c}export{L as a,Y as b,J as c,j as d,H as e,z as f,Q as g,K as i,W as l,G as r,V as t,X as u};
