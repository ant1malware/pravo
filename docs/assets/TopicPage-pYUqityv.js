import{j as s}from"./index-CKim-AMV.js";import{u as F,R as c,L as x}from"./react-vendor-DTkXckhQ.js";import{g as G}from"./authRemote-D08Z_Jso.js";import{getTopic as X,listPosts as C,listTopics as H,listSections as J,updatePost as I,toggleLikePost as W,createPost as Z,deletePost as _}from"./forumRemote-D5s3MT8n.js";import{M as T}from"./MarkdownEditor-sNELiDyg.js";import{R as ee}from"./ReactionBar-CHBxvH4O.js";import{s as P,a as A}from"./seo-Dt7ixYh-.js";import"./purify.es-DnfDK_hS.js";import{ab as te,Q as se,ae as ne,X as ie}from"./icons-GyIOUIPt.js";function xe(){const{id:u=""}=F(),[l,R]=c.useState(null),[t,$]=c.useState(null),[h,m]=c.useState([]),[v,z]=c.useState([]),[b,D]=c.useState(""),[j,w]=c.useState(""),[M,y]=c.useState(null),[B,p]=c.useState(""),[N,K]=c.useState([]),[S,q]=c.useState(null),g=!!l&&(l.role==="developer"||l.role==="admin"||l.role==="moderator");c.useEffect(()=>{(async()=>{try{R(await G())}catch{}try{const e=await X(u);if(e){$(e);try{P(`${e.title} � ����`,e.title)}catch{}}const n=await C(u);m(Array.isArray(n)?n:[])}catch{}try{const e=await H();z(Array.isArray(e)?e:[])}catch{}})()},[u]);async function U(){const e=j.trim();if(!(!e||!l||!t||t.locked))try{const n=await Z({topicId:t.id,content:e});m(i=>[...i,n]),w("")}catch{}}async function Q(e){if(g)try{const n=await I(e.id,{pinned:!e.pinned});m(i=>i.map(a=>a.id===e.id?n:a))}catch{}}async function V(e){try{await _(e.id),m(n=>n.filter(i=>i.id!==e.id))}catch{}}c.useEffect(()=>{if(t)try{const e={"@context":"https://schema.org","@type":"DiscussionForumPosting",headline:t.title,datePublished:t.createdAt,dateModified:t.updatedAt};P(void 0,t.title,e)}catch{}},[t==null?void 0:t.id]),c.useEffect(()=>{(async()=>{try{if(t!=null&&t.id){const e=`${window.location.origin}/forum/topic/${t.id}`;A({title:t.title,description:t.title,url:e,canonical:e})}}catch{}try{if(t!=null&&t.sectionId){const n=(await J()||[]).find(i=>i.id===t.sectionId);n&&D(n.title||"")}}catch{}})();try{if(t!=null&&t.title){const e=document.createElement("canvas");e.width=1200,e.height=630;const n=e.getContext("2d");if(n){const i=n.createLinearGradient(0,0,1200,630);i.addColorStop(0,"#8b5cf6"),i.addColorStop(1,"#22d3ee"),n.fillStyle=i,n.fillRect(0,0,1200,630),n.fillStyle="rgba(0,0,0,0.35)",n.fillRect(24,24,1152,582),n.fillStyle="#fff",n.font="bold 56px Inter, system-ui, sans-serif",n.textBaseline="top";const a=t.title.slice(0,90),r=[];let o="";for(const f of a.split(" ")){const E=(o?o+" ":"")+f;n.measureText(E).width>1080?(r.push(o),o=f):o=E}o&&r.push(o);let d=120;for(const f of r)n.fillText(f,60,d),d+=70;n.font="bold 24px Inter, system-ui, sans-serif",n.fillStyle="rgba(255,255,255,0.85)",n.fillText(b||"SKY",60,60);const Y=e.toDataURL("image/png"),L=`${window.location.origin}/forum/topic/${t.id}`;A({title:t.title,description:t.title,url:L,image:Y,canonical:L})}}}catch{}},[t==null?void 0:t.id,t==null?void 0:t.sectionId,t==null?void 0:t.title]),c.useEffect(()=>{var r;const n=(((r=h[0])==null?void 0:r.content)||"").split(/\r?\n/),i=[],a=o=>o.toLowerCase().replace(/[^\p{L}\p{N}\s-]/gu,"").trim().replace(/\s+/g,"-").slice(0,80);for(const o of n){const d=/^(#{2,3})\s+(.+)$/.exec(o.trim());d&&i.push({id:a(d[2]),text:d[2],level:d[1].length})}K(i)},[h.length]),c.useEffect(()=>{const e=`topic:scroll:${u}`;try{const i=Number(localStorage.getItem(e)||"");i&&window.scrollTo(0,i)}catch{}const n=()=>{try{localStorage.setItem(e,String(window.scrollY||0))}catch{}};return window.addEventListener("beforeunload",n),c.useEffect(()=>{function i(a){if(a.key.toLowerCase()==="r"){const r=document.querySelector("#reply-editor textarea");r&&(a.preventDefault(),r.focus())}}return window.addEventListener("keydown",i),()=>window.removeEventListener("keydown",i)},[]),()=>{n(),window.removeEventListener("beforeunload",n)}},[u]);function O(e,n){const i=new Set(String(e.title||"").toLowerCase().split(/[^\p{L}\p{N}]+/u).filter(Boolean)),a=new Set(String(n.title||"").toLowerCase().split(/[^\p{L}\p{N}]+/u).filter(Boolean));if(!i.size||!a.size)return 0;let r=0;for(const d of a)i.has(d)&&r++;const o=i.size+a.size-r;return o?r/o:0}const k=c.useMemo(()=>t?(c.useEffect(()=>{function e(n){if(n.key.toLowerCase()==="r"){const i=document.querySelector("#reply-editor textarea");i&&(n.preventDefault(),i.focus())}}return window.addEventListener("keydown",e),()=>window.removeEventListener("keydown",e)},[]),(v||[]).filter(e=>e.id!==t.id&&e.sectionId===t.sectionId).map(e=>({t:e,s:O(t,e)})).filter(e=>e.s>0).sort((e,n)=>n.s-e.s).slice(0,5).map(e=>e.t)):[],[v,t==null?void 0:t.id,t==null?void 0:t.sectionId,t==null?void 0:t.title]);return c.useEffect(()=>{function e(n){if(n.key.toLowerCase()==="r"){const i=document.querySelector("#reply-editor textarea");i&&(n.preventDefault(),i.focus())}}return window.addEventListener("keydown",e),()=>window.removeEventListener("keydown",e)},[]),s.jsxs("main",{className:"min-h-screen",style:{background:"#0d0d12",color:"#f8fafc"},children:[s.jsxs("div",{className:"mx-auto max-w-5xl px-4 py-6",children:[s.jsxs("nav",{className:"mb-2 text-sm opacity-80 truncate",children:[s.jsx(x,{to:"/forum",className:"hover:underline",children:"�����"}),s.jsx("span",{className:"mx-2",children:"/"}),t!=null&&t.sectionId?s.jsx(x,{to:`/forum/section/${t.sectionId}`,className:"hover:underline",children:b||"������"}):s.jsx("span",{children:"������"}),s.jsx("span",{className:"mx-2",children:"/"}),s.jsx("span",{className:"font-semibold",children:(t==null?void 0:t.title)||"..."})]}),s.jsxs("div",{className:"mb-4 flex items-center gap-3",children:[s.jsxs(x,{to:"/forum",className:"btn flex items-center gap-2",children:[s.jsx(te,{size:16})," Back"]}),s.jsx("div",{className:"text-sm opacity-70",children:"Topic"}),s.jsx("div",{className:"font-semibold truncate",children:(t==null?void 0:t.title)||"..."}),s.jsxs("div",{className:"ml-auto text-xs opacity-70",children:["Replies ",(t==null?void 0:t.replyCount)??0," � Views ",(t==null?void 0:t.viewCount)??0]})]}),s.jsx("div",{className:"card p-4",children:s.jsxs("div",{className:"grid gap-3",children:[h.slice().sort((e,n)=>(n.pinned?1:0)-(e.pinned?1:0)||new Date(e.createdAt).getTime()-new Date(n.createdAt).getTime()).map(e=>{const n=!!l&&l.id===e.authorId,i=M===e.id;return c.useEffect(()=>{function a(r){if(r.key.toLowerCase()==="r"){const o=document.querySelector("#reply-editor textarea");o&&(r.preventDefault(),o.focus())}}return window.addEventListener("keydown",a),()=>window.removeEventListener("keydown",a)},[]),s.jsxs("div",{className:"rounded-xl border border-white/10 bg-white/[0.04] p-3 text-sm",children:[e.pinned&&s.jsx("span",{className:"mr-2 inline-block rounded bg-white/10 px-2 py-0.5 text-xs",children:"Pinned"}),i?s.jsx(T,{value:B,onChange:p,onSubmit:async a=>{p(a),m(r=>r.map(o=>o.id===e.id?{...o,content:a,editedAt:new Date().toISOString()}:o)),y(null);try{await I(e.id,{content:a})}catch{}},submitLabel:"Save"}):s.jsx("div",{className:"prose prose-invert max-w-none whitespace-pre-wrap",children:e.content}),!i&&s.jsxs("div",{className:"mt-2 flex items-center gap-2",children:[s.jsxs("button",{className:"btn text-xs",title:"����������",onClick:()=>w(a=>a+`

> ${e.content}

`),children:[s.jsx(se,{size:14})," Quote"]}),s.jsxs("button",{className:"btn text-xs",onClick:async()=>{try{const a=await W(e.id);m(r=>r.map(o=>o.id===e.id?a:o))}catch{}},children:["?? ",(e.likes||[]).length]}),n&&s.jsxs("button",{className:"btn text-xs",onClick:()=>{y(e.id),p(e.content)},title:"Edit",children:[s.jsx(ne,{size:14})," Edit"]})]}),i&&s.jsx("div",{className:"mt-2 flex items-center justify-end",children:s.jsxs("button",{className:"btn",onClick:()=>y(null),children:[s.jsx(ie,{size:14})," Cancel"]})}),s.jsx(ee,{postId:e.id,currentUserId:l==null?void 0:l.id,onPostUpdated:async()=>{try{const a=await C(u);m(Array.isArray(a)?a:[])}catch{}}}),(g||(l==null?void 0:l.id)===e.authorId)&&s.jsxs("div",{className:"mt-2 text-right",children:[g&&s.jsx("button",{className:"btn text-xs",onClick:()=>Q(e),style:{marginRight:8},children:e.pinned?"Unpin":"Pin"}),s.jsx("button",{className:"btn text-xs",onClick:()=>V(e),children:"Delete"})]})]},e.id)}),!(t!=null&&t.locked)&&l&&s.jsx(T,{value:j,onChange:w,onSubmit:()=>U(),placeholder:"Reply in Markdown...",submitLabel:"Send",draftKey:t?`forum:draft:${t.id}`:void 0}),(t==null?void 0:t.locked)&&s.jsx("div",{className:"text-xs opacity-70",children:"Topic is locked."})]})}),N.length>0&&s.jsxs("div",{className:"card mt-4 p-4",children:[s.jsx("div",{className:"mb-2 text-xs uppercase tracking-[0.28em] text-zinc-400/80",children:"����������"}),s.jsx("ul",{className:"text-sm leading-relaxed",children:N.map(e=>s.jsx("li",{className:e.level===3?"ml-3":"",children:s.jsx("a",{href:`#${e.id}`,className:"hover:underline",children:e.text})},e.id))})]}),k.length>0&&s.jsxs("div",{className:"card mt-4 p-4",children:[s.jsx("div",{className:"mb-2 text-xs uppercase tracking-[0.28em] text-zinc-400/80",children:"������� ����"}),s.jsx("div",{className:"grid gap-2",children:k.map(e=>s.jsxs(x,{to:`/forum/topic/${e.id}`,className:"flex items-center justify-between rounded-lg border border-white/10 bg-white/[0.03] px-3 py-2 hover:bg-white/[0.06]",children:[s.jsx("div",{className:"min-w-0 truncate font-medium",children:e.title}),s.jsxs("div",{className:"ml-2 shrink-0 text-xs opacity-70",children:["������� ",e.replyCount]})]},e.id))})]}),S&&s.jsx("div",{className:"fixed inset-0 z-[100] grid place-items-center bg-black/80 p-4",onClick:()=>q(null),children:s.jsx("img",{src:S,alt:"preview",className:"max-h-[90vh] max-w-[90vw] rounded-lg shadow-lg"})}),"      "]}),"\\n    "]})}export{xe as default};
