import{b as ne,m as ie,j as n}from"./index-C5TXn_k8.js";import{u as re,R as c,L as j}from"./react-vendor-DTkXckhQ.js";import{d as ae,p as ce}from"./purify.es-DnfDK_hS.js";import{getTopic as le,listPosts as _,listTopics as oe,listSections as de,createPost as ue,updatePost as F,toggleLikePost as me,deletePost as fe}from"./forumRemote-D5s3MT8n.js";import{M as H}from"./MarkdownEditor-XXBrWTSU.js";import{R as xe}from"./ReactionBar-swKW2WJe.js";import{s as U,a as V}from"./seo-Dt7ixYh-.js";import{m as he}from"./readTracker-D5ICW4Ou.js";import{F as ge}from"./FavStar-CxMKreD1.js";import{a3 as pe,Q as ye,a6 as we,a7 as je,X as be}from"./icons-CDjAZjRL.js";const ve=90;function Ne(d){try{const o=ae.parse(d||"");return ce.sanitize(o)}catch{return d}}function q(d){return d.toLowerCase().replace(/[^\p{L}\p{N}\s-]/gu,"").trim().replace(/\s+/g,"-").slice(0,80)}function Se(d){return d==="developer"||d==="admin"||d==="moderator"}function ze(){const{id:d=""}=re(),[o,T]=c.useState(null),[s,p]=c.useState(null),[g,h]=c.useState([]),[I,b]=c.useState([]),[v,N]=c.useState(""),[M,S]=c.useState(""),[k,C]=c.useState(null),[K,L]=c.useState(""),[$,Q]=c.useState([]),[G,z]=c.useState(!0),[R,D]=c.useState(null),[O,X]=c.useState({}),E=c.useMemo(()=>Se(o==null?void 0:o.role),[o==null?void 0:o.role]),A=c.useRef(null);c.useEffect(()=>{let t=!0;return(async()=>{try{const e=await ne();t&&T(e)}catch{t&&T(null)}try{const e=await ie();if(!t)return;const i={};for(const r of e)i[r.id]={username:r.username};X(i)}catch{}})(),()=>{t=!1}},[]),c.useEffect(()=>{let t=!0;return z(!0),p(null),h([]),b([]),(async()=>{try{const[e,i,r]=await Promise.all([le(d),_(d),oe().catch(()=>[])]);if(!t)return;p(e),h(Array.isArray(i)?i:[]),b(Array.isArray(r)?r:[]);try{e&&(o!=null&&o.id)&&he(o.id,e.id,e.lastPostAt||e.updatedAt)}catch{}if(!e){const a=(Array.isArray(r)?r:[]).find(l=>l.id===d)||null;a&&p(a)}if(e)try{U(`${e.title} вЂ” РўРµРјР°`,e.title);const a={"@context":"https://schema.org","@type":"DiscussionForumPosting",headline:e.title,datePublished:e.createdAt,dateModified:e.updatedAt};U(void 0,e.title,a)}catch{}}catch{if(!t)return;p(null),h([]),b([])}finally{t&&z(!1)}})(),()=>{t=!1}},[d]),c.useEffect(()=>{let t=!0;return(async()=>{if(!(s!=null&&s.sectionId)){t&&N("");return}try{const e=await de();if(!t)return;const i=e.find(r=>r.id===s.sectionId);N((i==null?void 0:i.title)||"")}catch{t&&N("")}})(),()=>{t=!1}},[s==null?void 0:s.sectionId]),c.useEffect(()=>{if(s!=null&&s.id)try{const t=`${window.location.origin}/forum/topic/${s.id}`;V({title:s.title,description:s.title,url:t,canonical:t})}catch{}},[s==null?void 0:s.id,s==null?void 0:s.title]),c.useEffect(()=>{if(!(!(s!=null&&s.title)||!(s!=null&&s.id)))try{const t=document.createElement("canvas");t.width=1200,t.height=630;const e=t.getContext("2d");if(!e)return;const i=e.createLinearGradient(0,0,1200,630);i.addColorStop(0,"#8b5cf6"),i.addColorStop(1,"#22d3ee"),e.fillStyle=i,e.fillRect(0,0,1200,630),e.fillStyle="rgba(0,0,0,0.35)",e.fillRect(24,24,1152,582),e.fillStyle="#fff",e.font="bold 56px Inter, system-ui, sans-serif",e.textBaseline="top";const r=s.title.slice(0,ve).split(" "),a=[];let l="";for(const f of r){const u=l?`${l} ${f}`:f;e.measureText(u).width>1080?(l&&a.push(l),l=f):l=u}l&&a.push(l);let m=120;for(const f of a)e.fillText(f,60,m),m+=70;e.font="bold 24px Inter, system-ui, sans-serif",e.fillStyle="rgba(255,255,255,0.85)",e.fillText(v||"SKY",60,60);const y=t.toDataURL("image/png"),x=`${window.location.origin}/forum/topic/${s.id}`;V({title:s.title,description:s.title,url:x,image:y,canonical:x})}catch{}},[v,s==null?void 0:s.id,s==null?void 0:s.title]),c.useEffect(()=>{var a;const e=(((a=g[0])==null?void 0:a.content)||"").split(/\r?\n/),i=[],r=new Map;for(const l of e){const m=/^(#{2,3})\s+(.+)$/.exec(l.trim());if(!m)continue;const y=m[1].length,x=q(m[2]),f=r.get(x)??0,u=f?`${x}-${f+1}`:x;r.set(x,f+1),i.push({id:u,text:m[2],level:y})}Q(i)},[g]),c.useEffect(()=>{const t=`topic:scroll:${d}`;try{const i=Number(localStorage.getItem(t)||"");Number.isFinite(i)&&i>0&&window.scrollTo(0,i)}catch{}const e=()=>{try{localStorage.setItem(t,String(window.scrollY??0))}catch{}};return window.addEventListener("beforeunload",e),()=>window.removeEventListener("beforeunload",e)},[d]),c.useEffect(()=>{function t(e){if(e.key.toLowerCase()==="r"){const i=document.querySelector("#reply-editor textarea");i&&(e.preventDefault(),i.focus())}}return window.addEventListener("keydown",t),()=>window.removeEventListener("keydown",t)},[]),c.useEffect(()=>{const t=A.current;if(!t)return;const e=Array.from(t.querySelectorAll("h2, h3")),i=new Map;e.forEach(r=>{const a=q(r.textContent||"");if(!a)return;const l=i.get(a)??0,m=l?`${a}-${l+1}`:a;i.set(a,l+1),r.id=m})},[g,k]),c.useEffect(()=>{const t=A.current;if(!t)return;const e=Array.from(t.querySelectorAll("img")),i=r=>{r.preventDefault();const a=r.currentTarget;a!=null&&a.src&&D(a.src)};return e.forEach(r=>r.addEventListener("click",i)),()=>e.forEach(r=>r.removeEventListener("click",i))},[g,k]);const Y=c.useMemo(()=>g.slice().sort((t,e)=>(e.pinned?1:0)-(t.pinned?1:0)||new Date(t.createdAt).getTime()-new Date(e.createdAt).getTime()),[g]),B=c.useMemo(()=>{if(!s)return[];const t=new Set(String(s.title||"").toLowerCase().split(/[^\p{L}\p{N}]+/u).filter(Boolean));return t.size?I.filter(e=>e.id!==s.id&&e.sectionId===s.sectionId).map(e=>{const i=new Set(String(e.title||"").toLowerCase().split(/[^\p{L}\p{N}]+/u).filter(Boolean));if(!i.size)return{candidate:e,score:0};let r=0;for(const l of i)t.has(l)&&(r+=1);const a=t.size+i.size-r;return{candidate:e,score:a?r/a:0}}).filter(e=>e.score>0).sort((e,i)=>i.score-e.score).slice(0,5).map(e=>e.candidate):[]},[I,s==null?void 0:s.id,s==null?void 0:s.sectionId,s==null?void 0:s.title]),J=c.useMemo(()=>Math.max(g.length,(s==null?void 0:s.replyCount)??0),[g.length,s==null?void 0:s.replyCount]);async function W(){const t=M.trim();if(!(!t||!o||!s||s.locked))try{const e=await ue({topicId:s.id,content:t});h(i=>[...i,e]),S(""),p(i=>i&&{...i,replyCount:i.replyCount+1,lastPostAt:e.createdAt,lastPostBy:e.authorId})}catch(e){alert((e==null?void 0:e.message)||"РќРµ СѓРґР°Р»РѕСЃСЊ РѕС‚РїСЂР°РІРёС‚СЊ РѕС‚РІРµС‚")}}async function Z(t){if(E)try{const e=await F(t.id,{pinned:!t.pinned});h(i=>i.map(r=>r.id===t.id?e:r))}catch(e){alert((e==null?void 0:e.message)||"РќРµ СѓРґР°Р»РѕСЃСЊ РѕР±РЅРѕРІРёС‚СЊ СЃС‚Р°С‚СѓСЃ СЃРѕРѕР±С‰РµРЅРёСЏ")}}async function ee(t){try{await fe(t.id),h(e=>e.filter(i=>i.id!==t.id)),p(e=>e&&{...e,replyCount:Math.max(0,e.replyCount-1)})}catch(e){alert((e==null?void 0:e.message)||"РќРµ СѓРґР°Р»РѕСЃСЊ СѓРґР°Р»РёС‚СЊ СЃРѕРѕР±С‰РµРЅРёРµ")}}async function te(t){try{const e=await me(t.id);h(i=>i.map(r=>r.id===t.id?e:r))}catch(e){alert((e==null?void 0:e.message)||"РќРµ СѓРґР°Р»РѕСЃСЊ РѕР±РЅРѕРІРёС‚СЊ СЂРµР°РєС†РёСЋ")}}const se=(t,e)=>{var y,x,f;const i=!!o&&o.id===t.authorId,r=k===t.id,a=Ne(t.content),l=e===0?A:void 0,m=((y=O[t.authorId])==null?void 0:y.username)||"user";return n.jsxs("div",{ref:l,className:"rounded-xl border border-white/10 bg-white/[0.04] p-3 text-sm",children:[n.jsx("div",{className:"mb-2 text-xs text-zinc-400/80",children:n.jsx(j,{className:"font-semibold hover:underline",to:`/forum/profile/${m}`,children:m})}),t.pinned&&n.jsx("span",{className:"mr-2 inline-block rounded bg-white/10 px-2 py-0.5 text-xs uppercase tracking-wide",children:"Pinned"}),r?n.jsx(H,{value:K,onChange:L,onSubmit:async u=>{L(u),h(w=>w.map(P=>P.id===t.id?{...P,content:u,editedAt:new Date().toISOString()}:P)),C(null);try{await F(t.id,{content:u})}catch(w){alert((w==null?void 0:w.message)||"РќРµ СѓРґР°Р»РѕСЃСЊ СЃРѕС…СЂР°РЅРёС‚СЊ РїСЂР°РІРєСѓ")}},submitLabel:"Save"}):n.jsx("div",{className:"prose prose-invert max-w-none",dangerouslySetInnerHTML:{__html:a}}),n.jsxs("div",{className:"mt-2 flex flex-wrap items-center gap-2",children:[n.jsxs("button",{className:"btn text-xs",title:"Р¦РёС‚РёСЂРѕРІР°С‚СЊ",onClick:()=>S(u=>`${u}

> ${t.content}

`),children:[n.jsx(ye,{size:14})," Quote"]}),n.jsxs("button",{className:"btn text-xs",onClick:()=>te(t),children:[n.jsx(we,{size:14,className:(x=t.likes)!=null&&x.length?"text-rose-300":void 0})," ",((f=t.likes)==null?void 0:f.length)??0]}),i&&!r&&n.jsxs("button",{className:"btn text-xs",onClick:()=>{C(t.id),L(t.content)},title:"Р РµРґР°РєС‚РёСЂРѕРІР°С‚СЊ СЃРѕРѕР±С‰РµРЅРёРµ",children:[n.jsx(je,{size:14})," Edit"]}),r&&n.jsxs("button",{className:"btn text-xs",onClick:()=>C(null),children:[n.jsx(be,{size:14})," Cancel"]})]}),n.jsx(xe,{postId:t.id,currentUserId:o==null?void 0:o.id,onPostUpdated:async()=>{try{const u=await _(d);h(Array.isArray(u)?u:[])}catch{}}}),(E||i)&&n.jsxs("div",{className:"mt-2 flex flex-wrap items-center justify-end gap-2",children:[E&&n.jsx("button",{className:"btn text-xs",onClick:()=>Z(t),children:t.pinned?"Unpin":"Pin"}),n.jsx("button",{className:"btn text-xs",onClick:()=>ee(t),children:"Delete"})]})]},t.id)};return!G&&!s?n.jsx("main",{className:"min-h-screen",style:{background:"#0d0d12",color:"#f8fafc"},children:n.jsx("div",{className:"mx-auto max-w-4xl px-4 py-24 text-center text-sm text-zinc-300",children:"РўРµРјР° РЅРµ РЅР°Р№РґРµРЅР° РёР»Рё Р±С‹Р»Р° СѓРґР°Р»РµРЅР°."})}):n.jsxs("main",{className:"min-h-screen",style:{background:"#0d0d12",color:"#f8fafc"},children:[n.jsxs("div",{className:"mx-auto max-w-5xl px-4 py-6",children:[n.jsxs("nav",{className:"mb-2 flex flex-wrap items-center gap-2 text-sm text-zinc-300/80",children:[n.jsx(j,{to:"/forum",className:"hover:underline",children:"Р¤РѕСЂСѓРј"}),n.jsx("span",{children:"/"}),s!=null&&s.sectionId?n.jsx(j,{to:`/forum/section/${s.sectionId}`,className:"hover:underline",children:v||"Р Р°Р·РґРµР»"}):n.jsx("span",{children:"Р Р°Р·РґРµР»"}),n.jsx("span",{children:"/"}),n.jsx("span",{className:"font-semibold text-zinc-100",children:(s==null?void 0:s.title)||"..."})]}),n.jsxs("div",{className:"mb-4 flex flex-wrap items-center gap-3",children:[n.jsxs(j,{to:"/forum",className:"btn flex items-center gap-2",children:[n.jsx(pe,{size:16})," Back"]}),n.jsx("div",{className:"text-sm opacity-70",children:"Topic"}),n.jsx("div",{className:"min-w-0 flex-1 truncate font-semibold",children:(s==null?void 0:s.title)||"..."}),s&&n.jsxs("div",{className:"flex items-center gap-3 text-xs opacity-70",children:[n.jsxs("span",{children:["Replies ",J]}),n.jsxs("span",{children:["Views ",s.viewCount??0]}),n.jsx(ge,{kind:"topic",id:s.id,title:s.title,url:`/forum/topic/${s.id}`,size:"sm"})]})]}),n.jsx("div",{className:"card p-4",children:n.jsxs("div",{className:"grid gap-3",children:[Y.map((t,e)=>se(t,e)),!(s!=null&&s.locked)&&o&&n.jsx("div",{id:"reply-editor",children:n.jsx(H,{value:M,onChange:S,onSubmit:()=>W(),placeholder:"Reply in Markdown...",submitLabel:"Send",draftKey:s?`forum:draft:${s.id}`:void 0})}),(s==null?void 0:s.locked)&&n.jsx("div",{className:"text-xs opacity-70",children:"Topic is locked."})]})}),$.length>0&&n.jsxs("div",{className:"card mt-4 p-4",children:[n.jsx("div",{className:"mb-2 text-xs uppercase tracking-[0.28em] text-zinc-400/80",children:"РћРіР»Р°РІР»РµРЅРёРµ"}),n.jsx("ul",{className:"text-sm leading-relaxed",children:$.map(t=>n.jsx("li",{className:t.level===3?"ml-3":void 0,children:n.jsx("a",{href:`#${t.id}`,className:"hover:underline",children:t.text})},t.id))})]}),B.length>0&&n.jsxs("div",{className:"card mt-4 Рї-4",children:[n.jsx("div",{className:"mb-2 text-xs uppercase tracking-[0.28em] text-Р·inc-400/80",children:"РџРѕС…РѕР¶РёРµ С‚РµРјС‹"}),n.jsx("div",{className:"grid gap-2",children:B.map(t=>n.jsxs(j,{to:`/forum/topic/${t.id}`,className:"flex items-center justify-between rounded-lg border border-white/10 bg-white/[0.03] px-3 py-2 hover:bg-white/[0.06]",children:[n.jsx("div",{className:"min-w-0 truncate font-medium",children:t.title}),n.jsxs("div",{className:"ml-2 shrink-0 text-xs opacity-70",children:["РћС‚РІРµС‚РѕРІ ",t.replyCount]})]},t.id))})]})]}),R&&n.jsx("div",{className:"fixed inset-0 z-[100] grid place-items-center bg-black/80 p-4",onClick:()=>D(null),role:"presentation",children:n.jsx("img",{src:R,alt:"preview",className:"max-h-[90vh] max-w-[90vw] rounded-lg shadow-lg"})})]})}export{ze as default};
